name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Ğ›Ğ¸Ğ½Ñ‚ĞµÑ€ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° ĞºĞ¾Ğ´Ğ°
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dev dependencies
      run: pip install flake8 black

    - name: Run flake8 (capture output)
      run: |
        set -o pipefail
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ´, ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ² flake8.log
        flake8 . \
          --exclude=venv,__pycache__,.git,.github,backups,scripts \
          --max-line-length=120 \
          --ignore=E501,W291,W292,W293,E302,E303,W503,E741 \
          --count \
          --show-source \
          --statistics 2>&1 | tee flake8.log || true

    - name: Run black (check, capture)
      run: |
        black --check . 2>&1 | tee black_check.log || true

    - name: Upload lint logs
      uses: actions/upload-artifact@v4
      with:
        name: lint-logs
        path: |
          flake8.log
          black_check.log

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Ğ¢ĞµÑÑ‚Ñ‹ â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ´ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run pytest (capture output & junit)
      run: |
        set -o pipefail
        python -m pytest tests/ -v --tb=short --junitxml=test-report.xml 2>&1 | tee pytest.log || true

    - name: Upload test report and logs
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: |
          test-report.xml
          pytest.log

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3A: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº VPS (Ğ¿Ñ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy_check:
    runs-on: ubuntu-latest
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ÑĞµĞºÑ€ĞµÑ‚Ñ‹ Ğ·Ğ°Ğ´Ğ°Ğ½Ñ‹
    if: ${{ secrets.VPS_HOST != '' && secrets.VPS_USER != '' && secrets.VPS_SSH_KEY != '' }}
    needs: [lint, test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Write SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ./vps_key
        chmod 600 ./vps_key

    - name: Try SSH connection (simple check)
      run: |
        set -o pipefail
        echo "Testing SSH connection to ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}..." > connection.log
        ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ./vps_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo SSH_OK" >> connection.log 2>&1 || true
        echo "---- connection log start ----" && tail -n 200 connection.log || true
        if ! grep -q "SSH_OK" connection.log; then
          echo "SSH connection failed; saving log and failing the job."
          echo "*** BEGIN CONNECTION LOG ***" > failure.log
          tail -n 200 connection.log >> failure.log
          cat failure.log
          exit 1
        fi

    - name: Upload connection log
      uses: actions/upload-artifact@v4
      with:
        name: vps-connection-log
        path: connection.log

    - name: Send Telegram notification (success)
      if: success()
      run: |
        RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        MESSAGE="âœ… VPS reachable: ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}\nRun: ${RUN_URL}\nĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.event.head_commit.message }}"
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"${MESSAGE}\", \"parse_mode\": \"HTML\"}"

    - name: Send Telegram notification (failure)
      if: failure()
      run: |
        RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        LOG_SNIPPET="$(head -n 30 connection.log | sed 's/"/\\"/g')"
        MESSAGE="âŒ VPS unreachable: ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}\nRun: ${RUN_URL}\nĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.event.head_commit.message }}\n\nĞ›Ğ¾Ğ³:\n${LOG_SNIPPET}"
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"${MESSAGE}\", \"parse_mode\": \"HTML\"}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3B: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ â€” Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    # ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹, ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ñ‹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº VPS
    if: ${{ secrets.VPS_HOST != '' && secrets.VPS_USER != '' && secrets.VPS_SSH_KEY != '' }}
    runs-on: ubuntu-latest
    # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¸Ğ´Ñ‘Ñ‚ Ğ¢ĞĞ›Ğ¬ĞšĞ ĞµÑĞ»Ğ¸ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ job'Ñ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°
    needs: [lint, test, deploy_check]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /root/projects/error_bot

          # Backup Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          BACKUP_DIR="/root/projects/error_bot/backups/auto_$(date +%Y%m%d_%H%M%S)"
          echo "Creating backup: $BACKUP_DIR"
          mkdir -p "$BACKUP_DIR"
          cp -r config handlers keyboards services utils main.py requirements.txt "$BACKUP_DIR/" 2>/dev/null || true

          # Pull Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
          echo "Pulling latest changes from GitHub..."
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master

          # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
          echo "Updating dependencies..."
          /root/projects/error_bot/venv/bin/pip install -r requirements.txt --upgrade

          # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
          echo "Restarting bot service..."
          systemctl restart error_bot

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°
          sleep 3
          if systemctl is-active --quiet error_bot; then
            echo "âœ… Bot successfully deployed and running!"
            systemctl status error_bot --no-pager
          else
            echo "âŒ Bot failed to start! Rolling back..."
            if [ -d "$BACKUP_DIR" ]; then
              cp -r "$BACKUP_DIR"/* /root/projects/error_bot/
              systemctl restart error_bot
              echo "Rollback completed"
            fi
            exit 1
          fi

          # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‹Ñ… backup'Ğ¾Ğ² (Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5)
          echo "Cleaning old backups..."
          cd /root/projects/error_bot/backups
          ls -t | grep "^auto_" | tail -n +6 | xargs -r rm -rf

          echo "Deployment completed successfully!"
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4A: Start notification â€” ÑĞ¾Ğ¾Ğ±Ñ‰Ğ°ĞµÑ‚, Ñ‡Ñ‚Ğ¾ pipeline Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify_start:
    runs-on: ubuntu-latest

    steps:
    - name: Send Telegram notification (start)
      run: |
        RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        MESSAGE="ğŸš€ KasperBot pipeline started\n\nĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.event.head_commit.message }}\nĞ’ĞµÑ‚Ğ²ÑŒ: ${{ github.ref_name }}\nĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}\nRun: ${RUN_URL}"

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"${MESSAGE}\", \"parse_mode\": \"HTML\"}"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4B: Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ â€” Ğ²ÑĞµĞ³Ğ´Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ¸ Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° run Ğ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ñ‚ĞµÑÑ‚-Ñ€ĞµĞ¿Ğ¾Ñ€Ñ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    runs-on: ubuntu-latest
    # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ ÑƒĞ¿Ğ°Ğ»Ğ¾
    if: always()
    # Ğ–Ğ´Ñ‘Ñ‚ Ğ²ÑĞµÑ… job'Ğ¾Ğ² (Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ)
    needs: [lint, test, deploy, notify_start]

    steps:
    - name: Download lint logs (if any)
      uses: actions/download-artifact@v4
      with:
        name: lint-logs
        path: ./lint-logs
      continue-on-error: true

    - name: Download test report (if any)
      uses: actions/download-artifact@v4
      with:
        name: test-report
        path: ./test-logs
      continue-on-error: true

    - name: Download vps connection log (if any)
      uses: actions/download-artifact@v4
      with:
        name: vps-connection-log
        path: ./vps-log
      continue-on-error: true

    - name: Send Telegram notification
      run: |
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹
        LINT_STATUS="${{ needs.lint.result }}"
        TEST_STATUS="${{ needs.test.result }}"
        DEPLOY_STATUS="${{ needs.deploy.result }}"
        RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        if [ "$DEPLOY_STATUS" = "success" ]; then
          EMOJI="âœ…"
          STATUS="Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ ÑƒÑĞ¿ĞµÑˆĞµĞ½!"
        elif [ "$DEPLOY_STATUS" = "skipped" ]; then
          EMOJI="â›”"
          STATUS="Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‘Ğ½ (Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ² Ñ‚ĞµÑÑ‚Ğ°Ñ…/Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€Ğµ)"
        else
          EMOJI="âŒ"
          STATUS="ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´ĞµĞ¿Ğ»Ğ¾Ñ!"
        fi

        EXTRA_LINT=""
        if [ "$LINT_STATUS" != "success" ] && [ -f ./lint-logs/flake8.log ]; then
          EXTRA_LINT="\n\nLint (flake8) errors (top 30 lines):\n$(head -n 30 ./lint-logs/flake8.log | sed 's/"/\\"/g')"
        fi
        if [ "$LINT_STATUS" != "success" ] && [ -f ./lint-logs/black_check.log ]; then
          EXTRA_LINT="${EXTRA_LINT}\n\nBlack output (top 30 lines):\n$(head -n 30 ./lint-logs/black_check.log | sed 's/"/\\"/g')"
        fi

        EXTRA_TEST=""
        if [ "$TEST_STATUS" != "success" ] && [ -f ./test-logs/pytest.log ]; then
          EXTRA_TEST="\n\nPytest log (top 30 lines):\n$(head -n 30 ./test-logs/pytest.log | sed 's/"/\\"/g')"
        fi

        EXTRA_VPS=""
        if [ -f ./vps-log/connection.log ]; then
          EXTRA_VPS="\n\nVPS connection log (top 30 lines):\n$(head -n 30 ./vps-log/connection.log | sed 's/"/\\"/g')"
        fi

        MESSAGE="${EMOJI} KasperBot CI/CD\n\nĞ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ${STATUS}\n\nĞ›Ğ¸Ğ½Ñ‚ĞµÑ€: ${LINT_STATUS}\nĞ¢ĞµÑÑ‚Ñ‹: ${TEST_STATUS}\nĞ”ĞµĞ¿Ğ»Ğ¾Ğ¹: ${DEPLOY_STATUS}\n\nĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.event.head_commit.message }}\nĞ’ĞµÑ‚Ğ²ÑŒ: ${{ github.ref_name }}\nĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}\nRun: ${RUN_URL}${EXTRA_LINT}${EXTRA_TEST}${EXTRA_VPS}"

        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"${MESSAGE}\", \"parse_mode\": \"HTML\"}"


