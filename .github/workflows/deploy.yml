name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd /root/projects/error_bot
          
          # Backup текущей версии
          BACKUP_DIR="/root/projects/error_bot/backups/auto_$(date +%Y%m%d_%H%M%S)"
          echo "Creating backup: $BACKUP_DIR"
          mkdir -p "$BACKUP_DIR"
          cp -r config handlers keyboards services utils main.py requirements.txt "$BACKUP_DIR/" 2>/dev/null || true
          
          # Pull последних изменений
          echo "Pulling latest changes from GitHub..."
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
          
          # Обновление зависимостей
          echo "Updating dependencies..."
          /root/projects/error_bot/venv/bin/pip install -r requirements.txt --upgrade
          
          # Перезапуск бота
          echo "Restarting bot service..."
          systemctl restart error_bot
          
          # Проверка статуса
          sleep 3
          if systemctl is-active --quiet error_bot; then
            echo "✅ Bot successfully deployed and running!"
            systemctl status error_bot --no-pager
          else
            echo "❌ Bot failed to start! Rolling back..."
            if [ -d "$BACKUP_DIR" ]; then
              cp -r "$BACKUP_DIR"/* /root/projects/error_bot/
              systemctl restart error_bot
              echo "Rollback completed"
            fi
            exit 1
          fi
          
          # Очистка старых backup'ов
          echo "Cleaning old backups..."
          cd /root/projects/error_bot/backups
          ls -t | grep "^auto_" | tail -n +6 | xargs -r rm -rf
          
          echo "Deployment completed successfully!"