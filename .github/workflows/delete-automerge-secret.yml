name: Delete AUTOMERGE_PAT secret (one-shot)

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  actions: write

jobs:
  delete_secret:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Delete AUTOMERGE_PAT secret via API
        env:
          PAT: ${{ secrets.AUTOMERGE_PAT }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Deleting AUTOMERGE_PAT..."
          HTTP_CODE=$(curl -s -o /tmp/delete_response -w "%{http_code}" -X DELETE -H "Authorization: token $PAT" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/actions/secrets/AUTOMERGE_PAT" || true)
          echo "Delete HTTP code: $HTTP_CODE"
          if [ "${HTTP_CODE}" -ne 204 ]; then
            echo "Failed to delete AUTOMERGE_PAT (code=${HTTP_CODE}). Response:"; cat /tmp/delete_response; exit 1
          fi

      - name: Verify deletion
        env:
          PAT: ${{ secrets.AUTOMERGE_PAT }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          HTTP_CODE=$(curl -s -o /tmp/get_resp -w "%{http_code}" -H "Authorization: token $PAT" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$REPO/actions/secrets/AUTOMERGE_PAT" || true)
          echo "Verify HTTP code: $HTTP_CODE"
          if [ "$HTTP_CODE" -eq 404 ]; then
            echo "Secret deleted successfully."
          else
            echo "Secret still exists or unexpected response:"; cat /tmp/get_resp; exit 1
          fi

      - name: Self-cleanup (remove this workflow file)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git rm .github/workflows/delete-automerge-secret.yml || true
          git commit -m "ci: remove delete-automerge-secret workflow (self cleanup)" || true
          git push origin HEAD:main || true

      - name: Done
        run: echo "Delete workflow completed (check Actions run for details)."