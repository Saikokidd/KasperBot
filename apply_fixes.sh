#!/bin/bash

# =============================================================================
# –°–ö–†–ò–ü–¢ –ü–†–ò–ú–ï–ù–ï–ù–ò–Ø –í–°–ï–• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô (SYSTEMD VERSION)
# =============================================================================
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤:
# 1. quick_errors.py - –§–∏–∫—Å ConversationHandler
# 2. callbacks.py - –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# 3. notifications.py - –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
# 4. settings.py - –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
# 5. health.py - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
# 6. logger.py - –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤
# 7. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î
#
# =============================================================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

BOT_DIR="/root/Work/error_bot"
BACKUP_DIR="${BOT_DIR}/backups/fixes_$(date +%Y%m%d_%H%M%S)"

echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±–æ—Ç–∞ (systemd)"
echo "========================================"
echo ""

# =============================================================================
# –§–£–ù–ö–¶–ò–Ø: –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —Ñ–∞–π–ª–∞
# =============================================================================
backup_file() {
    local file=$1
    if [ -f "$file" ]; then
        local backup_path="${BACKUP_DIR}/$(dirname $file)"
        mkdir -p "$backup_path"
        cp "$file" "${BACKUP_DIR}/${file}"
        echo "   ‚úÖ –ë—ç–∫–∞–ø: $file"
    fi
}

# =============================================================================
# –®–ê–ì 1: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
# =============================================================================
echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤..."
mkdir -p "$BACKUP_DIR"

cd "$BOT_DIR"

# –ë—ç–∫–∞–ø –ë–î
if [ -f "bot_data.db" ]; then
    cp bot_data.db "${BACKUP_DIR}/bot_data.db"
    echo "   ‚úÖ –ë—ç–∫–∞–ø –ë–î"
fi

# –ë—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ–º –º–µ–Ω—è—Ç—å
backup_file "handlers/quick_errors.py"
backup_file "handlers/callbacks.py"
backup_file "utils/notifications.py"
backup_file "config/settings.py"
backup_file "handlers/health.py"
backup_file "utils/logger.py"

echo ""
echo "‚úÖ –ë—ç–∫–∞–ø—ã —Å–æ–∑–¥–∞–Ω—ã –≤: $BACKUP_DIR"
echo ""

# =============================================================================
# –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –±–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
# =============================================================================
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞..."

if systemctl is-active --quiet error_bot; then
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!"
    echo ""
    read -p "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ systemd..."
        sudo systemctl stop error_bot
        sleep 2
        echo "‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    else
        echo "‚ùå –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ—Ç–º–µ–Ω–µ–Ω–æ"
        exit 1
    fi
else
    echo "‚úÖ –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

echo ""

# =============================================================================
# –®–ê–ì 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
# =============================================================================
echo "üìù –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤..."
echo ""
echo "–í–ù–ò–ú–ê–ù–ò–ï: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ Claude –≤—Ä—É—á–Ω—É—é:"
echo ""
echo "1Ô∏è‚É£  handlers/quick_errors.py"
echo "    –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: quick_errors_fixed"
echo ""
echo "2Ô∏è‚É£  handlers/callbacks.py"
echo "    –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: callbacks_logging"
echo ""
echo "3Ô∏è‚É£  utils/notifications.py"
echo "    –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: notifications_fixed"
echo ""
echo "4Ô∏è‚É£  config/settings.py"
echo "    –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: settings_validated"
echo ""
echo "5Ô∏è‚É£  handlers/health.py"
echo "    –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: health_enhanced"
echo ""
echo "6Ô∏è‚É£  utils/logger.py"
echo "    –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: logger_rotating"
echo ""
echo "7Ô∏è‚É£  scripts/add_db_indexes_fixed.py"
echo "    –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: db_indexes_script"
echo ""
read -p "–§–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã? –ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
echo ""

# =============================================================================
# –®–ê–ì 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î
# =============================================================================
echo "üî® –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î..."

if [ -f "scripts/add_db_indexes_fixed.py" ]; then
    python3 scripts/add_db_indexes_fixed.py
    echo ""
else
    echo "‚ö†Ô∏è  –§–∞–π–ª scripts/add_db_indexes_fixed.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "   –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ db_indexes_script"
fi

# =============================================================================
# –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python
# =============================================================================
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python..."

check_syntax() {
    local file=$1
    if [ -f "$file" ]; then
        if python3 -m py_compile "$file" 2>/dev/null; then
            echo "   ‚úÖ $file"
        else
            echo "   ‚ùå $file - –û–®–ò–ë–ö–ê –°–ò–ù–¢–ê–ö–°–ò–°–ê!"
            return 1
        fi
    fi
}

errors=0

check_syntax "handlers/quick_errors.py" || errors=$((errors+1))
check_syntax "handlers/callbacks.py" || errors=$((errors+1))
check_syntax "utils/notifications.py" || errors=$((errors+1))
check_syntax "config/settings.py" || errors=$((errors+1))
check_syntax "handlers/health.py" || errors=$((errors+1))
check_syntax "utils/logger.py" || errors=$((errors+1))
check_syntax "main.py" || errors=$((errors+1))

echo ""

if [ $errors -gt 0 ]; then
    echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –≤ $errors —Ñ–∞–π–ª–∞—Ö!"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏"
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫–∏? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# =============================================================================
# –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ requirements
# =============================================================================
echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

if [ -f "requirements.txt" ]; then
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ –ø–∞–∫–µ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
    pip3 list --format=freeze | grep -q "python-telegram-bot" && echo "   ‚úÖ python-telegram-bot" || echo "   ‚ö†Ô∏è  python-telegram-bot - –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    pip3 list --format=freeze | grep -q "APScheduler" && echo "   ‚úÖ APScheduler" || echo "   ‚ö†Ô∏è  APScheduler - –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
    if pip3 list --format=freeze | grep -q "colorlog"; then
        echo "   ‚úÖ colorlog (—Ü–≤–µ—Ç–Ω—ã–µ –ª–æ–≥–∏)"
    else
        echo "   ‚ÑπÔ∏è  colorlog –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
        read -p "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å colorlog –¥–ª—è —Ü–≤–µ—Ç–Ω—ã—Ö –ª–æ–≥–æ–≤? (y/n): " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            pip3 install colorlog
        fi
    fi
    
    if pip3 list --format=freeze | grep -q "psutil"; then
        echo "   ‚úÖ psutil (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã)"
    else
        echo "   ‚ÑπÔ∏è  psutil –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
        read -p "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å psutil –¥–ª—è health check? (y/n): " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            pip3 install psutil
        fi
    fi
fi

echo ""

# =============================================================================
# –®–ê–ì 7: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
# =============================================================================
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd daemon..."
sudo systemctl daemon-reload
echo "‚úÖ Daemon –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
echo ""

echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."

read -p "–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ systemd —Å–µ–π—á–∞—Å? (y/n): " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    sudo systemctl start error_bot
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    if systemctl is-active --quiet error_bot; then
        echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
        echo ""
        echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
        echo "   sudo journalctl -u error_bot -f"
        echo ""
        echo "   –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ:"
        echo "   tail -f bot.log"
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞!"
        echo ""
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:"
        echo "   sudo systemctl status error_bot"
        echo ""
        echo "–õ–æ–≥–∏ systemd:"
        echo "   sudo journalctl -u error_bot -n 50"
        echo ""
        echo "–õ–æ–≥–∏ –±–æ—Ç–∞:"
        echo "   tail -n 50 bot.log"
    fi
else
    echo "‚ÑπÔ∏è  –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:"
    echo "   sudo systemctl start error_bot"
fi

echo ""

# =============================================================================
# –ò–¢–û–ì–ò
# =============================================================================
echo "========================================"
echo "‚úÖ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô –ó–ê–í–ï–†–®–ï–ù–û"
echo "========================================"
echo ""
echo "üì¶ –ë—ç–∫–∞–ø—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: $BACKUP_DIR"
echo ""
echo "üîç –í–ê–ñ–ù–´–ï –ü–†–û–í–ï–†–ö–ò:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: sudo systemctl status error_bot"
echo "   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: sudo journalctl -u error_bot -f"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health check: –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /health –±–æ—Ç—É"
echo "   4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ BMW –±—ã—Å—Ç—Ä—ã–µ –æ—à–∏–±–∫–∏"
echo "   5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ callback —Ä–∞–±–æ—Ç–∞—é—Ç"
echo ""
echo "üìù –ö–û–ú–ê–ù–î–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø (systemd):"
echo "   –°—Ç–∞—Ç—É—Å:      sudo systemctl status error_bot"
echo "   –û—Å—Ç–∞–Ω–æ–≤–∫–∞:   sudo systemctl stop error_bot"
echo "   –ó–∞–ø—É—Å–∫:      sudo systemctl start error_bot"
echo "   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:  sudo systemctl restart error_bot"
echo "   –õ–æ–≥–∏:        sudo journalctl -u error_bot -f"
echo "   –õ–æ–≥–∏ (100):  sudo journalctl -u error_bot -n 100"
echo ""
echo "üìù –û–¢–ö–ê–¢ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫):"
echo "   1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞: sudo systemctl stop error_bot"
echo "   2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª—ã: cp -r $BACKUP_DIR/* $BOT_DIR/"
echo "   3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: sudo systemctl start error_bot"
echo ""
echo "üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
echo "   ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–µ—Ä–≤—ã–µ 30 –º–∏–Ω—É—Ç"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π"
echo "   ‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –±—ç–∫–∞–ø—ã –Ω–∞ 7+ –¥–Ω–µ–π"
echo ""

# =============================================================================
# –°–û–ó–î–ê–ù–ò–ï –û–¢–ß–Å–¢–ê
# =============================================================================
cat > "${BACKUP_DIR}/CHANGELOG.txt" << EOF
====================================
CHANGELOG - $(date +"%Y-%m-%d %H:%M:%S")
====================================

–ü–†–ò–ú–ï–ù–Å–ù–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:

1. handlers/quick_errors.py
   ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω ConversationHandler - –∫–Ω–æ–ø–∫–∏ BMW —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ–≥–¥–∞
   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ SIP –∏–∑ –ë–î –µ—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–Ω –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
   ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

2. handlers/callbacks.py
   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö callback_query
   ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã debug –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

3. utils/notifications.py
   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
   ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ (max 100 –∑–∞–ø–∏—Å–µ–π)
   ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞

4. config/settings.py
   ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ BOT_TOKEN
   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ ID –≥—Ä—É–ø–ø (–¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "-")
   ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

5. handlers/health.py
   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã BMW –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫
   ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ ConversationHandler

6. utils/logger.py
   ‚úÖ –†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –ª–æ–≥–æ–≤ (10MB x 5 —Ñ–∞–π–ª–æ–≤)
   ‚úÖ –†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–ª—è console –∏ file
   ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ (colorlog)
   ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–æ–≥–æ–≤

7. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
   ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
   ‚úÖ VACUUM –∏ ANALYZE –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–£–ü–†–ê–í–õ–ï–ù–ò–ï –ß–ï–†–ï–ó SYSTEMD:
- –°—Ç–∞—Ç—É—Å:     sudo systemctl status error_bot
- –û—Å—Ç–∞–Ω–æ–≤–∫–∞:  sudo systemctl stop error_bot
- –ó–∞–ø—É—Å–∫:     sudo systemctl start error_bot
- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: sudo systemctl restart error_bot
- –õ–æ–≥–∏:       sudo journalctl -u error_bot -f

–ë–≠–ö–ê–ü–´:
- –ë–î: bot_data.db
- –í—Å–µ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

–û–¢–ö–ê–¢:
–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º:
1. sudo systemctl stop error_bot
2. cp -r $BACKUP_DIR/* $BOT_DIR/
3. sudo systemctl start error_bot
EOF

echo "üìÑ –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${BACKUP_DIR}/CHANGELOG.txt"
echo ""

# =============================================================================
# –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò
# =============================================================================
cat > "${BACKUP_DIR}/quick_commands.sh" << 'EOF'
#!/bin/bash
# –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

echo "üîç –ë–´–°–¢–†–ê–Ø –ü–†–û–í–ï–†–ö–ê –ë–û–¢–ê"
echo "========================"
echo ""

# –°—Ç–∞—Ç—É—Å systemd
echo "1Ô∏è‚É£  –°—Ç–∞—Ç—É—Å systemd:"
sudo systemctl status error_bot --no-pager -l
echo ""

# –ü—Ä–æ—Ü–µ—Å—Å
echo "2Ô∏è‚É£  –ü—Ä–æ—Ü–µ—Å—Å:"
ps aux | grep "python.*main.py" | grep -v grep || echo "   ‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"
echo ""

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
echo "3Ô∏è‚É£  –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤ bot.log:"
grep -i "error\|warning\|critical" bot.log | tail -n 5 || echo "   ‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
echo ""

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ journalctl
echo "4Ô∏è‚É£  –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ journalctl:"
sudo journalctl -u error_bot -n 10 --no-pager
echo ""

# –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤
echo "5Ô∏è‚É£  –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤:"
ls -lh bot.log* 2>/dev/null || echo "   –õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
echo ""

# –ë–î
echo "6Ô∏è‚É£  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:"
if [ -f "bot_data.db" ]; then
    SIZE=$(du -h bot_data.db | cut -f1)
    echo "   –†–∞–∑–º–µ—Ä: $SIZE"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
    INDEXES=$(sqlite3 bot_data.db "SELECT COUNT(*) FROM sqlite_master WHERE type='index' AND sql IS NOT NULL")
    echo "   –ò–Ω–¥–µ–∫—Å–æ–≤: $INDEXES"
else
    echo "   ‚ö†Ô∏è  bot_data.db –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi
echo ""

echo "========================"
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
echo ""
echo "–ö–æ–º–∞–Ω–¥—ã:"
echo "  –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏:    sudo journalctl -u error_bot -f"
echo "  –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:     sudo systemctl restart error_bot"
echo "  Health check:   –û—Ç–ø—Ä–∞–≤—å—Ç–µ /health –±–æ—Ç—É –≤ Telegram"
EOF

chmod +x "${BACKUP_DIR}/quick_commands.sh"

echo "üöÄ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏: ${BACKUP_DIR}/quick_commands.sh"
echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ${BACKUP_DIR}/quick_commands.sh"
echo ""
