=== config/__init__.py ===



=== config/constants.py ===
"""
–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –§–ê–ô–õ: config/constants.py
–î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫ BMW

–ò–ó–ú–ï–ù–ï–ù–ò–Ø:
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã MAX_SIP_LENGTH, MAX_CUSTOM_ERROR_LENGTH
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω KNOWN_TELEPHONY_NAMES –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
"""

# ===== –¢–ê–ô–ú–ê–£–¢–´ =====
TEL_CHOICE_TIMEOUT = 10  # –º–∏–Ω—É—Ç

# ===== –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø =====
# ‚úÖ –ù–û–í–û–ï: –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª
MAX_SIP_LENGTH = 50  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ SIP –Ω–æ–º–µ—Ä–∞
MAX_CUSTOM_ERROR_LENGTH = 500  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ custom –æ—à–∏–±–∫–∏ BMW

# ===== –ú–ê–ü–ü–ò–ù–ì –¢–ï–õ–ï–§–û–ù–ò–ò =====
TEL_CODES = {
    "BMW": "bmw",
    "–ó–≤–æ–Ω–∞—Ä–∏": "zvon"
}

TEL_CODES_REVERSE = {v: k for k, v in TEL_CODES.items()}

# ‚úÖ –ù–û–í–û–ï: –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ handle_telephony_choice
KNOWN_TELEPHONY_NAMES = {"BMW", "–ó–≤–æ–Ω–∞—Ä–∏"}

# ===== –ú–ï–ù–Æ –î–õ–Ø –†–û–õ–ï–ô =====
MANAGER_MENU = [
    ["–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"],
    ["–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏"]
]

ADMIN_MENU = [
    ["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"],
    ["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫"],
    ["–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º"]
]

PULT_MENU = [
    ["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"]
]

# ‚úÖ –ù–û–í–û–ï: –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (–¥–ª—è Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
TELEPHONY_MENU = [
    ["BMW", "–ó–≤–æ–Ω–∞—Ä–∏"],
    ["‚óÄÔ∏è –ú–µ–Ω—é"]
]

# ===== –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò =====
USEFUL_LINKS = {
    "CRM": "https://cabinetsmonster.com/crm/clients/work",
    "–ü–æ—á—Ç–∞ –±–∞–Ω–∫": "https://my.pochtabank.ru/login?next=%2F",
    "–û—Ç–¥–µ–ª–µ–Ω–∏—è –ø–æ—á—Ç—ã": "https://www.pochta.ru/offices"
}

# ‚úÖ –ù–û–í–û–ï: –ë—ã—Å—Ç—Ä—ã–µ –æ—à–∏–±–∫–∏ BMW
QUICK_ERRORS = {
    "1": "–ù–∞–º–±–µ—Ä –±–∏–∑–∏",
    "2": "–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
    "3": "–í—ã–∑–æ–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω",
    "4": "–ë–∞–ª–∞–Ω—Å",
    "5": "–°–ª–µ—Ç–µ–ª —Ä–µ–≥–∏—Å—Ç—Ä —Å–∏–º",
    "6": "–¢–µ–º–ø–æ—Ä–∞–ª–∏",
    "7": "–ó–∞–Ω—è—Ç–æ",
    "8": "–ù–µ—Ç–≤–æ—Ä–∫",
    "9": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤—è–∑–∏",
    "10": "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"
}

QUICK_ERROR_BUTTONS = {
    "1": "1Ô∏è‚É£ –ù–∞–º–±–µ—Ä –±–∏–∑–∏",
    "2": "2Ô∏è‚É£ –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
    "3": "3Ô∏è‚É£ –í—ã–∑–æ–≤ –Ω–µ —É—Å—Ç–∞–Ω",
    "4": "4Ô∏è‚É£ –ë–∞–ª–∞–Ω—Å",
    "5": "5Ô∏è‚É£ –°–ª–µ—Ç–µ–ª —Ä–µ–≥–∏—Å—Ç—Ä —Å–∏–º",
    "6": "6Ô∏è‚É£ –¢–µ–º–ø–æ—Ä–∞–ª–∏",
    "7": "7Ô∏è‚É£ –ó–∞–Ω—è—Ç–æ",
    "8": "8Ô∏è‚É£ –ù–µ—Ç–≤–æ—Ä–∫",
    "9": "9Ô∏è‚É£ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤—è–∑–∏",
    "10": "üîü –°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"
}

# ===== –¢–ï–ö–°–¢–´ –°–û–û–ë–©–ï–ù–ò–ô =====
MESSAGES = {
    "access_denied": "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.",
    "session_expired": "‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∑–∞–Ω–æ–≤–æ –∫–æ–º–∞–Ω–¥–æ–π /start",
    "choose_telephony": "üìû –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é:",
    "support_prompt": "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏:\n\n(–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞)",
    "error_too_long": "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ.\n–ú–∞–∫—Å–∏–º—É–º: 1000 —Å–∏–º–≤–æ–ª–æ–≤\n–°–µ–π—á–∞—Å: {length} —Å–∏–º–≤–æ–ª–æ–≤",
    "error_empty": "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç.",
    "error_sent_bmw": "‚úÖ –û—à–∏–±–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–∞–ø–ø–æ—Ä—Ç!\n\n–¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel}\n–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏‚ùóÔ∏è‚ùóÔ∏è",
    "error_sent_zvon": "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–∞–ø–æ—Ä—Ç–∞–º\n\n–¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel}\n–û—Ç–≤–µ—Ç–∞ –º–æ–∂–µ—Ç–µ –Ω–µ –æ–∂–∏–¥–∞—Ç—å‚ùóÔ∏è‚ùóÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É.",
    "support_sent": "‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!\n–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
    "unknown_command": "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.",
    
    # ‚úÖ –ù–û–í–û–ï: –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫
    "sip_prompt": "üìû –£–∫–∞–∂–∏—Ç–µ –≤–∞—à SIP –Ω–æ–º–µ—Ä:",
    "sip_saved": "‚úÖ SIP —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {sip}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—à–∏–±–∫–∏:",
    "sip_invalid": "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç SIP. –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: 101)",
    "choose_quick_error": "üìû –í–∞—à SIP: {sip}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—à–∏–±–∫–∏:",
    "custom_error_prompt": "‚úèÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏:",
    "quick_error_sent": "‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–∞–ø–ø–æ—Ä—Ç!\n\nSIP: {sip}\n–û—à–∏–±–∫–∞: {error}"
}

# ===== –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô =====
SUPPORT_ACTIONS = {
    "fix": "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ",
    "wait": "‚è± –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω",
    "wrong": "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç",
    "sim": "‚úÖ –°–∏–º –≤–æ—Ä–∫"
}


=== config/settings.py ===
"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞: –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
"""
import os
from dotenv import load_dotenv
from typing import Dict, List

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()


class Settings:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞"""
    
    def __init__(self):
        self._validate_env()
        self._load_env()
        self._parse_managers()
        self._parse_admins()
        self._parse_pult()
    
    def _validate_env(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        required = {
            "BOT_TOKEN": os.getenv("BOT_TOKEN"),
            "ADMIN_ID": os.getenv("ADMIN_ID"),
            "BMW_GROUP_ID": os.getenv("BMW_GROUP_ID"),
            "ZVONARI_GROUP_ID": os.getenv("ZVONARI_GROUP_ID")
        }
        
        missing = [key for key, value in required.items() if not value]
        if missing:
            raise ValueError(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env: {', '.join(missing)}")
    
    def _load_env(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        self.BOT_TOKEN = os.getenv("BOT_TOKEN")
        self.ADMIN_ID = int(os.getenv("ADMIN_ID"))
        self.BMW_GROUP_ID = int(os.getenv("BMW_GROUP_ID"))
        self.ZVONARI_GROUP_ID = int(os.getenv("ZVONARI_GROUP_ID"))
        self.GOOGLE_APPS_SCRIPT_URL = os.getenv("GOOGLE_APPS_SCRIPT_URL", "")
    
    def _parse_managers(self):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ .env"""
        managers_str = os.getenv("MANAGERS_IDS", "")
        self.MANAGERS = [
            int(id.strip()) 
            for id in managers_str.split(",") 
            if id.strip().isdigit()
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
        if self.ADMIN_ID not in self.MANAGERS:
            self.MANAGERS.append(self.ADMIN_ID)
    
    def _parse_admins(self):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤ –∏–∑ .env"""
        admins_str = os.getenv("ADMIN_IDS", "")
        
        if admins_str:
            # –ï—Å–ª–∏ –µ—Å—Ç—å ADMIN_IDS - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            self.ADMINS = [
                int(id.strip()) 
                for id in admins_str.split(",") 
                if id.strip().isdigit()
            ]
        else:
            # –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π ADMIN_ID
            self.ADMINS = [self.ADMIN_ID]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
        for admin_id in self.ADMINS:
            if admin_id not in self.MANAGERS:
                self.MANAGERS.append(admin_id)
    
    def _parse_pult(self):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –ø—É–ª—å—Ç–∞ –∏–∑ .env"""
        pult_str = os.getenv("PULT_IDS", "")
        
        if pult_str:
            self.PULT = [
                int(id.strip()) 
                for id in pult_str.split(",") 
                if id.strip().isdigit()
            ]
        else:
            self.PULT = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Ç –≤ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
        for pult_id in self.PULT:
            if pult_id not in self.MANAGERS:
                self.MANAGERS.append(pult_id)
    
    def get_telephony_groups(self) -> Dict[str, int]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã"""
        return {
            "BMW": self.BMW_GROUP_ID,
            "–ó–≤–æ–Ω–∞—Ä–∏": self.ZVONARI_GROUP_ID
        }


# –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
settings = Settings()


=== database/__init__.py ===



=== database/models.py ===
"""
–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø: database/models.py
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

–ò–ó–ú–ï–ù–ï–ù–ò–Ø:
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω race condition –≤ reset_all_sips
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã context managers –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
"""
import sqlite3
from datetime import datetime, date, timedelta
from typing import List, Dict, Optional
from pathlib import Path
from contextlib import closing
from utils.logger import logger


class Database:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    
    def __init__(self, db_path: str = "bot_data.db"):
        self.db_path = db_path
        self._create_tables()
    
    def _get_connection(self):
        """–°–æ–∑–¥–∞—ë—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î"""
        return sqlite3.connect(self.db_path)
    
    def _create_tables(self):
        """–°–æ–∑–¥–∞—ë—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã"""
        conn = self._get_connection()
        cursor = conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS managers (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                added_by INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS telephonies (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL,
                code TEXT UNIQUE NOT NULL,
                type TEXT NOT NULL CHECK(type IN ('white', 'black')),
                group_id INTEGER NOT NULL,
                enabled INTEGER DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_by INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ—à–∏–±–æ–∫
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS error_reports (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                username TEXT,
                telephony_code TEXT NOT NULL,
                description TEXT NOT NULL,
                status TEXT DEFAULT 'new',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                resolved_at TIMESTAMP,
                support_user_id INTEGER,
                support_username TEXT,
                support_action TEXT,
                response_time_seconds INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Å—ã–ª–æ–∫
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS broadcasts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                message_text TEXT,
                sent_by INTEGER,
                sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                recipients_count INTEGER,
                success_count INTEGER,
                failed_count INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ –¥–Ω—è–º
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS manager_daily_stats (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                username TEXT,
                first_name TEXT,
                date DATE NOT NULL,
                tubes_total INTEGER DEFAULT 0,
                tubes_green INTEGER DEFAULT 0,
                tubes_yellow INTEGER DEFAULT 0,
                tubes_purple INTEGER DEFAULT 0,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(user_id, date)
            )
        """)
        
        # ‚úÖ –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS manager_sips (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL UNIQUE,
                sip_number TEXT NOT NULL,
                last_updated DATE NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES managers(user_id)
            )
        """)
        
        conn.commit()
        conn.close()
        logger.info("‚úÖ –¢–∞–±–ª–∏—Ü—ã –ë–î —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
    
    # ===== –ú–ï–ù–ï–î–ñ–ï–†–´ =====
    
    def add_manager(self, user_id: int, username: str = None, 
                    first_name: str = None, added_by: int = None) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –ë–î"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO managers (user_id, username, first_name, added_by) VALUES (?, ?, ?, ?)",
                    (user_id, username, first_name, added_by)
                )
                conn.commit()
            logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ë–î")
            return True
        except sqlite3.IntegrityError:
            logger.warning(f"‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    def remove_manager(self, user_id: int) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("DELETE FROM managers WHERE user_id = ?", (user_id,))
                deleted = cursor.rowcount > 0
                conn.commit()
            if deleted:
                logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} —É–¥–∞–ª—ë–Ω")
            return deleted
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    def get_all_managers(self) -> List[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "SELECT user_id, username, first_name, added_at FROM managers ORDER BY added_at DESC"
                )
                rows = cursor.fetchall()
            
            return [
                {
                    "user_id": row[0],
                    "username": row[1],
                    "first_name": row[2],
                    "added_at": row[3]
                }
                for row in rows
            ]
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}")
            return []
    
    def is_manager(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT 1 FROM managers WHERE user_id = ?", (user_id,))
                exists = cursor.fetchone() is not None
            return exists
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    def update_manager_info(self, user_id: int, username: str = None, first_name: str = None) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ–Ω–µ–¥–∂–µ—Ä–µ"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "UPDATE managers SET username = ?, first_name = ? WHERE user_id = ?",
                    (username, first_name, user_id)
                )
                updated = cursor.rowcount > 0
                conn.commit()
            if updated:
                logger.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ {user_id}: {username}, {first_name}")
            return updated
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    # ===== –¢–ï–õ–ï–§–û–ù–ò–ò =====
    
    def add_telephony(self, name: str, code: str, tel_type: str, 
                      group_id: int, created_by: int = None) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO telephonies (name, code, type, group_id, created_by) VALUES (?, ?, ?, ?, ?)",
                    (name, code.lower(), tel_type, group_id, created_by)
                )
                conn.commit()
            logger.info(f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è {name} ({tel_type}) –¥–æ–±–∞–≤–ª–µ–Ω–∞")
            return True
        except sqlite3.IntegrityError:
            logger.warning(f"‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω–∏—è {name} –∏–ª–∏ –∫–æ–¥ {code} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {e}")
            return False
    
    def remove_telephony(self, code: str) -> bool:
        """–£–¥–∞–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é –ø–æ –∫–æ–¥—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("DELETE FROM telephonies WHERE code = ?", (code,))
                deleted = cursor.rowcount > 0
                conn.commit()
            if deleted:
                logger.info(f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è {code} —É–¥–∞–ª–µ–Ω–∞")
            return deleted
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {e}")
            return False
    
    def get_all_telephonies(self) -> List[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "SELECT name, code, type, group_id, enabled FROM telephonies WHERE enabled = 1 ORDER BY name"
                )
                rows = cursor.fetchall()
            
            return [
                {
                    "name": row[0],
                    "code": row[1],
                    "type": row[2],
                    "group_id": row[3],
                    "enabled": row[4]
                }
                for row in rows
            ]
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π: {e}")
            return []
    
    def get_telephony_by_code(self, code: str) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é –ø–æ –∫–æ–¥—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "SELECT name, code, type, group_id, enabled FROM telephonies WHERE code = ?",
                    (code,)
                )
                row = cursor.fetchone()
            
            if row:
                return {
                    "name": row[0],
                    "code": row[1],
                    "type": row[2],
                    "group_id": row[3],
                    "enabled": row[4]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {e}")
            return None
    
    def update_telephony_group(self, code: str, new_group_id: int) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç ID –≥—Ä—É–ø–ø—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "UPDATE telephonies SET group_id = ? WHERE code = ?",
                    (new_group_id, code)
                )
                updated = cursor.rowcount > 0
                conn.commit()
            if updated:
                logger.info(f"‚úÖ –ì—Ä—É–ø–ø–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ {code} –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
            return updated
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã: {e}")
            return False
    
    # ===== –ò–°–¢–û–†–ò–Ø –û–®–ò–ë–û–ö =====
    
    def log_error_report(self, user_id: int, username: str, 
                        telephony_code: str, description: str) -> Optional[int]:
        """–õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –æ—à–∏–±–∫—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO error_reports (user_id, username, telephony_code, description) VALUES (?, ?, ?, ?)",
                    (user_id, username, telephony_code, description)
                )
                report_id = cursor.lastrowid
                conn.commit()
            return report_id
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–∫–∏: {e}")
            return None
    
    def update_error_report(self, report_id: int, support_user_id: int,
                           support_username: str, support_action: str,
                           response_time_seconds: int) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ–± –æ—à–∏–±–∫–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∞–ø–ø–æ—Ä—Ç–æ–º"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    UPDATE error_reports 
                    SET resolved_at = CURRENT_TIMESTAMP,
                        support_user_id = ?,
                        support_username = ?,
                        support_action = ?,
                        response_time_seconds = ?,
                        status = 'resolved'
                    WHERE id = ?
                """, (support_user_id, support_username, support_action, response_time_seconds, report_id))
                updated = cursor.rowcount > 0
                conn.commit()
            if updated:
                logger.info(f"‚úÖ –û—à–∏–±–∫–∞ #{report_id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –ë–î (–≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {response_time_seconds//60}–º {response_time_seconds%60}—Å)")
            return updated
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏: {e}")
            return False
    
    # ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ú–ï–ù–ï–î–ñ–ï–†–û–í =====
    
    def upsert_manager_stats(self, user_id: int, username: str, first_name: str,
                            date_str: str, tubes_total: int, tubes_green: int = 0,
                            tubes_yellow: int = 0, tubes_purple: int = 0) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∑–∞ –¥–µ–Ω—å"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT INTO manager_daily_stats 
                    (user_id, username, first_name, date, tubes_total, tubes_green, tubes_yellow, tubes_purple, updated_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                    ON CONFLICT(user_id, date) DO UPDATE SET
                        username = excluded.username,
                        first_name = excluded.first_name,
                        tubes_total = excluded.tubes_total,
                        tubes_green = excluded.tubes_green,
                        tubes_yellow = excluded.tubes_yellow,
                        tubes_purple = excluded.tubes_purple,
                        updated_at = CURRENT_TIMESTAMP
                """, (user_id, username, first_name, date_str, tubes_total, tubes_green, tubes_yellow, tubes_purple))
                conn.commit()
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ {user_id} ({first_name}) –∑–∞ {date_str} –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {tubes_total} —Ç—Ä—É–±–æ–∫")
            return True
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            import traceback
            logger.error(traceback.format_exc())
            return False
    
    def get_managers_stats_for_date(self, date_str: str) -> List[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT user_id, username, first_name, tubes_total, tubes_green, tubes_yellow, tubes_purple
                    FROM manager_daily_stats
                    WHERE date = ?
                    ORDER BY tubes_total DESC
                """, (date_str,))
                rows = cursor.fetchall()
            
            return [
                {
                    "user_id": row[0],
                    "username": row[1],
                    "name": row[2],
                    "tubes": row[3],
                    "green": row[4],
                    "yellow": row[5],
                    "purple": row[6]
                }
                for row in rows
            ]
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            return []
    
    def get_managers_stats_for_week(self, start_date: str, end_date: str) -> Dict[int, Dict[str, Dict]]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é (–ü–ù-–°–ë)"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT user_id, username, first_name, date, tubes_total, tubes_green, tubes_yellow, tubes_purple
                    FROM manager_daily_stats
                    WHERE date BETWEEN ? AND ?
                    ORDER BY user_id, date
                """, (start_date, end_date))
                rows = cursor.fetchall()
            
            result = {}
            for row in rows:
                user_id = row[0]
                if user_id not in result:
                    result[user_id] = {
                        "username": row[1],
                        "name": row[2],
                        "dates": {}
                    }
                
                date_key = row[3]
                result[user_id]["dates"][date_key] = {
                    "tubes": row[4],
                    "green": row[5],
                    "yellow": row[6],
                    "purple": row[7]
                }
            
            return result
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            return {}
    
    # ===== SIP –ú–ï–ù–ï–î–ñ–ï–†–û–í =====
    
    def save_manager_sip(self, user_id: int, sip_number: str) -> bool:
        """
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        
        Args:
            user_id: ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            sip_number: –ù–æ–º–µ—Ä SIP
            
        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            today = date.today().isoformat()
            
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT INTO manager_sips (user_id, sip_number, last_updated)
                    VALUES (?, ?, ?)
                    ON CONFLICT(user_id) DO UPDATE SET
                        sip_number = excluded.sip_number,
                        last_updated = excluded.last_updated
                """, (user_id, sip_number, today))
                conn.commit()
            
            logger.info(f"‚úÖ SIP —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è user_id={user_id}: {sip_number}")
            return True
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è SIP: {e}")
            return False
    
    def get_manager_sip(self, user_id: int) -> Optional[Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        
        Args:
            user_id: ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            
        Returns:
            {'sip_number': str, 'last_updated': str} –∏–ª–∏ None
        """
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT sip_number, last_updated 
                    FROM manager_sips 
                    WHERE user_id = ?
                """, (user_id,))
                row = cursor.fetchone()
            
            if row:
                return {
                    'sip_number': row[0],
                    'last_updated': row[1]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è SIP: {e}")
            return None
    
    def is_sip_valid_today(self, user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —É–∫–∞–∑–∞–Ω –ª–∏ SIP —Å–µ–≥–æ–¥–Ω—è
        
        Args:
            user_id: ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            
        Returns:
            True –µ—Å–ª–∏ SIP —É–∫–∞–∑–∞–Ω —Å–µ–≥–æ–¥–Ω—è
        """
        sip_data = self.get_manager_sip(user_id)
        
        if not sip_data:
            return False
        
        today = date.today().isoformat()
        return sip_data['last_updated'] == today
    
    def reset_all_sips(self) -> int:
        """
        –°–±—Ä–æ—Å–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤—Å–µ—Ö SIP (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —É—Ç—Ä–æ–º –≤ 8:00)
        
        ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–µ—Ç SIP, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è
        
        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–±—Ä–æ—à–µ–Ω–Ω—ã—Ö SIP
        """
        try:
            yesterday = (date.today() - timedelta(days=1)).isoformat()
            today = date.today().isoformat()
            
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                
                # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ SIP, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è
                # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
                cursor.execute("""
                    UPDATE manager_sips 
                    SET last_updated = ?
                    WHERE last_updated >= ?
                """, (yesterday, today))
                
                affected = cursor.rowcount
                conn.commit()
            
            if affected > 0:
                logger.info(f"‚úÖ –°–±—Ä–æ—à–µ–Ω–æ {affected} SIP (–Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è)")
            else:
                logger.info("‚ÑπÔ∏è –í—Å–µ SIP —É–∂–µ –±—ã–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã —Ä–∞–Ω–µ–µ")
            
            return affected
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ SIP: {e}")
            return 0


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ë–î
db = Database()


=== keyboards/__init__.py ===



=== keyboards/inline.py ===
"""
Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∫–Ω–æ–ø–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö)
"""
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from config.constants import QUICK_ERROR_BUTTONS
from database.models import db


def get_telephony_keyboard() -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∏–∑ –ë–î)
    
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π
    """
    telephonies = db.get_all_telephonies()
    
    # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π –≤ –ë–î, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    if not telephonies:
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("BMW", callback_data="tel_bmw")],
            [InlineKeyboardButton("–ó–≤–æ–Ω–∞—Ä–∏", callback_data="tel_zvon")]
        ])
    
    # –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏ –∏–∑ –ë–î
    buttons = []
    for tel in telephonies:
        buttons.append([
            InlineKeyboardButton(tel['name'], callback_data=f"tel_{tel['code']}")
        ])
    
    return InlineKeyboardMarkup(buttons)


def get_role_choice_keyboard() -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
    
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
    """
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üë®‚Äçüíº –í–æ–π—Ç–∏ –∫–∞–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä", callback_data="role_manager")],
        [InlineKeyboardButton("üëë –í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω", callback_data="role_admin")]
    ])


def get_support_keyboard(user_id: int, tel_code: str) -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —Å–∞–ø–ø–æ—Ä—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–µ–ª—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π)
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞ –∏–ª–∏ None –¥–ª—è —á—ë—Ä–Ω—ã—Ö
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏–∑ –ë–î
    tel = db.get_telephony_by_code(tel_code)
    
    # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ
    if not tel:
        if tel_code != "bmw":
            return None
    else:
        # –ï—Å–ª–∏ —á—ë—Ä–Ω–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è - –±–µ–∑ –∫–Ω–æ–ø–æ–∫
        if tel['type'] == 'black':
            return None
    
    # –ë–µ–ª–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ", callback_data=f"fix_{user_id}_{tel_code}"),
            InlineKeyboardButton("‚è± 2-3 –º–∏–Ω", callback_data=f"wait_{user_id}_{tel_code}")
        ],
        [
            InlineKeyboardButton("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç", callback_data=f"wrong_{user_id}_{tel_code}"),
            InlineKeyboardButton("‚úÖ –°–∏–º –≤–æ—Ä–∫", callback_data=f"sim_{user_id}_{tel_code}")
        ]
    ])


# ===== –ù–û–í–´–ï –ö–õ–ê–í–ò–ê–¢–£–†–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø =====

def get_management_menu() -> InlineKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üë• –ú–µ–Ω–µ–¥–∂–µ—Ä—ã", callback_data="mgmt_managers")],
        [InlineKeyboardButton("üìû –¢–µ–ª–µ—Ñ–æ–Ω–∏–∏", callback_data="mgmt_telephonies")],
        [InlineKeyboardButton("üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="mgmt_broadcast")],
    ])


def get_telephony_type_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚ö™Ô∏è –ë–µ–ª–∞—è (—Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞)", callback_data="tel_type_white")],
        [InlineKeyboardButton("‚ö´Ô∏è –ß—ë—Ä–Ω–∞—è (–±–µ–∑ –∫–Ω–æ–ø–æ–∫)", callback_data="tel_type_black")]
    ])
    

# ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫ BMW
def get_quick_errors_keyboard() -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫ BMW (2 –∫–æ–ª–æ–Ω–∫–∏)
    
    Returns:
        InlineKeyboardMarkup —Å 10 –∫–Ω–æ–ø–∫–∞–º–∏ –æ—à–∏–±–æ–∫ + –∏–∑–º–µ–Ω–∏—Ç—å SIP
    """
    buttons = [
        # –ü–µ—Ä–≤—ã–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["1"], callback_data="qerr_1"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["2"], callback_data="qerr_2")
        ],
        # –í—Ç–æ—Ä–æ–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["3"], callback_data="qerr_3"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["4"], callback_data="qerr_4")
        ],
        # –¢—Ä–µ—Ç–∏–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["5"], callback_data="qerr_5"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["6"], callback_data="qerr_6")
        ],
        # –ß–µ—Ç–≤—ë—Ä—Ç—ã–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["7"], callback_data="qerr_7"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["8"], callback_data="qerr_8")
        ],
        # –ü—è—Ç—ã–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["9"], callback_data="qerr_9"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["10"], callback_data="qerr_10")
        ],
        # –®–µ—Å—Ç–æ–π —Ä—è–¥ - –∏–∑–º–µ–Ω–∏—Ç—å SIP
        [
            InlineKeyboardButton("‚öôÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å SIP", callback_data="change_sip")
        ]
    ]
    
    return InlineKeyboardMarkup(buttons)


=== keyboards/reply.py ===
"""
–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è keyboards/reply.py - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø
–î–æ–±–∞–≤–ª–µ–Ω–æ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
"""
from telegram import ReplyKeyboardMarkup, KeyboardButton
from config.constants import MANAGER_MENU, ADMIN_MENU, PULT_MENU, TELEPHONY_MENU


def get_manager_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in MANAGER_MENU],
        resize_keyboard=True
    )


def get_admin_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∞–¥–º–∏–Ω–∞
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in ADMIN_MENU],
        resize_keyboard=True
    )


def get_pult_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –ø—É–ª—å—Ç–∞
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø—É–ª—å—Ç–∞
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in PULT_MENU],
        resize_keyboard=True
    )


def get_menu_by_role(role: str) -> ReplyKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    
    Args:
        role: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ("manager", "admin" –∏–ª–∏ "pult")
        
    Returns:
        ReplyKeyboardMarkup —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Ä–æ–ª–∏
    """
    if role == "admin":
        return get_admin_menu()
    elif role == "pult":
        return get_pult_menu()
    return get_manager_menu()


# ‚úÖ –ù–û–í–û–ï: –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
def get_telephony_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π + –ú–µ–Ω—é
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in TELEPHONY_MENU],
        resize_keyboard=True
    )


=== utils/__init__.py ===



=== utils/logger.py ===
"""
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±–æ—Ç–∞
"""
import logging
import sys


def setup_logger(name: str = __name__, level: int = logging.INFO) -> logging.Logger:
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç logger —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    
    Args:
        name: –ò–º—è logger'–∞
        level: –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        
    Returns:
        –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π logger
    """
    logger = logging.getLogger(name)
    logger.setLevel(level)
    
    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å handlers, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    if logger.handlers:
        return logger
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    formatter = logging.Formatter(
        "%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S"
    )
    
    # Handler –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(level)
    console_handler.setFormatter(formatter)
    
    logger.addHandler(console_handler)
    
    return logger


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π logger –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
logger = setup_logger("bot", logging.INFO)



=== utils/notifications.py ===
"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
"""
from datetime import datetime
from typing import Optional
from telegram import Bot
from telegram.error import TelegramError

from config.settings import settings
from utils.logger import logger


class NotificationService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞–º"""
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ N –º–∏–Ω—É—Ç
    _last_notifications = {}
    _cooldown_minutes = 30
    
    @staticmethod
    async def notify_critical_error(
        bot: Bot,
        error_type: str,
        details: str,
        additional_info: Optional[str] = None
    ):
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            error_type: –¢–∏–ø –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Google Sheets", "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫")
            details: –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
            additional_info: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º
        notification_key = f"{error_type}:{details[:50]}"
        
        if NotificationService._is_recently_sent(notification_key):
            logger.debug(f"‚è≠ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (cooldown): {error_type}")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = NotificationService._format_critical_message(
            error_type, details, additional_info
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º
        success_count = 0
        for admin_id in settings.ADMINS:
            try:
                await bot.send_message(
                    chat_id=admin_id,
                    text=message,
                    parse_mode="HTML"
                )
                success_count += 1
                logger.info(f"‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {admin_id}")
            except TelegramError as e:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")
        
        if success_count > 0:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            NotificationService._last_notifications[notification_key] = datetime.now()
            logger.info(f"üì® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {success_count} –∞–¥–º–∏–Ω–∞–º")
    
    @staticmethod
    async def notify_warning(
        bot: Bot,
        warning_type: str,
        details: str
    ):
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            warning_type: –¢–∏–ø –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            details: –î–µ—Ç–∞–ª–∏
        """
        message = (
            f"‚ö†Ô∏è <b>–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï</b>\n\n"
            f"üìù {warning_type}\n"
            f"‚ÑπÔ∏è {details}\n\n"
            f"‚è∞ {datetime.now().strftime('%d.%m.%Y %H:%M')}"
        )
        
        for admin_id in settings.ADMINS:
            try:
                await bot.send_message(
                    chat_id=admin_id,
                    text=message,
                    parse_mode="HTML"
                )
            except TelegramError as e:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")
    
    @staticmethod
    async def notify_recovery(
        bot: Bot,
        service_name: str
    ):
        """
        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            service_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
        """
        message = (
            f"‚úÖ <b>–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï</b>\n\n"
            f"üìä {service_name}\n"
            f"‚úÖ –†–∞–±–æ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫\n\n"
            f"‚è∞ {datetime.now().strftime('%d.%m.%Y %H:%M')}"
        )
        
        for admin_id in settings.ADMINS:
            try:
                await bot.send_message(
                    chat_id=admin_id,
                    text=message,
                    parse_mode="HTML"
                )
            except TelegramError:
                pass  # –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è recovery —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    
    @staticmethod
    def _format_critical_message(
        error_type: str,
        details: str,
        additional_info: Optional[str]
    ) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É details
        if len(details) > 500:
            details = details[:497] + "..."
        
        message = (
            f"üö® <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</b>\n\n"
            f"üìä <b>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:</b> {error_type}\n"
            f"‚ùå <b>–û—à–∏–±–∫–∞:</b>\n<code>{details}</code>\n"
        )
        
        if additional_info:
            message += f"\n‚ÑπÔ∏è <b>–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n{additional_info}\n"
        
        message += f"\n‚è∞ <b>–í—Ä–µ–º—è:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}"
        
        return message
    
    @staticmethod
    def _is_recently_sent(notification_key: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±—ã–ª –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–∞–∫–æ–π –∂–µ notification –Ω–µ–¥–∞–≤–Ω–æ"""
        if notification_key not in NotificationService._last_notifications:
            return False
        
        last_time = NotificationService._last_notifications[notification_key]
        minutes_passed = (datetime.now() - last_time).total_seconds() / 60
        
        return minutes_passed < NotificationService._cooldown_minutes
    
    @staticmethod
    def clear_cooldowns():
        """–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ cooldowns (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
        NotificationService._last_notifications.clear()


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
notification_service = NotificationService()



=== utils/shutdown.py ===
"""
–ú–æ–¥—É–ª—å –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
"""
import signal
import sys
from typing import Callable, List
from utils.logger import logger


class ShutdownHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞"""
    
    def __init__(self):
        self._shutdown_callbacks: List[Callable] = []
        self._shutdown_in_progress = False
    
    def register_callback(self, callback: Callable):
        """
        –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç callback –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
        
        Args:
            callback: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ (–±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤)
        """
        self._shutdown_callbacks.append(callback)
        logger.info(f"‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω shutdown callback: {callback.__name__}")
    
    def setup_handlers(self):
        """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤"""
        signal.signal(signal.SIGINT, self._signal_handler)   # Ctrl+C
        signal.signal(signal.SIGTERM, self._signal_handler)  # systemctl stop
        logger.info("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (SIGINT, SIGTERM)")
    
    def _signal_handler(self, sig, frame):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"""
        if self._shutdown_in_progress:
            logger.warning("‚ö†Ô∏è Shutdown —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Å–∏–≥–Ω–∞–ª")
            return
        
        self._shutdown_in_progress = True
        
        signal_name = signal.Signals(sig).name
        logger.info(f"üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {signal_name}, –Ω–∞—á–∏–Ω–∞–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É...")
        
        # –í—ã–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ callbacks
        for callback in self._shutdown_callbacks:
            try:
                logger.info(f"üîÑ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: {callback.__name__}")
                callback()
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ {callback.__name__}: {e}")
        
        logger.info("‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        sys.exit(0)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
shutdown_handler = ShutdownHandler()



=== utils/state.py ===
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""
from datetime import datetime, timedelta
from telegram.ext import ContextTypes
from config.constants import TEL_CHOICE_TIMEOUT


def is_tel_choice_expired(context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å—Ç—ë–∫ –ª–∏ timeout –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        True –µ—Å–ª–∏ –≤—ã–±–æ—Ä –∏—Å—Ç—ë–∫, False –µ—Å–ª–∏ –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω
    """
    chosen_at = context.user_data.get("tel_chosen_at")
    if not chosen_at:
        return True
    return datetime.now() - chosen_at > timedelta(minutes=TEL_CHOICE_TIMEOUT)


def clear_tel_choice(context: ContextTypes.DEFAULT_TYPE):
    """
    –û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    context.user_data.pop("chosen_tel", None)
    context.user_data.pop("chosen_tel_code", None)
    context.user_data.pop("tel_chosen_at", None)


def clear_all_states(context: ContextTypes.DEFAULT_TYPE):
    """
    –û—á–∏—â–∞–µ—Ç –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    clear_tel_choice(context)
    context.user_data.pop("support_mode", None)
    context.user_data.pop("role", None)


def get_user_role(context: ContextTypes.DEFAULT_TYPE) -> str:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ("manager" –∏–ª–∏ "admin")
    """
    return context.user_data.get("role", "manager")


def set_user_role(context: ContextTypes.DEFAULT_TYPE, role: str):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        role: –†–æ–ª—å ("manager" –∏–ª–∏ "admin")
    """
    context.user_data["role"] = role


def set_support_mode(context: ContextTypes.DEFAULT_TYPE, enabled: bool):
    """
    –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        enabled: True –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è, False –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è
    """
    if enabled:
        context.user_data["support_mode"] = True
    else:
        context.user_data.pop("support_mode", None)


def is_support_mode(context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        True –µ—Å–ª–∏ —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω
    """
    return context.user_data.get("support_mode", False)


def set_tel_choice(context: ContextTypes.DEFAULT_TYPE, tel_name: str, tel_code: str):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        tel_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (BMW, –ó–≤–æ–Ω–∞—Ä–∏)
        tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (bmw, zvon)
    """
    context.user_data["chosen_tel"] = tel_name
    context.user_data["chosen_tel_code"] = tel_code
    context.user_data["tel_chosen_at"] = datetime.now()


def get_tel_choice(context: ContextTypes.DEFAULT_TYPE) -> tuple:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –ö–æ—Ä—Ç–µ–∂ (tel_name, tel_code) –∏–ª–∏ (None, None)
    """
    tel = context.user_data.get("chosen_tel")
    tel_code = context.user_data.get("chosen_tel_code")
    return tel, tel_code



