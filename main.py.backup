import logging
import os
from datetime import datetime, timedelta
from dotenv import load_dotenv
from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup,
    ReplyKeyboardMarkup, KeyboardButton, error as telegram_error
)
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    MessageHandler, ContextTypes, filters
)

# ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
load_dotenv()

def validate_env():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
    required = {
        "BOT_TOKEN": os.getenv("BOT_TOKEN"),
        "ADMIN_ID": os.getenv("ADMIN_ID"),
        "BMW_GROUP_ID": os.getenv("BMW_GROUP_ID"),
        "ZVONARI_GROUP_ID": os.getenv("ZVONARI_GROUP_ID")
    }
    
    missing = [key for key, value in required.items() if not value]
    if missing:
        raise ValueError(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env: {', '.join(missing)}")
    
    return required

# –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
env_vars = validate_env()
TOKEN = env_vars["BOT_TOKEN"]
ADMIN_ID = int(env_vars["ADMIN_ID"])
BMW_GROUP_ID = int(env_vars["BMW_GROUP_ID"])
ZVONARI_GROUP_ID = int(env_vars["ZVONARI_GROUP_ID"])

# –ü–∞—Ä—Å–∏–Ω–≥ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
MANAGERS_STR = os.getenv("MANAGERS_IDS", "")
MANAGERS = [int(id.strip()) for id in MANAGERS_STR.split(",") if id.strip().isdigit()]
if ADMIN_ID not in MANAGERS:
    MANAGERS.append(ADMIN_ID)

# –ú–∞–ø–ø–∏–Ω–≥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ ‚Üí –ª–∞—Ç–∏–Ω–∏—Ü–∞ –¥–ª—è callback_data)
TEL_GROUPS = {
    "BMW": BMW_GROUP_ID,
    "–ó–≤–æ–Ω–∞—Ä–∏": ZVONARI_GROUP_ID
}

TEL_CODES = {
    "BMW": "bmw",
    "–ó–≤–æ–Ω–∞—Ä–∏": "zvon"
}

TEL_CODES_REVERSE = {v: k for k, v in TEL_CODES.items()}

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–µ–Ω—é –¥–ª—è —Ä–æ–ª–µ–π
MANAGER_MENU = [
    ["–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"],
    ["–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏"],
    ["–ü–æ–¥–¥–µ—Ä–∂–∫–∞"]
]

ADMIN_MENU = [
    ["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–∞–∑–∞–º"],
    ["–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º"],
    ["–ü–æ–¥–¥–µ—Ä–∂–∫–∞"]
]

# Timeout –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (–≤ –º–∏–Ω—É—Ç–∞—Ö)
TEL_CHOICE_TIMEOUT = 10

# ===== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï =====
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ===== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =====

def get_manager_menu() -> ReplyKeyboardMarkup:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in MANAGER_MENU],
        resize_keyboard=True
    )

def get_admin_menu() -> ReplyKeyboardMarkup:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in ADMIN_MENU],
        resize_keyboard=True
    )

def is_tel_choice_expired(context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å—Ç—ë–∫ –ª–∏ timeout –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    chosen_at = context.user_data.get("tel_chosen_at")
    if not chosen_at:
        return True
    return datetime.now() - chosen_at > timedelta(minutes=TEL_CHOICE_TIMEOUT)

def clear_tel_choice(context: ContextTypes.DEFAULT_TYPE):
    """–û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    context.user_data.pop("chosen_tel", None)
    context.user_data.pop("chosen_tel_code", None)
    context.user_data.pop("tel_chosen_at", None)

def get_telephony_keyboard() -> InlineKeyboardMarkup:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("BMW", callback_data="tel_bmw")],
        [InlineKeyboardButton("–ó–≤–æ–Ω–∞—Ä–∏", callback_data="tel_zvon")]
    ])

def get_role_choice_keyboard() -> InlineKeyboardMarkup:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üë®‚Äçüíº –í–æ–π—Ç–∏ –∫–∞–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä", callback_data="role_manager")],
        [InlineKeyboardButton("üëë –í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω", callback_data="role_admin")]
    ])

# ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î =====

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    username = update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    if user_id not in MANAGERS:
        logger.warning(f"–û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ –¥–ª—è user_id={user_id}")
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return

    # –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    clear_tel_choice(context)
    context.user_data.pop("support_mode", None)
    context.user_data.pop("role", None)
    
    # –ï—Å–ª–∏ –∞–¥–º–∏–Ω - –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±–æ—Ä —Ä–æ–ª–∏
    if user_id == ADMIN_ID:
        logger.info(f"‚úÖ –ê–¥–º–∏–Ω {user_id} ({username}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç, {username}!\n\n"
            f"–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:",
            reply_markup=get_role_choice_keyboard()
        )
    else:
        # –û–±—ã—á–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
        context.user_data["role"] = "manager"
        logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} ({username}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç, {username}!\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=get_manager_menu()
        )

# ===== –í–´–ë–û–† –†–û–õ–ò –î–õ–Ø –ê–î–ú–ò–ù–ê =====

async def role_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    query = update.callback_query
    await query.answer()

    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
    if user_id != ADMIN_ID:
        await query.message.edit_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return

    if query.data == "role_manager":
        context.user_data["role"] = "manager"
        logger.info(f"üë®‚Äçüíº –ê–¥–º–∏–Ω {user_id} –≤–æ—à—ë–ª –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä")
        
        # –£–¥–∞–ª—è–µ–º inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        await query.message.edit_text(
            "üë®‚Äçüíº –í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=None
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        await query.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂–µ:",
            reply_markup=get_manager_menu()
        )
        
    elif query.data == "role_admin":
        context.user_data["role"] = "admin"
        logger.info(f"üëë –ê–¥–º–∏–Ω {user_id} –≤–æ—à—ë–ª –∫–∞–∫ –∞–¥–º–∏–Ω")
        
        # –£–¥–∞–ª—è–µ–º inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        await query.message.edit_text(
            "üëë –í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=None
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        await query.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂–µ:",
            reply_markup=get_admin_menu()
        )

# ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ú–ï–ù–Æ =====

async def menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é"""
    text = update.message.text
    role = context.user_data.get("role")
    user_id = update.effective_user.id
    
    logger.debug(f"–ö–Ω–æ–ø–∫–∞ '{text}' –æ—Ç user_id={user_id}, —Ä–æ–ª—å={role}")

    # –ï—Å–ª–∏ —Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞)
    if not role:
        await update.message.reply_text(
            "‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∑–∞–Ω–æ–≤–æ –∫–æ–º–∞–Ω–¥–æ–π /start"
        )
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏
    async def support():
        context.user_data["support_mode"] = True
        await update.message.reply_text(
            "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏:\n\n"
            "(–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞)"
        )

    async def telephony_errors():
        clear_tel_choice(context)  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
        await update.message.reply_text(
            "üìû –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—à–∏–±–∫–∏:",
            reply_markup=get_telephony_keyboard()
        )

    async def useful_links():
        links_text = (
            "üîó <b>–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:</b>\n\n"
            "1. <a href='https://cabinetsmonster.com/crm/clients/work'>CRM</a>\n"
            "2. <a href='https://my.pochtabank.ru/login?next=%2F'>–ü–æ—á—Ç–∞ –±–∞–Ω–∫</a>\n"
            "3. <a href='https://www.pochta.ru/offices'>–û—Ç–¥–µ–ª–µ–Ω–∏—è –ø–æ—á—Ç—ã</a>"
        )
        await update.message.reply_text(links_text, parse_mode="HTML")

    async def stats():
        await update.message.reply_text(
            "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–∞–∑–∞–º:\n\n"
            "[–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]\n"
            "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ..."
        )

    async def bot_management():
        await update.message.reply_text(
            "‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º:\n\n"
            "[–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è]\n"
            "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ..."
        )

    # –ú–∞–ø–ø–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏
    MENU_ACTIONS = {
        "–ü–æ–¥–¥–µ—Ä–∂–∫–∞": support,
        "–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏": telephony_errors,
        "–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏": useful_links,
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–∞–∑–∞–º": stats,
        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º": bot_management,
    }

    action = MENU_ACTIONS.get(text)
    if action:
        await action()
    else:
        logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∫–Ω–æ–ø–∫–∏: '{text}' –æ—Ç user_id={user_id}")
        current_menu = get_admin_menu() if role == "admin" else get_manager_menu()
        await update.message.reply_text(
            "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.",
            reply_markup=current_menu
        )

# ===== –í–´–ë–û–† –¢–ï–õ–ï–§–û–ù–ò–ò =====

async def tel_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ —á–µ—Ä–µ–∑ inline –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()

    try:
        callback_data = query.data
        logger.debug(f"Callback data: {callback_data}")
        
        if not callback_data.startswith("tel_"):
            logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {callback_data}")
            await query.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–±–æ—Ä–∞.")
            return

        tel_code = callback_data.split("_")[1]
        tel_name = TEL_CODES_REVERSE.get(tel_code)
        
        if not tel_name:
            logger.error(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {tel_code}")
            await query.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è.")
            return

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
        context.user_data["chosen_tel"] = tel_name
        context.user_data["chosen_tel_code"] = tel_code
        context.user_data["tel_chosen_at"] = datetime.now()
        
        logger.info(f"‚úÖ User {update.effective_user.id} –≤—ã–±—Ä–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é: {tel_name} ({tel_code})")

        await query.message.edit_text(
            f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏: <b>{tel_name}</b>\n\n"
            f"üìù –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏\n"
            f"‚è± –í—ã–±–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω {TEL_CHOICE_TIMEOUT} –º–∏–Ω—É—Ç.",
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ tel_choice: {e}", exc_info=True)
        await query.message.reply_text(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
            reply_markup=get_telephony_keyboard()
        )

# ===== –û–¢–ü–†–ê–í–ö–ê –û–®–ò–ë–ö–ò –í –ì–†–£–ü–ü–£ =====

async def forward_error(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –æ—à–∏–±–∫—É –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –≥—Ä—É–ø–ø—É"""
    user_id = update.effective_user.id
    username = update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    role = context.user_data.get("role", "manager")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    tel = context.user_data.get("chosen_tel")
    tel_code = context.user_data.get("chosen_tel_code")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ timeout
    if tel and is_tel_choice_expired(context):
        clear_tel_choice(context)
        tel = None
        tel_code = None
        logger.info(f"‚è± –ò—Å—Ç—ë–∫ timeout –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –¥–ª—è user_id={user_id}")

    if not tel or not tel_code:
        current_menu = get_admin_menu() if role == "admin" else get_manager_menu()
        await update.message.reply_text(
            "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É '–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏'",
            reply_markup=current_menu
        )
        return

    group_id = TEL_GROUPS.get(tel)
    if not group_id:
        logger.error(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {tel}")
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ –¥–ª—è —ç—Ç–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏.")
        return

    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–∫–∏
    error_text = update.message.text or update.message.caption or ""
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
    if len(error_text) > 1000:
        await update.message.reply_text(
            "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ.\n"
            f"–ú–∞–∫—Å–∏–º—É–º: 1000 —Å–∏–º–≤–æ–ª–æ–≤\n"
            f"–°–µ–π—á–∞—Å: {len(error_text)} —Å–∏–º–≤–æ–ª–æ–≤"
        )
        return
    
    if len(error_text.strip()) == 0 and not (update.message.photo or update.message.document):
        await update.message.reply_text(
            "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç."
        )
        return

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã
    msg = (
        f"–û—Ç: {username}"
        f"\n{error_text}"
    )

    # –ö–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è BMW
    kb = None
    if tel_code == "bmw":
        kb = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ", callback_data=f"fix_{user_id}_{tel_code}"),
                InlineKeyboardButton("‚è± 2-3 –º–∏–Ω", callback_data=f"wait_{user_id}_{tel_code}")
            ],
            [
                InlineKeyboardButton("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç", callback_data=f"wrong_{user_id}_{tel_code}"),
                InlineKeyboardButton("‚úÖ –°–∏–º –≤–æ—Ä–∫", callback_data=f"sim_{user_id}_{tel_code}")
            ]
        ])

    try:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        sent_msg = await context.bot.send_message(
            chat_id=group_id,
            text=msg,
            parse_mode="HTML",
            reply_markup=kb
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if update.message.photo:
            await context.bot.send_photo(
                chat_id=group_id,
                photo=update.message.photo[-1].file_id,
                reply_to_message_id=sent_msg.message_id
            )
            logger.info(f"üì∏ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ –∫ –æ—à–∏–±–∫–µ")
        elif update.message.document:
            await context.bot.send_document(
                chat_id=group_id,
                document=update.message.document.file_id,
                reply_to_message_id=sent_msg.message_id
            )
            logger.info(f"üìé –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç –∫ –æ—à–∏–±–∫–µ")
        
        logger.info(f"‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –≥—Ä—É–ø–ø—É {group_id} –æ—Ç user_id={user_id} ({tel})")
        
    except telegram_error.TelegramError as e:
        logger.error(f"‚ùå Telegram error –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –≥—Ä—É–ø–ø—É {group_id}: {e}", exc_info=True)
        await update.message.reply_text(
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –≤ —Å–∞–ø–ø–æ—Ä—Ç.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
        return
    except Exception as e:
        logger.error(f"‚ùå Unexpected error –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—à–∏–±–∫–∏: {e}", exc_info=True)
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.")
        return

    # –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
    clear_tel_choice(context)
    current_menu = get_admin_menu() if role == "admin" else get_manager_menu()
    
    # –†–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π
    if tel_code == "zvon":
        response_text = (
            "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–∞–ø–æ—Ä—Ç–∞–º\n\n"
            f"–¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel}\n"
            "–û—Ç–≤–µ—Ç–∞ –º–æ–∂–µ—Ç–µ –Ω–µ –æ–∂–∏–¥–∞—Ç—å‚ùóÔ∏è‚ùóÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É."
        )
    else:  # bmw
        response_text = (
            "‚úÖ –û—à–∏–±–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–∞–ø–ø–æ—Ä—Ç!\n\n"
            f"–¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel}\n"
            "–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏‚ùóÔ∏è‚ùóÔ∏è"
        )
    
    await update.message.reply_text(
        response_text,
        parse_mode="HTML",
        reply_markup=current_menu
    )

# ===== –û–ë–†–ê–ë–û–¢–ö–ê –û–¢–í–ï–¢–û–í –°–ê–ü–ü–û–†–¢–ê =====

async def support_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è BMW)"""
    query = update.callback_query
    await query.answer()

    try:
        data = query.data.split("_")
        if len(data) != 3:
            raise ValueError(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {query.data}")

        action_code, user_id_str, tel_code = data
        user_id = int(user_id_str)
        tel_name = TEL_CODES_REVERSE.get(tel_code, "Unknown")

        # –ú–∞–ø–ø–∏–Ω–≥ –¥–µ–π—Å—Ç–≤–∏–π
        action_map = {
            "fix": "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ",
            "wait": "‚è± –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω",
            "wrong": "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç",
            "sim": "‚úÖ –°–∏–º –≤–æ—Ä–∫"
        }

        action_text = action_map.get(action_code, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")
        support_user = query.from_user.first_name or "–°–∞–ø–ø–æ—Ä—Ç"
        
        logger.info(f"üîß –°–∞–ø–ø–æ—Ä—Ç –¥–µ–π—Å—Ç–≤–∏–µ: {action_text} –¥–ª—è –æ—à–∏–±–∫–∏ –æ—Ç user_id={user_id} ({tel_name}) –æ—Ç {support_user}")

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        original_text = query.message.text_html or query.message.text
        
        # –û–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ
        if len(original_text) > 3500:
            original_text = original_text[:3500] + "..."
        
        new_message = (
            f"{original_text}\n"
            f"{action_text}\n"
            f"<b>–û–±—Ä–∞–±–æ—Ç–∞–ª:</b> {support_user}"
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º
        await context.bot.send_message(
            chat_id=query.message.chat_id,
            text=new_message,
            parse_mode="HTML"
        )

        # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
        try:
            await query.message.delete()
        except telegram_error.TelegramError as e:
            logger.error(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ: {e}")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            notification = (
                f"üí¨ <b>–û—Ç–≤–µ—Ç –æ—Ç —Å–∞–ø–ø–æ—Ä—Ç–∞</b>\n\n"
                f"üìû –¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel_name}\n"
                f"–°—Ç–∞—Ç—É—Å: {action_text}"
            )
            
            if action_code == "wrong":
                notification += "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ."
            elif action_code == "wait":
                notification += "‚è± –í–∞—à–∞ –ø—Ä–æ–±–ª–µ–º–∞ –±—É–¥–µ—Ç —Ä–µ—à–µ–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 2-3 –º–∏–Ω—É—Ç."
            else:
                notification += ""
            
            await context.bot.send_message(
                chat_id=user_id,
                text=notification,
                parse_mode="HTML"
            )
            logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ user_id={user_id}")
        except telegram_error.TelegramError as e:
            logger.error(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å user_id={user_id}: {e}")
            
    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ support_callback: {e}")
        await query.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.")
    except Exception as e:
        logger.error(f"‚ùå Unexpected error –≤ support_callback: {e}", exc_info=True)
        await query.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞.")

# ===== –û–ë–†–ê–ë–û–¢–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò =====

async def handle_support_mode(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –≤ —Ä–µ–∂–∏–º–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"""
    if not context.user_data.get("support_mode"):
        return False

    support_msg = (
        f"üí¨ <b>–í–æ–ø—Ä–æ—Å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</b>\n\n"
        f"üë§ –û—Ç: {update.effective_user.first_name}\n"
        f"üÜî ID: {update.effective_user.id}\n"
        f"{'‚îÄ' * 30}\n"
        f"üìù –í–æ–ø—Ä–æ—Å:\n{update.message.text}"
    )
    
    try:
        await context.bot.send_message(
            chat_id=ADMIN_ID,
            text=support_msg,
            parse_mode="HTML"
        )
        role = context.user_data.get("role", "manager")
        current_menu = get_admin_menu() if role == "admin" else get_manager_menu()
        
        await update.message.reply_text(
            "‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!\n"
            "–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
            reply_markup=current_menu
        )
        logger.info(f"‚úÖ –í–æ–ø—Ä–æ—Å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç user_id={update.effective_user.id}")
    except telegram_error.TelegramError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: {e}", exc_info=True)
        await update.message.reply_text(
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
    
    context.user_data["support_mode"] = False
    return True

# ===== –û–ë–©–ò–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô =====

async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    if user_id not in MANAGERS:
        return

    text = update.message.text
    if not text:
        return

    logger.debug(f"üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç user_id={user_id}: '{text[:50]}...'")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    if await handle_support_mode(update, context):
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é
    all_menu_texts = {
        "–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏", "–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏", "–ü–æ–¥–¥–µ—Ä–∂–∫–∞",
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±–∞–∑–∞–º", "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º"
    }

    if text in all_menu_texts:
        await menu_handler(update, context)
    else:
        # –ï—Å–ª–∏ –Ω–µ –∫–Ω–æ–ø–∫–∞ - —Å—á–∏—Ç–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—à–∏–±–∫–∏
        await forward_error(update, context)

# ===== FALLBACK –î–õ–Ø CALLBACK =====

async def fallback_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback –∑–∞–ø—Ä–æ—Å–æ–≤"""
    query = update.callback_query
    logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π callback: {query.data} –æ—Ç user_id={query.from_user.id}")
    await query.answer()
    
    role = context.user_data.get("role", "manager")
    current_menu = get_admin_menu() if role == "admin" else get_manager_menu()
    
    await query.message.reply_text(
        "‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
        reply_markup=current_menu
    )

# ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–®–ò–ë–û–ö =====

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"‚ùå Exception while handling an update: {context.error}", exc_info=context.error)
    
    try:
        if update and update.effective_message:
            await update.effective_message.reply_text(
                "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
            )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: {e}")

# ===== MAIN =====

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        logger.info(f"üìã –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: {len(MANAGERS)}")
        logger.info(f"üëë Admin ID: {ADMIN_ID}")
        logger.info(f"üìû –¢–µ–ª–µ—Ñ–æ–Ω–∏–∏: {', '.join(TEL_GROUPS.keys())}")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        app = Application.builder().token(TOKEN).build()

        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω!)
        app.add_handler(CommandHandler("start", start))
        app.add_handler(CallbackQueryHandler(role_choice, pattern="^role_"))
        app.add_handler(CallbackQueryHandler(tel_choice, pattern="^tel_"))
        app.add_handler(CallbackQueryHandler(support_callback, pattern="^(fix|wait|wrong|sim)_"))
        app.add_handler(CallbackQueryHandler(fallback_callback))
        app.add_handler(MessageHandler(
            filters.ALL & ~filters.COMMAND & filters.ChatType.PRIVATE,
            message_handler
        ))
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –æ—à–∏–±–æ–∫
        app.add_error_handler(error_handler)

        logger.info("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        app.run_polling(allowed_updates=Update.ALL_TYPES)
        
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}", exc_info=True)
        raise

if __name__ == "__main__":
    main()