=== services/__init__.py ===



=== services/analytics_service.py ===
"""
–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
"""
from datetime import datetime, timedelta
from typing import Dict, List, Tuple
from database.models import db
from utils.logger import logger


class AnalyticsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –æ—à–∏–±–∫–∞–º"""
    
    @staticmethod
    def _get_period_filter(period: str) -> Tuple[str, str, str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞"""
        if period == "today":
            date_filter = datetime.now().strftime("%Y-%m-%d")
            title = "–∑–∞ —Å–µ–≥–æ–¥–Ω—è"
            where_clause = "DATE(created_at) = ?"
        elif period == "week":
            date_filter = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
            title = "–∑–∞ –Ω–µ–¥–µ–ª—é"
            where_clause = "DATE(created_at) >= ?"
        else:  # month
            date_filter = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
            title = "–∑–∞ –º–µ—Å—è—Ü"
            where_clause = "DATE(created_at) >= ?"
        
        return where_clause, date_filter, title
    
    @staticmethod
    def get_dashboard_overview(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –û–±—â–∏–π –æ–±–∑–æ—Ä (–ò–°–ü–†–ê–í–õ–ï–ù–û - —É–±—Ä–∞–ª–∏ "–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ")
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            where_clause, date_filter, title = AnalyticsService._get_period_filter(period)
            
            # –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            cursor.execute(
                f"SELECT COUNT(*) FROM error_reports WHERE {where_clause}",
                (date_filter,)
            )
            total = cursor.fetchone()[0]
            
            if total == 0:
                conn.close()
                return f"üìä <b>–î–ê–®–ë–û–†–î {title.upper()}</b>\n\nüì≠ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
            
            # –¢–æ–ª—å–∫–æ —Ä–µ—à—ë–Ω–Ω—ã–µ (–≤—Å–µ —Å support_action)
            cursor.execute(
                f"""
                SELECT COUNT(*)
                FROM error_reports 
                WHERE {where_clause} AND support_action IS NOT NULL
                """,
                (date_filter,)
            )
            resolved = cursor.fetchone()[0]
            
            # –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º
            cursor.execute(
                f"""
                SELECT telephony_code, COUNT(*) as cnt 
                FROM error_reports 
                WHERE {where_clause}
                GROUP BY telephony_code
                ORDER BY cnt DESC
                """,
                (date_filter,)
            )
            by_telephony = cursor.fetchall()
            
            # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–æ 30 –º–∏–Ω—É—Ç)
            cursor.execute(
                f"""
                SELECT AVG(response_time_seconds)
                FROM error_reports 
                WHERE {where_clause} 
                AND response_time_seconds IS NOT NULL 
                AND response_time_seconds <= 1800
                """,
                (date_filter,)
            )
            avg_time = cursor.fetchone()[0]
            
            conn.close()
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            result = f"üìä <b>–î–ê–®–ë–û–†–î {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            # –û–±—â–µ–µ
            resolved_pct = int((resolved / total) * 100) if total > 0 else 0
            
            result += f"üìà <b>–û–ë–©–ï–ï:</b>\n"
            result += f"‚Ä¢ –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: <b>{total}</b>\n"
            result += f"‚Ä¢ ‚úÖ –†–µ—à–µ–Ω–æ: {resolved} ({resolved_pct}%)\n\n"
            
            # –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞–º–∏
            if by_telephony:
                result += f"üìû <b>–ü–û –¢–ï–õ–ï–§–û–ù–ò–Ø–ú:</b>\n"
                for tel_code, count in by_telephony:
                    tel = db.get_telephony_by_code(tel_code)
                    tel_name = tel['name'] if tel else tel_code.upper()
                    percentage = int((count / total) * 100)
                    
                    # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    filled = int(percentage / 10)
                    bar = "‚ñà" * filled + "‚ñë" * (10 - filled)
                    
                    result += f"‚Ä¢ {tel_name}: {bar} {count} ({percentage}%)\n"
                result += "\n"
            
            # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è
            if avg_time:
                minutes = int(avg_time // 60)
                seconds = int(avg_time % 60)
                result += f"‚è± <b>–°–†–ï–î–ù–ï–ï –í–†–ï–ú–Ø –û–¢–í–ï–¢–ê:</b>\n"
                result += f"‚Ä¢ {minutes}–º {seconds}—Å\n\n"
            
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"
    
    @staticmethod
    def get_dashboard_managers(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã (–ò–°–ü–†–ê–í–õ–ï–ù–û - –±–µ–∑ –º–µ–¥–∞–ª–µ–π, –≤—ã—Ä–æ–≤–Ω–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞)
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            where_clause, date_filter, title = AnalyticsService._get_period_filter(period)
            
            # –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
            cursor.execute(
                f"""
                SELECT username, user_id, COUNT(*) as cnt 
                FROM error_reports 
                WHERE {where_clause}
                GROUP BY user_id 
                ORDER BY cnt DESC
                """,
                (date_filter,)
            )
            managers = cursor.fetchall()
            
            # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
            cursor.execute(
                f"SELECT COUNT(*) FROM error_reports WHERE {where_clause}",
                (date_filter,)
            )
            total = cursor.fetchone()[0]
            
            conn.close()
            
            if not managers:
                return f"üë• <b>–í–°–ï –ú–ï–ù–ï–î–ñ–ï–†–´ {title.upper()}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
            
            result = f"üë• <b>–í–°–ï –ú–ï–ù–ï–î–ñ–ï–†–´ {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            # –¢–∞–±–ª–∏—Ü–∞ —Å –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
            result += "<pre>"
            result += "‚îå‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n"
            result += "‚îÇ # ‚îÇ     –ò–º—è      ‚îÇ–û—à–∏–±–æ–∫‚îÇ %  ‚îÇ\n"
            result += "‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n"
            
            for i, (username, user_id, count) in enumerate(managers, 1):
                name = username or f"ID{user_id}"
                # –û–±—Ä–µ–∑–∞–µ–º –∏–º—è –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ
                if len(name) > 12:
                    name = name[:9] + "..."
                
                percentage = int((count / total) * 100) if total > 0 else 0
                
                # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
                result += f"‚îÇ{i:2} ‚îÇ {name:12} ‚îÇ {count:4} ‚îÇ{percentage:3}%‚îÇ\n"
            
            result += "‚îî‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
            result += "</pre>\n\n"
            
            result += f"–í—Å–µ–≥–æ: {len(managers)} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ | {total} –æ—à–∏–±–æ–∫\n\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"
    
    @staticmethod
    def get_dashboard_support(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3: –í—Å–µ —Å–∞–ø–ø–æ—Ä—Ç—ã (–ò–°–ü–†–ê–í–õ–ï–ù–û - –±–µ–∑ –º–µ–¥–∞–ª–µ–π, –≤—Ä–µ–º—è –≤ –∫–æ–Ω—Ü–µ)
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            if period == "today":
                date_filter = datetime.now().strftime("%Y-%m-%d")
                title = "–∑–∞ —Å–µ–≥–æ–¥–Ω—è"
                where_clause = "DATE(resolved_at) = ?"
            elif period == "week":
                date_filter = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
                title = "–∑–∞ –Ω–µ–¥–µ–ª—é"
                where_clause = "DATE(resolved_at) >= ?"
            else:
                date_filter = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
                title = "–∑–∞ –º–µ—Å—è—Ü"
                where_clause = "DATE(resolved_at) >= ?"
            
            # –í—Å–µ —Å–∞–ø–ø–æ—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–æ 30 –º–∏–Ω—É—Ç)
            cursor.execute(
                f"""
                SELECT support_username, support_user_id, 
                       COUNT(*) as total,
                       AVG(CASE WHEN response_time_seconds <= 1800 THEN response_time_seconds END) as avg_time,
                       SUM(CASE WHEN support_action = 'fix' THEN 1 ELSE 0 END) as fixed,
                       SUM(CASE WHEN support_action = 'wait' THEN 1 ELSE 0 END) as wait,
                       SUM(CASE WHEN support_action = 'wrong' THEN 1 ELSE 0 END) as wrong,
                       SUM(CASE WHEN support_action = 'sim' THEN 1 ELSE 0 END) as sim
                FROM error_reports 
                WHERE {where_clause} AND support_username IS NOT NULL
                GROUP BY support_user_id 
                ORDER BY total DESC
                """,
                (date_filter,)
            )
            supports = cursor.fetchall()
            
            conn.close()
            
            if not supports:
                return f"üõ† <b>–í–°–ï –°–ê–ü–ü–û–†–¢–´ {title.upper()}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
            
            result = f"üõ† <b>–í–°–ï –°–ê–ü–ü–û–†–¢–´ {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            for i, (username, user_id, total, avg_time, fixed, wait, wrong, sim) in enumerate(supports, 1):
                name = username or f"ID{user_id}"
                
                result += f"{i}. <b>{name}</b> - {total}\n"
                
                # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º
                actions = []
                if fixed > 0:
                    actions.append(f"‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: {fixed}")
                if wait > 0:
                    actions.append(f"‚è± 2-3 –º–∏–Ω: {wait}")
                if wrong > 0:
                    actions.append(f"‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {wrong}")
                if sim > 0:
                    actions.append(f"‚úÖ –°–∏–º –≤–æ—Ä–∫: {sim}")
                
                for action in actions:
                    result += f"   {action}\n"
                
                # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤ –∫–æ–Ω—Ü–µ
                if avg_time:
                    minutes = int(avg_time // 60)
                    seconds = int(avg_time % 60)
                    result += f"   ‚è± –°—Ä–µ–¥–Ω–µ–µ: {minutes}–º {seconds}—Å\n"
                
                result += "\n"
            
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"
    
    @staticmethod
    def get_dashboard_timing(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4: –í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–û - —Ç–æ–ª—å–∫–æ –¥–æ 30 –º–∏–Ω—É—Ç)
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            if period == "today":
                date_filter = datetime.now().strftime("%Y-%m-%d")
                title = "–∑–∞ —Å–µ–≥–æ–¥–Ω—è"
                where_clause = "DATE(resolved_at) = ?"
            elif period == "week":
                date_filter = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
                title = "–∑–∞ –Ω–µ–¥–µ–ª—é"
                where_clause = "DATE(resolved_at) >= ?"
            else:
                date_filter = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
                title = "–∑–∞ –º–µ—Å—è—Ü"
                where_clause = "DATE(resolved_at) >= ?"
            
            # –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–æ 30 –º–∏–Ω—É—Ç
            cursor.execute(
                f"""
                SELECT AVG(response_time_seconds), 
                       MIN(response_time_seconds),
                       MAX(response_time_seconds),
                       COUNT(*)
                FROM error_reports 
                WHERE {where_clause} 
                AND response_time_seconds IS NOT NULL
                AND response_time_seconds <= 1800
                """,
                (date_filter,)
            )
            stats = cursor.fetchone()
            
            # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            cursor.execute(
                f"""
                SELECT 
                    SUM(CASE WHEN response_time_seconds < 120 THEN 1 ELSE 0 END) as under_2min,
                    SUM(CASE WHEN response_time_seconds BETWEEN 120 AND 300 THEN 1 ELSE 0 END) as from_2_5,
                    SUM(CASE WHEN response_time_seconds BETWEEN 300 AND 600 THEN 1 ELSE 0 END) as from_5_10,
                    SUM(CASE WHEN response_time_seconds BETWEEN 600 AND 1800 THEN 1 ELSE 0 END) as from_10_30
                FROM error_reports 
                WHERE {where_clause} 
                AND response_time_seconds IS NOT NULL
                AND response_time_seconds <= 1800
                """,
                (date_filter,)
            )
            distribution = cursor.fetchone()
            
            conn.close()
            
            if not stats or stats[3] == 0:
                return f"‚è± <b>–í–†–ï–ú–Ø –†–ï–ê–ö–¶–ò–ò {title.upper()}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
            
            avg_time, min_time, max_time, count = stats
            under_2, from_2_5, from_5_10, from_10_30 = distribution
            
            def format_time(seconds):
                if not seconds:
                    return "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
                m = int(seconds // 60)
                s = int(seconds % 60)
                return f"{m}–º {s}—Å"
            
            result = f"‚è± <b>–í–†–ï–ú–Ø –†–ï–ê–ö–¶–ò–ò {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            result += f"üìä <b>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ—à–∏–±–æ–∫:</b> {count}\n\n"
            
            result += f"üîπ –°—Ä–µ–¥–Ω–µ–µ: <b>{format_time(avg_time)}</b>\n"
            result += f"üü¢ –ë—ã—Å—Ç—Ä–µ–π—à–∏–π: {format_time(min_time)}\n"
            result += f"üî¥ –°–∞–º—ã–π –¥–æ–ª–≥–∏–π: {format_time(max_time)}\n\n"
            
            # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            result += "üìà <b>–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï:</b>\n\n"
            
            pct_under_2 = int((under_2 / count) * 100) if count > 0 else 0
            pct_2_5 = int((from_2_5 / count) * 100) if count > 0 else 0
            pct_5_10 = int((from_5_10 / count) * 100) if count > 0 else 0
            pct_10_30 = int((from_10_30 / count) * 100) if count > 0 else 0
            
            # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
            def bar(percentage):
                filled = int(percentage / 10)
                return "‚ñà" * filled + "‚ñë" * (10 - filled)
            
            result += f"üü¢ –î–æ 2 –º–∏–Ω:\n"
            result += f"   {bar(pct_under_2)} {under_2} ({pct_under_2}%)\n\n"
            
            result += f"üü° 2-5 –º–∏–Ω:\n"
            result += f"   {bar(pct_2_5)} {from_2_5} ({pct_2_5}%)\n\n"
            
            result += f"üü† 5-10 –º–∏–Ω:\n"
            result += f"   {bar(pct_5_10)} {from_5_10} ({pct_5_10}%)\n\n"
            
            result += f"üî¥ 10-30 –º–∏–Ω:\n"
            result += f"   {bar(pct_10_30)} {from_10_30} ({pct_10_30}%)\n\n"
            
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
analytics_service = AnalyticsService()


=== services/google_sheets_service.py ===
"""–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
import os
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import pytz
from dotenv import load_dotenv
from oauth2client.service_account import ServiceAccountCredentials
import gspread
from gspread.exceptions import WorksheetNotFound, APIError

from utils.logger import logger
from config.settings import settings
from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type,
    before_sleep_log
)
import logging
from gspread.exceptions import APIError
import aiohttp

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retry –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
API_RETRY_CONFIG = {
    'stop': stop_after_attempt(3),                    # –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
    'wait': wait_exponential(min=2, max=10),          # 2—Å, 4—Å, 8—Å
    'retry': retry_if_exception_type((
        APIError,                                      # Google Sheets API –æ—à–∏–±–∫–∏
        aiohttp.ClientError,                          # –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
        TimeoutError                                   # –¢–∞–π–º–∞—É—Ç—ã
    )),
    'before_sleep': before_sleep_log(logger, logging.WARNING)  # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
}

# –ó–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞
load_dotenv()


class GoogleSheetsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google Sheets —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞"""
        self.client = None
        self.spreadsheet = None
        self.sheet_id = os.getenv("GOOGLE_SHEETS_ID")
        self.credentials_file = os.getenv("GOOGLE_CREDENTIALS_FILE", "google_credentials.json")
        self.timezone = pytz.timezone('Europe/Kiev')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è ID —Ç–∞–±–ª–∏—Ü—ã
        if not self.sheet_id:
            logger.error("‚ùå GOOGLE_SHEETS_ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")
            return
        
        # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        if not self._authorize():
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Google Sheets")
            return
        
        logger.info("‚úÖ Google Sheets —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def _authorize(self) -> bool:
        """
        –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Google Sheets
        
        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ credentials
            if not os.path.exists(self.credentials_file):
                logger.error(f"‚ùå –§–∞–π–ª {self.credentials_file} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
                return False
            
            scope = [
                'https://spreadsheets.google.com/feeds',
                'https://www.googleapis.com/auth/drive'
            ]
            
            creds = ServiceAccountCredentials.from_json_keyfile_name(
                self.credentials_file, scope
            )
            
            self.client = gspread.authorize(creds)
            
            # –û—Ç–∫—Ä—ã—Ç–∏–µ —Ç–∞–±–ª–∏—Ü—ã
            self.spreadsheet = self.client.open_by_key(self.sheet_id)
            
            logger.info(f"‚úÖ Google Sheets –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: {self.spreadsheet.title}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google Sheets: {e}")
            return False
    
    def _get_week_range(self, date: datetime) -> tuple:
        """
        –ü–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-—Å—É–±–±–æ—Ç–∞)
        
        Args:
            date: –î–∞—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏
            
        Returns:
            (–Ω–∞—á–∞–ª–æ_–Ω–µ–¥–µ–ª–∏, –∫–æ–Ω–µ—Ü_–Ω–µ–¥–µ–ª–∏)
        """
        # –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
        start = date - timedelta(days=date.weekday())
        # –°—É–±–±–æ—Ç–∞ (5 –¥–Ω–µ–π –æ—Ç –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞)
        end = start + timedelta(days=5)
        
        return start, end
    
    def _get_week_title(self, start: datetime, end: datetime) -> str:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –¥–ª—è –Ω–µ–¥–µ–ª–∏
        
        Args:
            start: –ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏
            end: –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏
            
        Returns:
            –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–∞ "–ù–µ–¥–µ–ª—è 18-23 –ù–æ—è–±—Ä—è 2024"
        """
        months = {
            1: "–Ø–Ω–≤–∞—Ä—è", 2: "–§–µ–≤—Ä–∞–ª—è", 3: "–ú–∞—Ä—Ç–∞", 4: "–ê–ø—Ä–µ–ª—è",
            5: "–ú–∞—è", 6: "–ò—é–Ω—è", 7: "–ò—é–ª—è", 8: "–ê–≤–≥—É—Å—Ç–∞",
            9: "–°–µ–Ω—Ç—è–±—Ä—è", 10: "–û–∫—Ç—è–±—Ä—è", 11: "–ù–æ—è–±—Ä—è", 12: "–î–µ–∫–∞–±—Ä—è"
        }
        
        month_name = months[start.month]
        return f"–ù–µ–¥–µ–ª—è {start.day}-{end.day} {month_name} {start.year}"
    
    async def _create_weekly_sheet(self) -> Optional[object]:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –Ω–µ–¥–µ–ª–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        
        Returns:
            Worksheet –æ–±—ä–µ–∫—Ç –∏–ª–∏ None
        """
        if not self.client or not self.spreadsheet:
            return None
        
        try:
            now = datetime.now(self.timezone)
            start, end = self._get_week_range(now)
            title = self._get_week_title(start, end)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ª–∏—Å—Ç–∞
            try:
                worksheet = self.spreadsheet.worksheet(title)
                logger.info(f"üìã –õ–∏—Å—Ç '{title}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return worksheet
            except WorksheetNotFound:
                pass
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ª–∏—Å—Ç–∞
            worksheet = self.spreadsheet.add_worksheet(
                title=title,
                rows=100,
                cols=17
            )
            
            logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ª–∏—Å—Ç: {title}")
            
            # ===== –ó–ê–ì–û–õ–û–í–ö–ò (—Ç–æ–ª—å–∫–æ —Ç—Ä—É–±–∫–∏) =====
            headers = [
                ["‚Ññ", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ü–ù\n—Ç—Ä—É–±", "–í–¢\n—Ç—Ä—É–±", "–°–†\n—Ç—Ä—É–±", "–ß–¢\n—Ç—Ä—É–±", "–ü–¢\n—Ç—Ä—É–±", "–°–ë\n—Ç—Ä—É–±", "–ò—Ç–æ–≥–æ\n—Ç—Ä—É–±–æ–∫"]
            ]
            
            worksheet.update('A1:I1', headers)
            
            # ===== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï =====
            
            # –ó–∞–≥–æ–ª–æ–≤–∫–∏: —Å–∏–Ω–∏–π —Ñ–æ–Ω, –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç, –∂–∏—Ä–Ω—ã–π, —Ü–µ–Ω—Ç—Ä
            worksheet.format('A1:I1', {
                "backgroundColor": {"red": 0.2, "green": 0.4, "blue": 0.8},
                "textFormat": {"foregroundColor": {"red": 1, "green": 1, "blue": 1}, "bold": True},
                "horizontalAlignment": "CENTER",
                "verticalAlignment": "MIDDLE"
            })
            
            # –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            body = {
                "requests": [
                    # –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "COLUMNS", "startIndex": 0, "endIndex": 1}, "properties": {"pixelSize": 40}, "fields": "pixelSize"}},  # ‚Ññ
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "COLUMNS", "startIndex": 1, "endIndex": 2}, "properties": {"pixelSize": 120}, "fields": "pixelSize"}},  # –ú–µ–Ω–µ–¥–∂–µ—Ä
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "COLUMNS", "startIndex": 2, "endIndex": 9}, "properties": {"pixelSize": 70}, "fields": "pixelSize"}},  # –ü–ù-–°–ë + –ò—Ç–æ–≥–æ
                    
                    # –í—ã—Å–æ—Ç–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫)
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "ROWS", "startIndex": 0, "endIndex": 1}, "properties": {"pixelSize": 50}, "fields": "pixelSize"}},
                ]
            }
            self.spreadsheet.batch_update(body)
            
            # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —è—á–µ–µ–∫
            worksheet.format('A:I', {
                "horizontalAlignment": "CENTER",
                "verticalAlignment": "MIDDLE"
            })
            
            # –†–∞–º–∫–∏ –¥–ª—è –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã
            worksheet.format('A1:I100', {
                "borders": {
                    "top": {"style": "SOLID"},
                    "bottom": {"style": "SOLID"},
                    "left": {"style": "SOLID"},
                    "right": {"style": "SOLID"}
                }
            })
            
            logger.info(f"‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –ª–∏—Å—Ç—É '{title}'")
            return worksheet
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∞: {e}")
            return None
    
    @retry(**API_RETRY_CONFIG)
    async def _get_managers_stats(self, target_date: str) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –° –ê–í–¢–û–ü–û–í–¢–û–†–û–ú
        
        Args:
            target_date: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
            
        Returns:
            –°–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ (–≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
        """
        try:
            # ‚úÖ –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô –°–ü–ò–°–û–ö - –¢–û–õ–¨–ö–û –ü–ê–í–õ–û–ì–†–ê–î
            FIXED_MANAGERS = [
                "–ê–ª–ª–∞–¥–∏–Ω", "–ê–Ω—è", "–í–∞–Ω—è", "–í–æ–≤–∞", "–ì–∞–Ω–∂–∞", "–î–∏–∞–Ω–∞", 
                "–î–∏–¥–∏", "–î–∏–º–∞", "–î–æ–±—Ä—è–∫", "–î—Ä–æ–Ω", "–ï–≥–æ—Ä", "–ñ–µ–Ω—è",
                "–õ–µ—Ä–∞", "–õ–µ—Å—è", "–õ—ã—Å—ã–π", "–ú–∞—Ä–∏–∫", "–ú–∏—à–∞", "C–µ—Ä–≥–µ–π",
                "–¢—ë–º–∞", "–≠–ª—è", "–Ø—Ä–∏–∫"
            ]
            
            # ‚úÖ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ú–Å–ù
            NAME_MAP = {
                '–ª–µ—Ä–∞': '–õ–µ—Ä–∞',
                '—ç–ª—è': '–≠–ª—è',
                '–¥–∏–∞–Ω–∞': '–î–∏–∞–Ω–∞',
                'c–µ—Ä–≥–µ–π': 'C–µ—Ä–≥–µ–π',
                '—Å–µ—Ä–≥–µ–π': 'C–µ—Ä–≥–µ–π',
                '–ª–µ—Å—è': '–õ–µ—Å—è',
                '–¥–∏–¥–∏': '–î–∏–¥–∏',
                '–¥–æ–±—Ä—è–∫': '–î–æ–±—Ä—è–∫',
                '–¥–∏–º–∞': '–î–∏–º–∞',
                '–µ–≥–æ—Ä': '–ï–≥–æ—Ä',
                '–∞–ª–ª–∞–¥–∏–Ω': '–ê–ª–ª–∞–¥–∏–Ω',
                '–≤–∞–Ω—è': '–í–∞–Ω—è',
                '–∞–Ω—è': '–ê–Ω—è',
                '–≥–∞–Ω–∂–∞': '–ì–∞–Ω–∂–∞',
                '–º–∞—Ä–∏–∫': '–ú–∞—Ä–∏–∫',
                '–¥—Ä–æ–Ω': '–î—Ä–æ–Ω',
                '–ª—ã—Å—ã–π': '–õ—ã—Å—ã–π',
                '–∂–µ–Ω—è': '–ñ–µ–Ω—è',
                '—è—Ä–∏–∫': '–Ø—Ä–∏–∫',
                '–º–∏—à–∞': '–ú–∏—à–∞',
                '—Ç—ë–º–∞': '–¢—ë–º–∞',
                '—Ç–µ–º–∞': '–¢—ë–º–∞',
                '–≤–æ–≤–∞': '–í–æ–≤–∞',
                '—Å–µ—Ä–µ–≥–∞': 'C–µ—Ä–≥–µ–π',
                '–∞–ª–∞–¥–¥–∏–Ω': '–ê–ª–ª–∞–¥–∏–Ω',
                '–º–∞—Ä–∫': '–ú–∞—Ä–∏–∫',
            }
            
            from services.managers_stats_service import managers_stats_service
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–±–æ—á–µ–π —Ç–∞–±–ª–∏—Ü—ã
            raw_data = await managers_stats_service._fetch_managers_data()
            
            logger.info(f"üì• –ü–æ–ª—É—á–µ–Ω–æ {len(raw_data)} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ä–∞–±–æ—á–µ–π —Ç–∞–±–ª–∏—Ü—ã")
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
            stats_by_manager = {}
            unmatched_names = set()
            
            for row in raw_data:
                manager = row.get("–º–µ–Ω–µ–¥–∂–µ—Ä", "").strip()
                color = row.get("—Ü–≤–µ—Ç", "").strip()
                
                if not manager or not color:
                    continue
                
                # ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                manager_lower = manager.lower()
                normalized_name = NAME_MAP.get(manager_lower)
                
                if not normalized_name:
                    normalized_name = manager
                    unmatched_names.add(manager)
                
                if normalized_name not in stats_by_manager:
                    stats_by_manager[normalized_name] = {
                        "–ñ–ï–õ–¢–´–ô": 0,
                        "–ó–ï–õ–ï–ù–´–ô": 0,
                        "–§–ò–û–õ–ï–¢–û–í–´–ô": 0
                    }
                
                if color in stats_by_manager[normalized_name]:
                    stats_by_manager[normalized_name][color] += 1
            
            if unmatched_names:
                logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {unmatched_names}")
            
            # ‚úÖ –í–ê–ñ–ù–û: –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –í –§–ò–ö–°–ò–†–û–í–ê–ù–ù–û–ú –ü–û–†–Ø–î–ö–ï (–∞–ª—Ñ–∞–≤–∏—Ç)
            managers_data = []
            
            for manager_name in FIXED_MANAGERS:
                if manager_name in stats_by_manager:
                    colors = stats_by_manager[manager_name]
                    tubes = sum(colors.values())
                    green = colors["–ó–ï–õ–ï–ù–´–ô"]
                    purple = colors["–§–ò–û–õ–ï–¢–û–í–´–ô"]
                    yellow = colors["–ñ–ï–õ–¢–´–ô"]
                    
                    logger.info(f"üìä {manager_name}: {tubes} —Ç—Ä—É–±–æ–∫ (üü©{green} üü™{purple} üü®{yellow})")
                else:
                    tubes = 0
                    green = 0
                    purple = 0
                    yellow = 0
                
                managers_data.append({
                    "name": manager_name,
                    "tubes": tubes,
                    "green": green,
                    "yellow": yellow,
                    "purple": purple
                })
            
            logger.info(f"‚úÖ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–ø–∏—Å–æ–∫: {len(managers_data)} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (–∞–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)")
            return managers_data
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}")
            raise  # ‚úÖ –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è retry
            import traceback
            logger.error(traceback.format_exc())
            
            FIXED_MANAGERS = [
                "–ê–ª–ª–∞–¥–∏–Ω", "–ê–Ω—è", "–í–∞–Ω—è", "–í–æ–≤–∞", "–ì–∞–Ω–∂–∞", "–î–∏–∞–Ω–∞", 
                "–î–∏–¥–∏", "–î–∏–º–∞", "–î–æ–±—Ä—è–∫", "–î—Ä–æ–Ω", "–ï–≥–æ—Ä", "–ñ–µ–Ω—è",
                "–õ–µ—Ä–∞", "–õ–µ—Å—è", "–õ—ã—Å—ã–π", "–ú–∞—Ä–∏–∫", "–ú–∏—à–∞", "C–µ—Ä–≥–µ–π",
                "–¢—ë–º–∞", "–≠–ª—è", "–Ø—Ä–∏–∫"
            ]
            
            return [
                {"name": name, "tubes": 0, "green": 0, "yellow": 0, "purple": 0}
                for name in FIXED_MANAGERS
            ]
    
    @retry(**API_RETRY_CONFIG)
    async def update_stats(self):
        """
        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ Google Sheets –° –ê–í–¢–û–ü–û–í–¢–û–†–û–ú
        –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å (8:00-19:00, –ü–ù-–°–ë)
        
        ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: Retry –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏/API
        """
        if not self.client or not self.spreadsheet:
            raise Exception("Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        
        try:
            now = datetime.now(self.timezone)
            start, end = self._get_week_range(now)
            title = self._get_week_title(start, end)
            
            logger.info(f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞: {title}")
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞
            try:
                worksheet = self.spreadsheet.worksheet(title)
            except WorksheetNotFound:
                worksheet = await self._create_weekly_sheet()
                if not worksheet:
                    raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ª–∏—Å—Ç")
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
            current_date = now.strftime("%Y-%m-%d")
            managers_data = await self._get_managers_stats(current_date)
            
            if not managers_data:
                logger.warning("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
                return
        
            logger.info(f"üìã –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–∞–ª—Ñ–∞–≤–∏—Ç)")
            
            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
            weekday = now.weekday()
            days_names = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ']
            
            logger.info(f"üìÖ –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {now.strftime('%d.%m.%Y %H:%M')}")
            logger.info(f"üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: {days_names[weekday]} (weekday={weekday})")
            
            if weekday > 5:
                logger.info("üìÖ –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
                return
            
            # –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Ç—Ä—É–±–æ–∫
            tubes_col = 3 + weekday
            tubes_col_letter = chr(64 + tubes_col)
            
            col_names = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë']
            logger.info(f"üìä –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: {tubes_col_letter} ({col_names[weekday]})")
            
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            rows_data = []
            
            for idx, manager in enumerate(managers_data, start=2):
                name = manager.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                tubes = manager.get('tubes', 0)
                
                rows_data.append({
                    'row': idx,
                    'name': name,
                    'tubes': tubes
                })
            
            # ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ (BATCH UPDATE) =====
            
            updates = []
            
            # 1. –ù–æ–º–µ—Ä–∞ –∏ –∏–º–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
            names_range_values = []
            for idx, data in enumerate(rows_data, start=1):
                names_range_values.append([idx, data['name']])
            
            updates.append({
                'range': f'A2:B{len(rows_data)+1}',
                'values': names_range_values
            })
            
            # 2. –¢—Ä—É–±–∫–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
            tubes_values = [[data['tubes']] for data in rows_data]
            updates.append({
                'range': f'{tubes_col_letter}2:{tubes_col_letter}{len(rows_data)+1}',
                'values': tubes_values
            })
            
            logger.info(f"üìù –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–ª–æ–Ω–∫—É {tubes_col_letter}2:{tubes_col_letter}{len(rows_data)+1}")
            
            # 3. –§–æ—Ä–º—É–ª—ã –¥–ª—è "–ò—Ç–æ–≥–æ —Ç—Ä—É–±–æ–∫"
            formulas_total = [
                [f"=SUM(C{data['row']}:H{data['row']})"] 
                for data in rows_data
            ]
            updates.append({
                'range': f'I2:I{len(rows_data)+1}',
                'values': formulas_total
            })
            
            # 4. –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
            total_row = len(rows_data) + 2
            
            updates.append({
                'range': f'A{total_row}:B{total_row}',
                'values': [["", "–ò–¢–û–ì–û:"]]
            })
            
            for col in range(3, 9):
                col_letter = chr(64 + col)
                updates.append({
                    'range': f'{col_letter}{total_row}',
                    'values': [[f"=SUM({col_letter}2:{col_letter}{total_row-1})"]]
                })
            
            updates.append({
                'range': f'I{total_row}',
                'values': [[f"=SUM(I2:I{total_row-1})"]]
            })
            
            # 5. –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            time_row = total_row + 2
            current_time = now.strftime("%d.%m.%Y %H:%M")
            updates.append({
                'range': f'A{time_row}:I{time_row}',
                'values': [[f"üìä –û–±–Ω–æ–≤–ª–µ–Ω–æ: {current_time}", "", "", "", "", "", "", "", ""]]
            })
            
            # ===== –û–¢–ü–†–ê–í–ö–ê –í–°–ï–• –û–ë–ù–û–í–õ–ï–ù–ò–ô =====
            logger.info(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ {len(updates)} –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ–¥–Ω–∏–º –±–∞—Ç—á–µ–º...")
            
            worksheet.batch_update(updates, value_input_option='USER_ENTERED')
            
            # ===== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï =====
            
            worksheet.format(f'A{total_row}:I{total_row}', {
                "backgroundColor": {"red": 0.9, "green": 0.9, "blue": 0.9},
                "textFormat": {"bold": True},
                "horizontalAlignment": "CENTER"
            })
            
            worksheet.format(f'A{time_row}:I{time_row}', {
                "backgroundColor": {"red": 0.95, "green": 0.95, "blue": 0.95},
                "textFormat": {"italic": True, "fontSize": 9},
                "horizontalAlignment": "CENTER",
                "verticalAlignment": "MIDDLE"
            })
            
            merge_request = {
                "requests": [{
                    "mergeCells": {
                        "range": {
                            "sheetId": worksheet.id,
                            "startRowIndex": time_row - 1,
                            "endRowIndex": time_row,
                            "startColumnIndex": 0,
                            "endColumnIndex": 9
                        },
                        "mergeType": "MERGE_ALL"
                    }
                }]
            }
            self.spreadsheet.batch_update(merge_request)
            
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {len(rows_data)} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            import traceback
            logger.error(traceback.format_exc())
            raise  # ‚úÖ –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è retry
    
    async def create_weekly_sheet_if_needed(self):
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –Ω–µ–¥–µ–ª–∏ –µ—Å–ª–∏ –Ω–∞—Å—Ç—É–ø–∏–ª –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 00:01 –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        """
        if not self.client or not self.spreadsheet:
            logger.error("‚ùå Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        try:
            now = datetime.now(self.timezone)
            
            if now.weekday() != 0:
                logger.info("üìÖ –ù–µ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
                return
            
            await self._create_weekly_sheet()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞: {e}")


# ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
google_sheets_service = GoogleSheetsService()


=== services/management_service.py ===
"""
–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º (–º–µ–Ω–µ–¥–∂–µ—Ä—ã, —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏, —Ä–∞—Å—Å—ã–ª–∫–∞)
"""
from typing import List, Dict, Optional, Tuple
from telegram import Bot, error as telegram_error
from database.models import db
from config.settings import settings
from utils.logger import logger


class ManagementService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏, —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º–∏ –∏ —Ä–∞—Å—Å—ã–ª–æ–∫"""
    
    # ===== –ú–ï–ù–ï–î–ñ–ï–†–´ =====
    
    @staticmethod
    def add_manager(user_id: int, username: str = None, 
                   first_name: str = None, added_by: int = None) -> Tuple[bool, str]:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ –∞–¥–º–∏–Ω/–ø—É–ª—å—Ç
        if user_id in settings.ADMINS:
            return False, "‚ùå –≠—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä! –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Å–¥–µ–ª–∞—Ç—å –Ω–µ–ª—å–∑—è."
        
        if user_id in settings.PULT:
            return False, "‚ùå –≠—Ç–æ –ø—É–ª—å—Ç! –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Å–¥–µ–ª–∞—Ç—å –Ω–µ–ª—å–∑—è."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω —É–∂–µ
        if db.is_manager(user_id):
            return False, "‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º."
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
        success = db.add_manager(user_id, username, first_name, added_by)
        
        if success:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –ø–∞–º—è—Ç–∏ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
            if user_id not in settings.MANAGERS:
                settings.MANAGERS.append(user_id)
            return True, f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!\n\nID: {user_id}"
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞."
    
    @staticmethod
    def remove_manager(user_id: int) -> Tuple[bool, str]:
        """–£–¥–∞–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
        if not db.is_manager(user_id):
            return False, "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º."
        
        success = db.remove_manager(user_id)
        
        if success:
            # –£–¥–∞–ª—è–µ–º –∏–∑ –ø–∞–º—è—Ç–∏
            if user_id in settings.MANAGERS:
                settings.MANAGERS.remove(user_id)
            return True, f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä —É–¥–∞–ª—ë–Ω!\n\nID: {user_id}"
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞."
    
    @staticmethod
    def get_managers_list() -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
        managers = db.get_all_managers()
        
        if not managers:
            return "üìã –°–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø—É—Å—Ç."
        
        text = f"üë• <b>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã ({len(managers)}):</b>\n\n"
        
        for i, m in enumerate(managers, 1):
            username = f"@{m['username']}" if m['username'] else "–±–µ–∑ username"
            name = m['first_name'] or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            text += f"{i}. <b>{name}</b> ({username})\n"
            text += f"   ID: <code>{m['user_id']}</code>\n\n"
        
        return text
    
    # ===== –¢–ï–õ–ï–§–û–ù–ò–ò =====
    
    @staticmethod
    def add_telephony(name: str, code: str, tel_type: str, 
                     group_id: int, created_by: int = None) -> Tuple[bool, str]:
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é"""
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not name or not code:
            return False, "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!"
        
        if tel_type not in ['white', 'black']:
            return False, "‚ùå –¢–∏–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 'white' –∏–ª–∏ 'black'!"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ group_id –≤–∞–ª–∏–¥–Ω—ã–π
        if not str(group_id).startswith('-'):
            return False, "‚ùå ID –≥—Ä—É–ø–ø—ã –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å '-' (–Ω–∞–ø—Ä–∏–º–µ—Ä: -1001234567890)"
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
        success = db.add_telephony(name, code, tel_type, group_id, created_by)
        
        if success:
            type_emoji = "‚ö™Ô∏è" if tel_type == "white" else "‚ö´Ô∏è"
            type_name = "–ë–µ–ª–∞—è (—Å –∫–Ω–æ–ø–∫–∞–º–∏)" if tel_type == "white" else "–ß—ë—Ä–Ω–∞—è (–±–µ–∑ –∫–Ω–æ–ø–æ–∫)"
            
            return True, (
                f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!\n\n"
                f"üìû –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{name}</b>\n"
                f"üîë –ö–æ–¥: <code>{code}</code>\n"
                f"{type_emoji} –¢–∏–ø: {type_name}\n"
                f"üí¨ –ì—Ä—É–ø–ø–∞: <code>{group_id}</code>"
            )
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞: —Ç–∞–∫–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è –∏–ª–∏ –∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    
    @staticmethod
    def remove_telephony(code: str) -> Tuple[bool, str]:
        """–£–¥–∞–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é"""
        tel = db.get_telephony_by_code(code)
        
        if not tel:
            return False, f"‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω–∏—è —Å –∫–æ–¥–æ–º '{code}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
        
        success = db.remove_telephony(code)
        
        if success:
            return True, f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞!\n\nüìû {tel['name']} ({code})"
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏."
    
    @staticmethod
    def get_telephonies_list() -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π"""
        telephonies = db.get_all_telephonies()
        
        if not telephonies:
            return "üìã –°–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π –ø—É—Å—Ç."
        
        text = f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω–∏–∏ ({len(telephonies)}):</b>\n\n"
        
        for i, tel in enumerate(telephonies, 1):
            type_emoji = "‚ö™Ô∏è" if tel['type'] == "white" else "‚ö´Ô∏è"
            type_name = "–ë–µ–ª–∞—è" if tel['type'] == "white" else "–ß—ë—Ä–Ω–∞—è"
            
            text += f"{i}. {type_emoji} <b>{tel['name']}</b>\n"
            text += f"   –ö–æ–¥: <code>{tel['code']}</code>\n"
            text += f"   –¢–∏–ø: {type_name}\n"
            text += f"   –ì—Ä—É–ø–ø–∞: <code>{tel['group_id']}</code>\n\n"
        
        return text
    
    # ===== –†–ê–°–°–´–õ–ö–ê =====
    
    @staticmethod
    async def broadcast_message(bot: Bot, message, sent_by: int) -> Dict:
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É –≤—Å–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º"""
        managers = db.get_all_managers()
        
        stats = {
            "total": len(managers),
            "success": 0,
            "failed": 0,
            "failed_ids": []
        }
        
        for manager in managers:
            user_id = manager['user_id']
            
            try:
                # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É
                await message.copy(chat_id=user_id)
                stats["success"] += 1
                logger.info(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ user_id={user_id}")
                
            except telegram_error.TelegramError as e:
                stats["failed"] += 1
                stats["failed_ids"].append(user_id)
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É user_id={user_id}: {e}")
        
        logger.info(
            f"üìä –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {stats['success']}/{stats['total']} —É—Å–ø–µ—à–Ω–æ"
        )
        
        return stats


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
management_service = ManagementService()


=== services/managers_stats_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ Google Sheets - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
"""
from datetime import datetime, timezone, timedelta
from typing import Dict, List
import aiohttp
from config.settings import settings
from utils.logger import logger


class ManagersStatsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ü–∞–≤–ª–æ–≥—Ä–∞–¥–∞"""
    
    async def get_managers_stats(self) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –≤ —Å—Ç–∏–ª–µ –¥–∞—à–±–æ—Ä–¥–∞
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            data = await self._fetch_managers_data()
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
            stats_by_manager = self._group_by_manager(data)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω–æ–≤–æ–º —Å—Ç–∏–ª–µ
            result = self._format_stats_dashboard(stats_by_manager)
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"
    
    async def _fetch_managers_data(self) -> List[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ Google Sheets"""
        url = settings.GOOGLE_APPS_SCRIPT_URL
        
        if not url:
            raise ValueError("GOOGLE_APPS_SCRIPT_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä action=managers
        if '?' in url:
            url += '&action=managers'
        else:
            url += '?action=managers'
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as response:
                    if response.status != 200:
                        logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status}")
                        raise Exception(f"HTTP {response.status}")
                    
                    data = await response.json()
                    
                    if isinstance(data, dict) and 'error' in data:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–∫—Ä–∏–ø—Ç–∞: {data['error']}")
                        raise Exception(data['error'])
                    
                    logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(data)} –∑–∞–ø–∏—Å–µ–π –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
                    return data
                    
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}", exc_info=True)
            raise
    
    def _group_by_manager(self, data: List[Dict]) -> Dict[str, Dict[str, int]]:
        """–ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –∏ —Ü–≤–µ—Ç–∞–º"""
        stats = {}
        
        for row in data:
            manager = row.get("–º–µ–Ω–µ–¥–∂–µ—Ä", "").strip()
            color = row.get("—Ü–≤–µ—Ç", "").strip()
            
            if not manager or not color:
                continue
            
            if manager not in stats:
                stats[manager] = {
                    "–ñ–ï–õ–¢–´–ô": 0,
                    "–ó–ï–õ–ï–ù–´–ô": 0,
                    "–§–ò–û–õ–ï–¢–û–í–´–ô": 0
                }
            
            if color in stats[manager]:
                stats[manager][color] += 1
        
        return stats
    
    def _format_stats_dashboard(self, stats: Dict[str, Dict[str, int]]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Å—Ç–∏–ª–µ –¥–∞—à–±–æ—Ä–¥–∞ –æ—à–∏–±–æ–∫
        
        Args:
            stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
            
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        """
        kiev_tz = timezone(timedelta(hours=2))
        current_time = datetime.now(kiev_tz).strftime("%H:%M")
        
        COLOR_EMOJI = {
            "–ñ–ï–õ–¢–´–ô": "üü®",
            "–ó–ï–õ–ï–ù–´–ô": "üü©",
            "–§–ò–û–õ–ï–¢–û–í–´–ô": "üü™"
        }
        
        if not stats:
            return f"üë• <b>–ú–ï–ù–ï–î–ñ–ï–†–´ (–ü–ê–í–õ–û–ì–†–ê–î) –Ω–∞ {current_time}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)
        sorted_managers = sorted(
            stats.items(),
            key=lambda x: sum(x[1].values()),
            reverse=True
        )
        
        # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ
        total_calls = sum(sum(colors.values()) for colors in stats.values())
        
        result = f"üë• <b>–ú–ï–ù–ï–î–ñ–ï–†–´ (–ü–ê–í–õ–û–ì–†–ê–î) –Ω–∞ {current_time}</b>\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        result += f"üìä <b>–û–ë–©–ï–ï:</b>\n"
        result += f"‚Ä¢ –í—Å–µ–≥–æ —Ç—Ä—É–±–æ–∫: <b>{total_calls}</b>\n"
        result += f"‚Ä¢ –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {len(stats)}\n\n"
        
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        for i, (manager, colors) in enumerate(sorted_managers, 1):
            total = sum(colors.values())
            
            if total == 0:
                continue
            
            green = colors["–ó–ï–õ–ï–ù–´–ô"]
            yellow = colors["–ñ–ï–õ–¢–´–ô"]
            purple = colors["–§–ò–û–õ–ï–¢–û–í–´–ô"]
            
            # –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            percentage = int((total / total_calls) * 100) if total_calls > 0 else 0
            
            # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            filled = int(percentage / 10) if percentage <= 100 else 10
            bar = "‚ñà" * filled + "‚ñë" * (10 - filled)
            
            result += f"<b>{i}. {manager}</b> - {total} —Ç—Ä—É–±–æ–∫\n"
            result += f"{bar} {percentage}%\n"
            
            # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ü–≤–µ—Ç–∞–º (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å)
            colors_line = []
            if green > 0:
                green_pct = int((green / total) * 100)
                colors_line.append(f"{COLOR_EMOJI['–ó–ï–õ–ï–ù–´–ô']} {green} ({green_pct}%)")
            if yellow > 0:
                yellow_pct = int((yellow / total) * 100)
                colors_line.append(f"{COLOR_EMOJI['–ñ–ï–õ–¢–´–ô']} {yellow} ({yellow_pct}%)")
            if purple > 0:
                purple_pct = int((purple / total) * 100)
                colors_line.append(f"{COLOR_EMOJI['–§–ò–û–õ–ï–¢–û–í–´–ô']} {purple} ({purple_pct}%)")
            
            if colors_line:
                result += "‚Ä¢ " + " | ".join(colors_line) + "\n"
            
            result += "\n"
        
        # –ò—Ç–æ–≥–∏ –ø–æ —Ü–≤–µ—Ç–∞–º
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        total_green = sum(m["–ó–ï–õ–ï–ù–´–ô"] for m in stats.values())
        total_yellow = sum(m["–ñ–ï–õ–¢–´–ô"] for m in stats.values())
        total_purple = sum(m["–§–ò–û–õ–ï–¢–û–í–´–ô"] for m in stats.values())
        
        result += f"üé® <b>–ò–¢–û–ì–û –ü–û –¶–í–ï–¢–ê–ú:</b>\n"
        
        if total_green > 0:
            green_pct = int((total_green / total_calls) * 100)
            result += f"{COLOR_EMOJI['–ó–ï–õ–ï–ù–´–ô']} –ó–µ–ª—ë–Ω—ã–µ: {total_green} ({green_pct}%)\n"
        
        if total_yellow > 0:
            yellow_pct = int((total_yellow / total_calls) * 100)
            result += f"{COLOR_EMOJI['–ñ–ï–õ–¢–´–ô']} –ñ—ë–ª—Ç—ã–µ: {total_yellow} ({yellow_pct}%)\n"
        
        if total_purple > 0:
            purple_pct = int((total_purple / total_calls) * 100)
            result += f"{COLOR_EMOJI['–§–ò–û–õ–ï–¢–û–í–´–ô']} –§–∏–æ–ª–µ—Ç–æ–≤—ã–µ: {total_purple} ({purple_pct}%)\n"
        
        return result


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
managers_stats_service = ManagersStatsService()


=== services/scheduler_service.py ===
"""
–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: services/scheduler_service.py
–° —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –∞–¥–º–∏–Ω—É –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
"""
import asyncio
from datetime import datetime
import pytz
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger
from telegram import Bot

from utils.logger import logger
from utils.notifications import notification_service
from config.settings import settings


class SchedulerService:
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
        self.scheduler = BackgroundScheduler(timezone=pytz.timezone('Europe/Kiev'))
        self.timezone = pytz.timezone('Europe/Kiev')
        self._jobs_added = False
        self._last_update_success = None
        self._update_count = 0
        self._error_count = 0
        self._consecutive_errors = 0  # ‚úÖ –ù–û–í–û–ï: –°—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥
        self._bot = None  # ‚úÖ –ù–û–í–û–ï: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    
    def set_bot(self, bot: Bot):
        """
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram –±–æ—Ç–∞
        """
        self._bot = bot
        logger.info("‚úÖ –ë–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
    
    def _run_async_task(self, coro):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ"""
        loop = None
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(coro)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: {e}")
            raise
        finally:
            if loop is not None:
                try:
                    loop.close()
                except Exception as e:
                    logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è event loop: {e}")
    
    def _update_stats_job(self):
        """–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –° –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø–ú–ò"""
        try:
            from services.google_sheets_service import google_sheets_service
            
            now = datetime.now(self.timezone)
            logger.info(f"‚è∞ –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é ({now.strftime('%H:%M')})")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            if not google_sheets_service.client or not google_sheets_service.spreadsheet:
                logger.error("‚ùå Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
                self._error_count += 1
                self._consecutive_errors += 1
                
                # ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ 3 –æ—à–∏–±–∫–∏ –ø–æ–¥—Ä—è–¥
                if self._consecutive_errors >= 3 and self._bot:
                    self._send_critical_notification(
                        "Google Sheets –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                        f"{self._consecutive_errors} –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"
                    )
                return
            
            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å retry –≤–Ω—É—Ç—Ä–∏)
            self._run_async_task(google_sheets_service.update_stats())
            
            # ‚úÖ –£–°–ü–ï–• - –û–±–Ω—É–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
            if self._consecutive_errors >= 3:
                # –ë—ã–ª–æ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫, –Ω–æ —Ç–µ–ø–µ—Ä—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å - —É–≤–µ–¥–æ–º–ª—è–µ–º
                if self._bot:
                    self._send_recovery_notification("Google Sheets –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ")
            
            self._consecutive_errors = 0  # –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞
            self._last_update_success = now
            self._update_count += 1
            
            logger.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ (–≤—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {self._update_count})")
            
        except Exception as e:
            self._error_count += 1
            self._consecutive_errors += 1
            
            error_msg = str(e)
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {error_msg}")
            logger.error(f"‚ö†Ô∏è –û—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥: {self._consecutive_errors}, –≤—Å–µ–≥–æ: {self._error_count}")
            
            # ‚úÖ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ø–æ—Å–ª–µ 3 –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥
            if self._consecutive_errors >= 3 and self._bot:
                additional_info = (
                    f"‚Ä¢ –í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {self._update_count}\n"
                    f"‚Ä¢ –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: {self._error_count}\n"
                    f"‚Ä¢ –û—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥: {self._consecutive_errors}"
                )
                
                self._send_critical_notification(
                    "Google Sheets –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
                    error_msg,
                    additional_info
                )
            
            # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
            if self._consecutive_errors >= 5:
                logger.warning(f"‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: {self._consecutive_errors} –æ—à–∏–±–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥!")
    
    def _create_weekly_sheet_job(self):
        """–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ª–∏—Å—Ç–∞"""
        try:
            from services.google_sheets_service import google_sheets_service
            
            now = datetime.now(self.timezone)
            logger.info(f"‚è∞ –ó–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∞ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–∏ ({now.strftime('%Y-%m-%d %H:%M')})")
            
            if not google_sheets_service.client or not google_sheets_service.spreadsheet:
                logger.error("‚ùå Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
                
                if self._bot:
                    self._send_critical_notification(
                        "–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–µ–¥–µ–ª–∏",
                        "Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
                    )
                return
            
            self._run_async_task(google_sheets_service.create_weekly_sheet_if_needed())
            
            logger.info("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞/—Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∞: {e}")
            
            if self._bot:
                self._send_critical_notification(
                    "–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–µ–¥–µ–ª–∏",
                    str(e)
                )
    
    def _reset_sips_job(self):
        """–ó–∞–¥–∞—á–∞ —Å–±—Ä–æ—Å–∞ SIP (–∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ 8:00)"""
        try:
            from database.models import db
            
            now = datetime.now(self.timezone)
            logger.info(f"‚è∞ –ó–∞–ø—É—Å–∫ —Å–±—Ä–æ—Å–∞ SIP ({now.strftime('%Y-%m-%d %H:%M')})")
            
            affected = db.reset_all_sips()
            
            if affected > 0:
                logger.info(f"‚úÖ –°–±—Ä–æ—à–µ–Ω–æ {affected} SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
            else:
                logger.info("‚ÑπÔ∏è SIP —É–∂–µ –±—ã–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã —Ä–∞–Ω–µ–µ")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏ —Å–±—Ä–æ—Å–∞ SIP: {e}")
            
            if self._bot:
                self._send_critical_notification(
                    "–°–±—Ä–æ—Å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤",
                    str(e)
                )
    
    def _send_critical_notification(
        self,
        error_type: str,
        error_msg: str,
        additional_info: str = None
    ):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É"""
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(
                notification_service.notify_critical_error(
                    bot=self._bot,
                    error_type=error_type,
                    details=error_msg,
                    additional_info=additional_info
                )
            )
            loop.close()
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {e}")
    
    def _send_recovery_notification(self, service_name: str):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏"""
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(
                notification_service.notify_recovery(
                    bot=self._bot,
                    service_name=service_name
                )
            )
            loop.close()
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")
    
    def add_jobs(self):
        """–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
        if self._jobs_added:
            logger.warning("‚ö†Ô∏è –ó–∞–¥–∞—á–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫")
            return
        
        try:
            # ===== –ó–ê–î–ê–ß–ê 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ =====
            self.scheduler.add_job(
                func=self._update_stats_job,
                trigger=CronTrigger(
                    day_of_week='mon-sat',
                    hour='8-19',
                    minute=0,
                    timezone=self.timezone
                ),
                id='update_stats',
                name='–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ Google Sheets',
                replace_existing=True,
                max_instances=1
            )
            
            # ===== –ó–ê–î–ê–ß–ê 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ª–∏—Å—Ç–∞ =====
            self.scheduler.add_job(
                func=self._create_weekly_sheet_job,
                trigger=CronTrigger(
                    day_of_week='mon',
                    hour=0,
                    minute=1,
                    timezone=self.timezone
                ),
                id='create_weekly_sheet',
                name='–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–∏',
                replace_existing=True,
                max_instances=1
            )
            
            # ===== –ó–ê–î–ê–ß–ê 3: –°–±—Ä–æ—Å SIP =====
            self.scheduler.add_job(
                func=self._reset_sips_job,
                trigger=CronTrigger(
                    day_of_week='mon-sat',
                    hour=8,
                    minute=0,
                    timezone=self.timezone
                ),
                id='reset_sips',
                name='–°–±—Ä–æ—Å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤',
                replace_existing=True,
                max_instances=1
            )
            
            self._jobs_added = True
            logger.info("‚úÖ –ó–∞–¥–∞—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫")
            logger.info("‚úÖ –ó–∞–¥–∞—á–∞ —Å–±—Ä–æ—Å–∞ SIP –¥–æ–±–∞–≤–ª–µ–Ω–∞ (8:00, –ü–ù-–°–ë)")
        
            self._print_jobs_info()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á: {e}")
    
    def _print_jobs_info(self):
        """–í—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö"""
        jobs = self.scheduler.get_jobs()
        logger.info(f"üìã –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–¥–∞—á: {len(jobs)}")
        
        for job in jobs:
            try:
                if hasattr(job, 'next_run_time') and job.next_run_time:
                    next_run = job.next_run_time.strftime("%Y-%m-%d %H:%M:%S")
                    logger.info(f"  ‚è∞ {job.name}: {next_run}")
                else:
                    logger.info(f"  ‚è∞ {job.name}: (–≤—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ)")
            except Exception:
                logger.info(f"  ‚è∞ {job.name}: (–æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏)")
    
    def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
        try:
            if not self._jobs_added:
                self.add_jobs()
            
            if not self.scheduler.running:
                self.scheduler.start()
                logger.info("üöÄ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –∑–∞–ø—É—â–µ–Ω")
                logger.info("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å (8:00-19:00, –ü–ù-–°–ë)")
                logger.info("üìã –ù–æ–≤—ã–π –ª–∏—Å—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 00:01")
                logger.info("üîÑ SIP –±—É–¥—É—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ 8:00 (–ü–ù-–°–ë)")
                logger.info("üì® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∞–¥–º–∏–Ω–∞–º")
            else:
                logger.warning("‚ö†Ô∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: {e}")
    
    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
        try:
            if self.scheduler.running:
                self.scheduler.shutdown()
                logger.info("‚èπÔ∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
                if self._update_count > 0:
                    logger.info(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:")
                    logger.info(f"  ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {self._update_count}")
                    logger.info(f"  ‚ùå –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: {self._error_count}")
                    if self._last_update_success:
                        logger.info(f"  ‚è∞ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {self._last_update_success.strftime('%Y-%m-%d %H:%M')}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: {e}")
    
    def run_update_now(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
        logger.info("üîÑ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
        self._update_stats_job()
    
    def get_stats(self) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
        return {
            'running': self.scheduler.running,
            'update_count': self._update_count,
            'error_count': self._error_count,
            'consecutive_errors': self._consecutive_errors,
            'last_update': self._last_update_success.strftime('%Y-%m-%d %H:%M') if self._last_update_success else None,
            'jobs_count': len(self.scheduler.get_jobs()) if self.scheduler else 0
        }
    
    def get_next_run_time(self, job_id: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á–∏"""
        try:
            job = self.scheduler.get_job(job_id)
            if job and hasattr(job, 'next_run_time') and job.next_run_time:
                return job.next_run_time.strftime('%Y-%m-%d %H:%M:%S')
        except Exception:
            pass
        return None


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
scheduler_service = SchedulerService()


=== services/stats_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏–∑ Google Sheets —á–µ—Ä–µ–∑ Apps Script
"""
from datetime import datetime, timezone, timedelta
from typing import Dict, List
import aiohttp
from config.settings import settings
from utils.logger import logger


class StatsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤ –∏–∑ Google Sheets"""
    
    async def get_perezvoni_stats(self) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∏–∑ Google Sheets
        
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            data = await self._fetch_sheet_data()
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–æ–¥–∞–º
            stats_by_city = self._group_by_city(data)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result = self._format_stats(stats_by_city)
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ Google Sheets"
    
    async def _fetch_sheet_data(self) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets —á–µ—Ä–µ–∑ Apps Script
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫
        """
        url = settings.GOOGLE_APPS_SCRIPT_URL
        
        if not url:
            logger.error("‚ùå GOOGLE_APPS_SCRIPT_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")
            raise ValueError("GOOGLE_APPS_SCRIPT_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as response:
                    if response.status != 200:
                        logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status}")
                        raise Exception(f"HTTP {response.status}")
                    
                    data = await response.json()
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É –æ—Ç —Å–∫—Ä–∏–ø—Ç–∞
                    if isinstance(data, dict) and 'error' in data:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–∫—Ä–∏–ø—Ç–∞: {data['error']}")
                        raise Exception(data['error'])
                    
                    logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(data)} –∑–∞–ø–∏—Å–µ–π –∏–∑ Google Sheets")
                    return data
                    
        except aiohttp.ClientError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞: {e}", exc_info=True)
            raise
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}", exc_info=True)
            raise
    
    def _group_by_city(self, data: List[Dict]) -> Dict[str, Dict[str, int]]:
        """
        –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –≥–æ—Ä–æ–¥–∞–º –∏ —Ü–≤–µ—Ç–∞–º
        
        Args:
            data: –î–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å {–≥–æ—Ä–æ–¥: {—Ü–≤–µ—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}}
        """
        stats = {}
        
        for row in data:
            city = row.get("–≥–æ—Ä–æ–¥", "").strip()
            color = row.get("—Ü–≤–µ—Ç", "").strip()
            
            if not city or not color:
                continue
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
            if city not in stats:
                stats[city] = {
                    "–ñ–ï–õ–¢–´–ô": 0,
                    "–ó–ï–õ–ï–ù–´–ô": 0,
                    "–§–ò–û–õ–ï–¢–û–í–´–ô": 0
                }
            
            if color in stats[city]:
                stats[city][color] += 1
        
        return stats
    
    def _format_stats(self, stats: Dict[str, Dict[str, int]]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç
        
        Args:
            stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
            
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        """
        # –ö–∏–µ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è (UTC+2 –∑–∏–º–æ–π)
        kiev_tz = timezone(timedelta(hours=2))
        current_time = datetime.now(kiev_tz).strftime("%H:%M")
        
        # –≠–º–æ–¥–∑–∏ –¥–ª—è —Ü–≤–µ—Ç–æ–≤
        COLOR_EMOJI = {
            "–ñ–ï–õ–¢–´–ô": "üü®",
            "–ó–ï–õ–ï–ù–´–ô": "üü©",
            "–§–ò–û–õ–ï–¢–û–í–´–ô": "üü™"
        }
        
        # –ü–æ—Ä—è–¥–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
        city_order = ["–ü–∞–≤–ª–æ–≥—Ä–∞–¥", "–•–∞—Ä—å–∫–æ–≤", "–î–Ω–µ–ø—Ä"]
        
        result = f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫ –Ω–∞ {current_time}</b>\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        
        for city in city_order:
            if city not in stats:
                continue
            
            city_stats = stats[city]
            total = sum(city_stats.values())
            
            if total == 0:
                continue
            
            green = city_stats["–ó–ï–õ–ï–ù–´–ô"]
            yellow = city_stats["–ñ–ï–õ–¢–´–ô"]
            purple = city_stats["–§–ò–û–õ–ï–¢–û–í–´–ô"]
            
            green_pct = int((green / total) * 100) if total > 0 else 0
            yellow_pct = int((yellow / total) * 100) if total > 0 else 0
            purple_pct = int((purple / total) * 100) if total > 0 else 0

            
            result += f"<b>{city}:</b> {total}\n"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç–∞ –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å (–±–æ–ª—å—à–µ 0)
            colors_to_show = []
            if green > 0:
                colors_to_show.append(f"{green}{COLOR_EMOJI['–ó–ï–õ–ï–ù–´–ô']}({green_pct}%)")
            if yellow > 0:
                colors_to_show.append(f"{yellow}{COLOR_EMOJI['–ñ–ï–õ–¢–´–ô']}({yellow_pct}%)")
            if purple > 0:
                colors_to_show.append(f"{purple}{COLOR_EMOJI['–§–ò–û–õ–ï–¢–û–í–´–ô']}({purple_pct}%)")
            
            result += " ".join(colors_to_show) + "\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        
        return result


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
stats_service = StatsService()


=== services/telephony_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∏–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—à–∏–±–æ–∫
"""
from telegram import Update, error as telegram_error
from telegram.ext import ContextTypes

from config.settings import settings
from config.constants import TEL_CODES_REVERSE, MESSAGES
from keyboards.inline import get_support_keyboard
from database.models import db
from utils.logger import logger
from utils.state import is_tel_choice_expired, clear_tel_choice, get_tel_choice


class TelephonyService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∏–µ–π"""
    
    @staticmethod
    def get_group_id(tel_name: str) -> int:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –≥—Ä—É–ø–ø—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
        Args:
            tel_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            
        Returns:
            ID –≥—Ä—É–ø–ø—ã –∏–ª–∏ None
        """
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î
        telephonies = db.get_all_telephonies()
        for tel in telephonies:
            if tel['name'] == tel_name:
                return tel['group_id']
        
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏–∑ settings
        telephony_groups = settings.get_telephony_groups()
        return telephony_groups.get(tel_name)
    
    @staticmethod
    def get_tel_name_from_code(tel_code: str) -> str:
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∫–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ
        
        Args:
            tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (bmw, zvon)
            
        Returns:
            –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏–ª–∏ "Unknown"
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î
        tel = db.get_telephony_by_code(tel_code)
        if tel:
            return tel['name']
        
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ
        return TEL_CODES_REVERSE.get(tel_code, "Unknown")
    
    @staticmethod
    async def send_error_to_group(
        bot,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE,
        group_id: int,
        tel_code: str,
        username: str,
        error_text: str
    ) -> bool:
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É –≤ –≥—Ä—É–ø–ø—É —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            update: Update –æ–±—ä–µ–∫—Ç
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç
            group_id: ID –≥—Ä—É–ø–ø—ã
            tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            error_text: –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
            
        Returns:
            True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞
        """
        user_id = update.effective_user.id
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        msg = f"–û—Ç: {username}\n{error_text}"
        
        # –ö–Ω–æ–ø–∫–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏)
        keyboard = get_support_keyboard(user_id, tel_code)
        
        try:
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            sent_msg = await bot.send_message(
                chat_id=group_id,
                text=msg,
                reply_markup=keyboard
            )
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if update.message.photo:
                await bot.send_photo(
                    chat_id=group_id,
                    photo=update.message.photo[-1].file_id,
                    reply_to_message_id=sent_msg.message_id
                )
                logger.info(f"üì∏ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ –∫ –æ—à–∏–±–∫–µ")
            elif update.message.document:
                await bot.send_document(
                    chat_id=group_id,
                    document=update.message.document.file_id,
                    reply_to_message_id=sent_msg.message_id
                )
                logger.info(f"üìé –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç –∫ –æ—à–∏–±–∫–µ")
            
            # –õ–æ–≥–∏—Ä—É–µ–º –≤ –ë–î
            db.log_error_report(user_id, username, tel_code, error_text)
            
            logger.info(f"‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –≥—Ä—É–ø–ø—É {group_id} –æ—Ç user_id={user_id}")
            return True
            
        except telegram_error.TelegramError as e:
            logger.error(f"‚ùå Telegram error –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –≥—Ä—É–ø–ø—É {group_id}: {e}", exc_info=True)
            return False
        except Exception as e:
            logger.error(f"‚ùå Unexpected error –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—à–∏–±–∫–∏: {e}", exc_info=True)
            return False
    
    @staticmethod
    def validate_error_text(error_text: str, has_media: bool) -> tuple:
        """
        –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        
        Args:
            error_text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            has_media: –ï—Å—Ç—å –ª–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª—ã
            
        Returns:
            (is_valid: bool, error_message: str)
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
        if len(error_text) > 1000:
            return False, MESSAGES["error_too_long"].format(length=len(error_text))
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
        if len(error_text.strip()) == 0 and not has_media:
            return False, MESSAGES["error_empty"]
        
        return True, None
    
    @staticmethod
    def get_success_message(tel_code: str, tel_name: str) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
        Args:
            tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            tel_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            
        Returns:
            –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        tel = db.get_telephony_by_code(tel_code)
        
        if tel:
            # –ò–∑ –ë–î
            if tel['type'] == 'black':
                return MESSAGES["error_sent_zvon"].format(tel=tel_name)
            else:
                return MESSAGES["error_sent_bmw"].format(tel=tel_name)
        else:
            # –°—Ç–∞—Ä—ã–µ
            if tel_code == "zvon":
                return MESSAGES["error_sent_zvon"].format(tel=tel_name)
            else:
                return MESSAGES["error_sent_bmw"].format(tel=tel_name)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
telephony_service = TelephonyService()


=== services/user_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
"""
from config.settings import settings
from database.models import db
from utils.logger import logger


class UserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∏—Ö –ø—Ä–∞–≤–∞–º–∏"""
    
    @staticmethod
    def has_access(user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            True –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ .env (–∞–¥–º–∏–Ω—ã, –ø—É–ª—å—Ç, —Å—Ç–∞—Ä—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã)
        if user_id in settings.MANAGERS:
            return True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î (–Ω–æ–≤—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã)
        return db.is_manager(user_id)
    
    @staticmethod
    def is_admin(user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
        """
        return user_id in settings.ADMINS
    
    @staticmethod
    def is_pult(user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–ª—å—Ç–æ–º
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–ª—å—Ç
        """
        return user_id in settings.PULT
    
    @staticmethod
    def log_access_denied(user_id: int):
        """
        –õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫—É –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –ø—Ä–∞–≤
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        logger.warning(f"‚ùå –û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ –¥–ª—è user_id={user_id}")
    
    @staticmethod
    def log_user_start(user_id: int, username: str, role: str):
        """
        –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            role: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        logger.info(f"‚úÖ {role.capitalize()} {user_id} ({username}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
user_service = UserService()


=== scripts/add_db_indexes.py ===
#!/usr/bin/env python3
"""
–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
"""
import sqlite3
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ PYTHONPATH
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils.logger import logger


def add_indexes():
    """–î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –≤ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    logger.info("üîÑ –ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î...")
    
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã error_reports
    indexes_to_create = [
        # –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ)
        ("idx_error_reports_created_at", "error_reports", "created_at"),
        
        # –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ —Ä–µ—à–µ–Ω–∏—è
        ("idx_error_reports_resolved_at", "error_reports", "resolved_at"),
        
        # –î–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        ("idx_error_reports_telephony", "error_reports", "telephony_code"),
        
        # –î–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
        ("idx_error_reports_user", "error_reports", "user_id"),
        
        # –î–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –ø–æ —Å–∞–ø–ø–æ—Ä—Ç—É
        ("idx_error_reports_support", "error_reports", "support_user_id"),
        
        # –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É
        ("idx_error_reports_status", "error_reports", "status"),
        
        # –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–∞—Ç–∞ + —Å—Ç–∞—Ç—É—Å)
        ("idx_error_reports_date_status", "error_reports", "created_at, status"),
        
        # –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å (–¥–∞—Ç–∞ —Ä–µ—à–µ–Ω–∏—è + –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞) –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
        ("idx_error_reports_resolved_time", "error_reports", "resolved_at, response_time_seconds"),
    ]
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã manager_daily_stats
    indexes_to_create.extend([
        # –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –¥–∞—Ç–µ
        ("idx_manager_stats_date", "manager_daily_stats", "date"),
        
        # –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É
        ("idx_manager_stats_user", "manager_daily_stats", "user_id"),
        
        # –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å (user + date) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ UNIQUE constraint, –Ω–æ —è–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å –±—ã—Å—Ç—Ä–µ–µ
        ("idx_manager_stats_user_date", "manager_daily_stats", "user_id, date"),
    ])
    
    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã manager_sips
    indexes_to_create.extend([
        # –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ SIP
        ("idx_manager_sips_updated", "manager_sips", "last_updated"),
    ])
    
    created = 0
    skipped = 0
    
    for index_name, table_name, columns in indexes_to_create:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
            cursor.execute(
                "SELECT name FROM sqlite_master WHERE type='index' AND name=?",
                (index_name,)
            )
            
            if cursor.fetchone():
                logger.info(f"‚è≠ –ò–Ω–¥–µ–∫—Å {index_name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                skipped += 1
                continue
            
            # –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–µ–∫—Å
            cursor.execute(f"CREATE INDEX {index_name} ON {table_name}({columns})")
            logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å: {index_name} –Ω–∞ {table_name}({columns})")
            created += 1
            
        except sqlite3.Error as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ {index_name}: {e}")
    
    conn.commit()
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    logger.info("üìä –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü...")
    for table in ["error_reports", "manager_daily_stats", "manager_sips"]:
        try:
            cursor.execute(f"ANALYZE {table}")
            logger.info(f"‚úÖ –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü—ã {table} –∑–∞–≤–µ—Ä—à—ë–Ω")
        except sqlite3.Error as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ {table}: {e}")
    
    conn.commit()
    conn.close()
    
    logger.info("=" * 60)
    logger.info(f"‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    logger.info(f"üìä –°–æ–∑–¥–∞–Ω–æ –∏–Ω–¥–µ–∫—Å–æ–≤: {created}")
    logger.info(f"‚è≠ –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç): {skipped}")
    logger.info(f"üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ!")
    logger.info("=" * 60)


if __name__ == "__main__":
    add_indexes()



=== update_sheets_now.py ===
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Google Sheets
"""
import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ PYTHONPATH
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from services.google_sheets_service import GoogleSheetsService
from utils.logger import logger

async def main():
    try:
        logger.info("üîÑ –ó–∞–ø—É—Å–∫ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
        
        # –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
        service = GoogleSheetsService()
        
        if not service.client or not service.spreadsheet:
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Google Sheets —Å–µ—Ä–≤–∏—Å")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞—ë–º –ª–∏—Å—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        logger.info("üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ª–∏—Å—Ç–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏...")
        await service._create_weekly_sheet()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        logger.info("üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
        await service.update_stats()
        
        logger.info("‚úÖ –ì–æ—Ç–æ–≤–æ!")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        logger.error(traceback.format_exc())

if __name__ == "__main__":
    asyncio.run(main())


=== requirements.txt ===
python-telegram-bot==20.7
python-dotenv==1.0.0
gspread==5.12.0
oauth2client==4.1.3
APScheduler==3.10.4
tenacity==8.2.3



