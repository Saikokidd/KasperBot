#!/usr/bin/env python3
"""
scripts/test_base_stats_logic.py
–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–¥—Å—á—ë—Ç–∞ base_stats_service

–ó–∞–ø—É—Å–∫: python scripts/test_base_stats_logic.py
"""

from datetime import datetime, timedelta
from typing import Dict, List


# –ò–º–∏—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –ø–æ–¥—Å—á—ë—Ç–∞ –∏–∑ base_stats_service
def count_calls_by_provider(raw_data: List[Dict]) -> Dict[str, Dict[str, int]]:
    """–ü–æ–¥—Å—á–∏—Ç–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ—Å—Ç–∞–≤—â–∏–∫—É"""
    stats = {}

    for row in raw_data:
        provider = row.get("–ø–æ—Å—Ç–∞–≤—â–∏–∫", "").strip()

        if not provider:
            continue

        if provider not in stats:
            stats[provider] = {"calls": 0, "recalls": 0, "bomzh": 0}

        stats[provider]["calls"] += 1

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç—Ä—É–±–∫–∏ –ø–æ —Ü–≤–µ—Ç—É –≤ –≥—Ä–∞—Ñ–µ "–∏—Ç–æ–≥"
        itog_color = row.get("–∏—Ç–æ–≥_—Ü–≤–µ—Ç", "").strip().upper()

        if itog_color == "–†–û–ó–û–í–´–ô":
            stats[provider]["bomzh"] += 1
        elif itog_color == "–ó–ï–õ–ï–ù–´–ô":
            stats[provider]["recalls"] += 1

    return stats


def print_stats_table(date_str: str, stats: Dict):
    """–ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
    print(f"\n{'='*90}")
    print(f"üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –∑–∞ {date_str}")
    print(f"{'='*90}")
    print(
        f"{'–ü–æ—Å—Ç–∞–≤—â–∏–∫':<30} {'–ö–æ–ª-–≤–æ':>8} {'–ë–æ–º–∂':>8} {'–ü–µ—Ä–µ–∑–≤–æ–Ω—ã':>10} {'% –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤':>12}"
    )
    print(f"{'-'*90}")

    total_calls = 0
    total_bomzh = 0
    total_recalls = 0

    for provider, data in sorted(stats.items()):
        calls = data["calls"]
        bomzh = data["bomzh"]
        recalls = data["recalls"]
        pct = (recalls / calls * 100) if calls > 0 else 0

        print(f"{provider:<30} {calls:>8} {bomzh:>8} {recalls:>10} {pct:>11.0f}%")

        total_calls += calls
        total_bomzh += bomzh
        total_recalls += recalls

    print(f"{'-'*90}")
    total_pct = (total_recalls / total_calls * 100) if total_calls > 0 else 0
    print(
        f"{'–ò–¢–û–ì–û':<30} {total_calls:>8} {total_bomzh:>8} {total_recalls:>10} {total_pct:>11.0f}%"
    )
    print(f"{'='*90}\n")


# ===== –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï =====

# –¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ)
test_data_15_12 = [
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–†–û–ó–û–í–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–†–û–ó–û–í–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫_–ú–°–ö_helphub", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–†–û–ó–û–í–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫+–ê–±–µ–Ω—Ç–µ–Ω+—Ä–µ–¥", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫+–ê–±–µ–Ω—Ç–µ–Ω+—Ä–µ–¥", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫+–ê–±–µ–Ω—Ç–µ–Ω+—Ä–µ–¥", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫+–ê–±–µ–Ω—Ç–µ–Ω+—Ä–µ–¥", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫+–ê–±–µ–Ω—Ç–µ–Ω+—Ä–µ–¥", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "1–∫+–ê–±–µ–Ω—Ç–µ–Ω+—Ä–µ–¥", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "0.3–∫_Prado_xmosem_–æ—Ç–¥–µ–ª", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
]

# –¢–µ—Å—Ç 2: –í—Ç–æ—Ä–∞—è –¥–∞—Ç–∞
test_data_16_12 = [
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫+–ê–Ω–æ–Ω_—Ä–µ–≥–∏_–¢–í–õ", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫+–ê–Ω–æ–Ω_—Ä–µ–≥–∏_–¢–í–õ", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫+–ê–Ω–æ–Ω_—Ä–µ–≥–∏_–¢–í–õ", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫+–ê–Ω–æ–Ω_—Ä–µ–≥–∏_–¢–í–õ", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–†–û–ó–û–í–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫+–ê–Ω–æ–Ω_—Ä–µ–≥–∏_–¢–í–õ", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫+–ê–Ω–æ–Ω_—Ä–µ–≥–∏_–¢–í–õ", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": "–ó–ï–õ–ï–ù–´–ô"},
    {"–ø–æ—Å—Ç–∞–≤—â–∏–∫": "3–∫+–ê–Ω–æ–Ω_—Ä–µ–≥–∏_–¢–í–õ", "–∏—Ç–æ–≥_—Ü–≤–µ—Ç": ""},
    # ... –∏ —Ç.–¥.
]


def test_calculations():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–¥—Å—á—ë—Ç–∞"""
    print("\nüß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –õ–û–ì–ò–ö–ò –ü–û–î–°–ß–Å–¢–ê BASE_STATS_SERVICE\n")

    # –¢–µ—Å—Ç 1: 15.12.2025
    stats_15_12 = count_calls_by_provider(test_data_15_12)
    print_stats_table("15.12.2025", stats_15_12)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å–æ —Å–∫—Ä–∏–Ω–∞)
    expected_15_12 = {
        "3–∫_–ú–°–ö_helphub": {"calls": 12, "recalls": 4, "bomzh": 2},
        "1–∫_—Ä–µ–≥–ª_–ê–Ω–æ–Ω": {"calls": 16, "recalls": 9, "bomzh": 1},
        "1–∫+–ê–±–µ–Ω—Ç–µ–Ω+—Ä–µ–¥": {"calls": 6, "recalls": 3, "bomzh": 0},
        "0.3–∫_Prado_xmosem_–æ—Ç–¥–µ–ª": {"calls": 1, "recalls": 0, "bomzh": 0},
    }

    print("‚úÖ –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –¥–ª—è 15.12.2025:")
    for provider, expected in expected_15_12.items():
        actual = stats_15_12.get(provider, {})

        match_calls = actual.get("calls", 0) == expected["calls"]
        match_recalls = actual.get("recalls", 0) == expected["recalls"]
        match_bomzh = actual.get("bomzh", 0) == expected["bomzh"]

        status = "‚úÖ" if (match_calls and match_recalls and match_bomzh) else "‚ùå"

        print(f"  {status} {provider}")
        if not match_calls:
            print(
                f"     ‚ùå –ö–æ–ª-–≤–æ: –æ–∂–∏–¥–∞–ª–∏ {expected['calls']}, –ø–æ–ª—É—á–∏–ª–∏ {actual.get('calls', 0)}"
            )
        if not match_recalls:
            print(
                f"     ‚ùå –ü–µ—Ä–µ–∑–≤–æ–Ω—ã: –æ–∂–∏–¥–∞–ª–∏ {expected['recalls']}, –ø–æ–ª—É—á–∏–ª–∏ {actual.get('recalls', 0)}"
            )
        if not match_bomzh:
            print(
                f"     ‚ùå –ë–æ–º–∂–∏: –æ–∂–∏–¥–∞–ª–∏ {expected['bomzh']}, –ø–æ–ª—É—á–∏–ª–∏ {actual.get('bomzh', 0)}"
            )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ç–æ–≥–æ
    total_calls = sum(s["calls"] for s in stats_15_12.values())
    total_recalls = sum(s["recalls"] for s in stats_15_12.values())
    total_bomzh = sum(s["bomzh"] for s in stats_15_12.values())

    print(f"\n  üìä –ò–¢–û–ì–û –∑–∞ –¥–µ–Ω—å:")
    print(f"     –ö–æ–ª-–≤–æ: {total_calls} (–æ–∂–∏–¥–∞–ª–∏ 35)")
    print(f"     –ü–µ—Ä–µ–∑–≤–æ–Ω—ã: {total_recalls} (–æ–∂–∏–¥–∞–ª–∏ 16)")
    print(f"     –ë–æ–º–∂–∏: {total_bomzh} (–æ–∂–∏–¥–∞–ª–∏ 3)")
    print(f"     % –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤: {(total_recalls/total_calls*100):.0f}% (–æ–∂–∏–¥–∞–ª–∏ 46%)")


def test_percentage_calculation():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤"""
    print("\n\nüßÆ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ê–°–ß–Å–¢–ê –ü–†–û–¶–ï–ù–¢–û–í\n")

    test_cases = [
        ({"calls": 10, "recalls": 5}, 50),
        ({"calls": 100, "recalls": 25}, 25),
        ({"calls": 7, "recalls": 3}, 43),  # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ
        ({"calls": 1, "recalls": 0}, 0),
        ({"calls": 0, "recalls": 0}, 0),  # –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å
    ]

    for data, expected_pct in test_cases:
        pct = (data["recalls"] / data["calls"] * 100) if data["calls"] > 0 else 0
        status = "‚úÖ" if int(pct) == expected_pct else "‚ö†Ô∏è"
        print(
            f"  {status} {data['calls']} —Ç—Ä—É–±–æ–∫, {data['recalls']} –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤ ‚Üí {pct:.0f}% (–æ–∂–∏–¥–∞–ª–∏ {expected_pct}%)"
        )


if __name__ == "__main__":
    test_calculations()
    test_percentage_calculation()

    print("\n" + "=" * 90)
    print("‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
    print("=" * 90 + "\n")
