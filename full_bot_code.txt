=== ./main.py ===
"""
–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: main.py
–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Telegram –±–æ—Ç–∞

–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω per_message=True –¥–ª—è –≤—Å–µ—Ö ConversationHandler (—É–±—Ä–∞–Ω—ã warnings)
"""
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    MessageHandler, filters, ConversationHandler
)
from config.settings import settings
from utils.logger import logger

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
from handlers.commands import start_command
from handlers.callbacks import (
    role_choice_callback,
    tel_choice_callback,
    support_callback,
    fallback_callback
)
from handlers.messages import message_handler
from handlers.errors import error_handler

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
from handlers.management import (
    show_management_menu,
    managers_menu, list_managers, add_manager_start, add_manager_process,
    remove_manager_start, remove_manager_process,
    telephonies_menu, list_telephonies, 
    add_telephony_start, add_telephony_name, add_telephony_code, 
    add_telephony_type, add_telephony_group,
    remove_telephony_start, remove_telephony_process,
    broadcast_start, broadcast_process, broadcast_confirm,
    cancel_conversation,
    WAITING_MANAGER_ID, WAITING_MANAGER_ID_REMOVE,
    WAITING_TEL_NAME, WAITING_TEL_CODE, WAITING_TEL_TYPE, WAITING_TEL_GROUP,
    WAITING_TEL_CODE_REMOVE, WAITING_BROADCAST_MESSAGE
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
from handlers.analytics import (
    show_errors_stats_menu, show_general_stats, show_general_stats_period,
    show_managers_stats, show_managers_stats_period,
    show_support_stats, show_support_stats_period,
    show_response_time_stats, show_response_time_stats_period,
    show_dashboard_start, show_dashboard_page
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º ConversationHandler –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫
from handlers.quick_errors import quick_bmw_conv


def register_handlers(app: Application):
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–æ—Ç–∞
    
    Args:
        app: –≠–∫–∑–µ–º–ø–ª—è—Ä Application
    """
    # –ö–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start_command))
    
    # ===== CONVERSATION HANDLERS –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø =====
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    add_manager_conv = ConversationHandler(
        entry_points=[CallbackQueryHandler(add_manager_start, pattern="^mgmt_add_manager$")],
        states={
            WAITING_MANAGER_ID: [MessageHandler(filters.TEXT | filters.FORWARDED, add_manager_process)]
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation)]
        # ‚úÖ –£–±—Ä–∞–Ω–æ per_message - –Ω–µ –Ω—É–∂–Ω–æ –¥–ª—è MessageHandler
    )
    app.add_handler(add_manager_conv)
    
    # –£–¥–∞–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    remove_manager_conv = ConversationHandler(
        entry_points=[CallbackQueryHandler(remove_manager_start, pattern="^mgmt_remove_manager$")],
        states={
            WAITING_MANAGER_ID_REMOVE: [MessageHandler(filters.TEXT, remove_manager_process)]
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation)]
        # ‚úÖ –£–±—Ä–∞–Ω–æ per_message
    )
    app.add_handler(remove_manager_conv)
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    add_tel_conv = ConversationHandler(
        entry_points=[CallbackQueryHandler(add_telephony_start, pattern="^mgmt_add_tel$")],
        states={
            WAITING_TEL_NAME: [MessageHandler(filters.TEXT, add_telephony_name)],
            WAITING_TEL_CODE: [MessageHandler(filters.TEXT, add_telephony_code)],
            WAITING_TEL_TYPE: [CallbackQueryHandler(add_telephony_type, pattern="^tel_type_")],
            WAITING_TEL_GROUP: [MessageHandler(filters.TEXT, add_telephony_group)]
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation)]
        # ‚úÖ –£–±—Ä–∞–Ω–æ per_message
    )
    app.add_handler(add_tel_conv)
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    remove_tel_conv = ConversationHandler(
        entry_points=[CallbackQueryHandler(remove_telephony_start, pattern="^mgmt_remove_tel$")],
        states={
            WAITING_TEL_CODE_REMOVE: [MessageHandler(filters.TEXT, remove_telephony_process)]
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation)]
        # ‚úÖ –£–±—Ä–∞–Ω–æ per_message
    )
    app.add_handler(remove_tel_conv)
    
    # –†–∞—Å—Å—ã–ª–∫–∞
    broadcast_conv = ConversationHandler(
        entry_points=[CallbackQueryHandler(broadcast_start, pattern="^mgmt_broadcast$")],
        states={
            WAITING_BROADCAST_MESSAGE: [MessageHandler(filters.ALL & ~filters.COMMAND, broadcast_process)]
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation)]
        # ‚úÖ –£–±—Ä–∞–Ω–æ per_message
    )
    app.add_handler(broadcast_conv)
    
    # ‚úÖ ConversationHandler –¥–ª—è BMW (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤ quick_errors.py)
    app.add_handler(quick_bmw_conv)
    
    # ===== CALLBACK HANDLERS –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø =====
    
    app.add_handler(CallbackQueryHandler(show_management_menu, pattern="^mgmt_menu$"))
    app.add_handler(CallbackQueryHandler(managers_menu, pattern="^mgmt_managers$"))
    app.add_handler(CallbackQueryHandler(list_managers, pattern="^mgmt_list_managers$"))
    app.add_handler(CallbackQueryHandler(telephonies_menu, pattern="^mgmt_telephonies$"))
    app.add_handler(CallbackQueryHandler(list_telephonies, pattern="^mgmt_list_tel$"))
    app.add_handler(CallbackQueryHandler(broadcast_confirm, pattern="^broadcast_confirm$"))
    
    # ===== CALLBACK HANDLERS –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò –û–®–ò–ë–û–ö =====
    
    app.add_handler(CallbackQueryHandler(show_errors_stats_menu, pattern="^stats_menu$"))
    
    # –î–∞—à–±–æ—Ä–¥
    app.add_handler(CallbackQueryHandler(show_dashboard_start, pattern="^dash_start_"))
    app.add_handler(CallbackQueryHandler(show_dashboard_page, pattern="^dash_page_"))
    
    # –°—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    app.add_handler(CallbackQueryHandler(show_general_stats, pattern="^stats_general$"))
    app.add_handler(CallbackQueryHandler(show_general_stats_period, pattern="^stats_gen_"))
    app.add_handler(CallbackQueryHandler(show_managers_stats, pattern="^stats_managers$"))
    app.add_handler(CallbackQueryHandler(show_managers_stats_period, pattern="^stats_mgr_"))
    app.add_handler(CallbackQueryHandler(show_support_stats, pattern="^stats_support$"))
    app.add_handler(CallbackQueryHandler(show_support_stats_period, pattern="^stats_sup_"))
    app.add_handler(CallbackQueryHandler(show_response_time_stats, pattern="^stats_response_time$"))
    app.add_handler(CallbackQueryHandler(show_response_time_stats_period, pattern="^stats_time_"))
    
    # ===== –û–°–ù–û–í–ù–´–ï CALLBACK –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò =====
    
    app.add_handler(CallbackQueryHandler(role_choice_callback, pattern="^role_"))
    app.add_handler(CallbackQueryHandler(tel_choice_callback, pattern="^tel_"))
    app.add_handler(CallbackQueryHandler(support_callback, pattern="^(fix|wait|wrong|sim)_"))
    app.add_handler(CallbackQueryHandler(fallback_callback))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    app.add_handler(MessageHandler(
        filters.ALL & ~filters.COMMAND & filters.ChatType.PRIVATE,
        message_handler
    ))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    app.add_error_handler(error_handler)


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    try:
        logger.info("üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        logger.info(f"üìã –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: {len(settings.MANAGERS)}")
        logger.info(f"üëë Admin ID: {settings.ADMIN_ID}")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
        from database.models import db
        logger.info("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        app = Application.builder().token(settings.BOT_TOKEN).build()
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        register_handlers(app)
        
        logger.info("‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        
        # ===== –ó–ê–ü–£–°–ö –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê (–ü–û–°–õ–ï –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í) =====
        try:
            from services.scheduler_service import scheduler_service
            
            # ‚úÖ –ù–û–í–û–ï: –ü–µ—Ä–µ–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            scheduler_service.set_bot(app.bot)
            
            if not scheduler_service.scheduler.running:
                scheduler_service.start()
                logger.info("‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
            else:
                logger.info("‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–µ –∑–∞–ø—É—â–µ–Ω: {e}")
            import traceback
            logger.error(traceback.format_exc())
        # ===================================
        
        # –ó–∞–ø—É—Å–∫ polling (–±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
        app.run_polling(
            allowed_updates=["message", "callback_query"],
            drop_pending_updates=True
        )
        
    except Exception as e:
        logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}", exc_info=True)
        raise
    finally:
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏
        try:
            from services.scheduler_service import scheduler_service
            scheduler_service.stop()
        except:
            pass


if __name__ == "__main__":
    main()
=== ./keyboards/__init__.py ===

=== ./keyboards/reply.py ===
"""
–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è keyboards/reply.py - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø
–î–æ–±–∞–≤–ª–µ–Ω–æ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
"""
from telegram import ReplyKeyboardMarkup, KeyboardButton
from config.constants import MANAGER_MENU, ADMIN_MENU, PULT_MENU, TELEPHONY_MENU


def get_manager_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in MANAGER_MENU],
        resize_keyboard=True
    )


def get_admin_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∞–¥–º–∏–Ω–∞
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in ADMIN_MENU],
        resize_keyboard=True
    )


def get_pult_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –¥–ª—è –ø—É–ª—å—Ç–∞
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø—É–ª—å—Ç–∞
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in PULT_MENU],
        resize_keyboard=True
    )


def get_menu_by_role(role: str) -> ReplyKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    
    Args:
        role: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ("manager", "admin" –∏–ª–∏ "pult")
        
    Returns:
        ReplyKeyboardMarkup —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Ä–æ–ª–∏
    """
    if role == "admin":
        return get_admin_menu()
    elif role == "pult":
        return get_pult_menu()
    return get_manager_menu()


# ‚úÖ –ù–û–í–û–ï: –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
def get_telephony_menu() -> ReplyKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Returns:
        ReplyKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π + –ú–µ–Ω—é
    """
    return ReplyKeyboardMarkup(
        [[KeyboardButton(text) for text in row] for row in TELEPHONY_MENU],
        resize_keyboard=True
    )
=== ./keyboards/inline.py ===
"""
Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–∫–Ω–æ–ø–∫–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö)
"""
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from config.constants import QUICK_ERROR_BUTTONS
from database.models import db


def get_telephony_keyboard() -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∏–∑ –ë–î)
    
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π
    """
    telephonies = db.get_all_telephonies()
    
    # –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π –≤ –ë–î, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    if not telephonies:
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("BMW", callback_data="tel_bmw")],
            [InlineKeyboardButton("–ó–≤–æ–Ω–∞—Ä–∏", callback_data="tel_zvon")]
        ])
    
    # –°–æ–∑–¥–∞—ë–º –∫–Ω–æ–ø–∫–∏ –∏–∑ –ë–î
    buttons = []
    for tel in telephonies:
        buttons.append([
            InlineKeyboardButton(tel['name'], callback_data=f"tel_{tel['code']}")
        ])
    
    return InlineKeyboardMarkup(buttons)


def get_role_choice_keyboard() -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
    
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
    """
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üë®‚Äçüíº –í–æ–π—Ç–∏ –∫–∞–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä", callback_data="role_manager")],
        [InlineKeyboardButton("üëë –í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω", callback_data="role_admin")]
    ])


def get_support_keyboard(user_id: int, tel_code: str) -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —Å–∞–ø–ø–æ—Ä—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–µ–ª—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π)
    
    Args:
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞ –∏–ª–∏ None –¥–ª—è —á—ë—Ä–Ω—ã—Ö
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏–∑ –ë–î
    tel = db.get_telephony_by_code(tel_code)
    
    # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ
    if not tel:
        if tel_code != "bmw":
            return None
    else:
        # –ï—Å–ª–∏ —á—ë—Ä–Ω–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è - –±–µ–∑ –∫–Ω–æ–ø–æ–∫
        if tel['type'] == 'black':
            return None
    
    # –ë–µ–ª–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ", callback_data=f"fix_{user_id}_{tel_code}"),
            InlineKeyboardButton("‚è± 2-3 –º–∏–Ω", callback_data=f"wait_{user_id}_{tel_code}")
        ],
        [
            InlineKeyboardButton("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç", callback_data=f"wrong_{user_id}_{tel_code}"),
            InlineKeyboardButton("‚úÖ –°–∏–º –≤–æ—Ä–∫", callback_data=f"sim_{user_id}_{tel_code}")
        ]
    ])


# ===== –ù–û–í–´–ï –ö–õ–ê–í–ò–ê–¢–£–†–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø =====

def get_management_menu() -> InlineKeyboardMarkup:
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("üë• –ú–µ–Ω–µ–¥–∂–µ—Ä—ã", callback_data="mgmt_managers")],
        [InlineKeyboardButton("üìû –¢–µ–ª–µ—Ñ–æ–Ω–∏–∏", callback_data="mgmt_telephonies")],
        [InlineKeyboardButton("üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="mgmt_broadcast")],
    ])


def get_telephony_type_keyboard() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚ö™Ô∏è –ë–µ–ª–∞—è (—Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞)", callback_data="tel_type_white")],
        [InlineKeyboardButton("‚ö´Ô∏è –ß—ë—Ä–Ω–∞—è (–±–µ–∑ –∫–Ω–æ–ø–æ–∫)", callback_data="tel_type_black")]
    ])
    

# ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫ BMW
def get_quick_errors_keyboard() -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫ BMW (2 –∫–æ–ª–æ–Ω–∫–∏)
    
    Returns:
        InlineKeyboardMarkup —Å 10 –∫–Ω–æ–ø–∫–∞–º–∏ –æ—à–∏–±–æ–∫ + –∏–∑–º–µ–Ω–∏—Ç—å SIP
    """
    buttons = [
        # –ü–µ—Ä–≤—ã–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["1"], callback_data="qerr_1"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["2"], callback_data="qerr_2")
        ],
        # –í—Ç–æ—Ä–æ–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["3"], callback_data="qerr_3"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["4"], callback_data="qerr_4")
        ],
        # –¢—Ä–µ—Ç–∏–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["5"], callback_data="qerr_5"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["6"], callback_data="qerr_6")
        ],
        # –ß–µ—Ç–≤—ë—Ä—Ç—ã–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["7"], callback_data="qerr_7"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["8"], callback_data="qerr_8")
        ],
        # –ü—è—Ç—ã–π —Ä—è–¥
        [
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["9"], callback_data="qerr_9"),
            InlineKeyboardButton(QUICK_ERROR_BUTTONS["10"], callback_data="qerr_10")
        ],
        # –®–µ—Å—Ç–æ–π —Ä—è–¥ - –∏–∑–º–µ–Ω–∏—Ç—å SIP
        [
            InlineKeyboardButton("‚öôÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å SIP", callback_data="change_sip")
        ]
    ]
    
    return InlineKeyboardMarkup(buttons)
=== ./config/__init__.py ===

=== ./config/constants.py ===
"""
–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –§–ê–ô–õ: config/constants.py
–î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫ BMW

–ò–ó–ú–ï–ù–ï–ù–ò–Ø:
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã MAX_SIP_LENGTH, MAX_CUSTOM_ERROR_LENGTH
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω KNOWN_TELEPHONY_NAMES –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
"""

# ===== –¢–ê–ô–ú–ê–£–¢–´ =====
TEL_CHOICE_TIMEOUT = 10  # –º–∏–Ω—É—Ç

# ===== –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø =====
# ‚úÖ –ù–û–í–û–ï: –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª
MAX_SIP_LENGTH = 50  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ SIP –Ω–æ–º–µ—Ä–∞
MAX_CUSTOM_ERROR_LENGTH = 500  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ custom –æ—à–∏–±–∫–∏ BMW

# ===== –ú–ê–ü–ü–ò–ù–ì –¢–ï–õ–ï–§–û–ù–ò–ò =====
TEL_CODES = {
    "BMW": "bmw",
    "–ó–≤–æ–Ω–∞—Ä–∏": "zvon"
}

TEL_CODES_REVERSE = {v: k for k, v in TEL_CODES.items()}

# ‚úÖ –ù–û–í–û–ï: –î–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ handle_telephony_choice
KNOWN_TELEPHONY_NAMES = {"BMW", "–ó–≤–æ–Ω–∞—Ä–∏"}

# ===== –ú–ï–ù–Æ –î–õ–Ø –†–û–õ–ï–ô =====
MANAGER_MENU = [
    ["–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"],
    ["–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏"]
]

ADMIN_MENU = [
    ["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"],
    ["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫"],
    ["–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º"]
]

PULT_MENU = [
    ["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"]
]

# ‚úÖ –ù–û–í–û–ï: –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (–¥–ª—è Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã)
TELEPHONY_MENU = [
    ["BMW", "–ó–≤–æ–Ω–∞—Ä–∏"],
    ["‚óÄÔ∏è –ú–µ–Ω—é"]
]

# ===== –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò =====
USEFUL_LINKS = {
    "CRM": "https://cabinetsmonster.com/crm/clients/work",
    "–ü–æ—á—Ç–∞ –±–∞–Ω–∫": "https://my.pochtabank.ru/login?next=%2F",
    "–û—Ç–¥–µ–ª–µ–Ω–∏—è –ø–æ—á—Ç—ã": "https://www.pochta.ru/offices"
}

# ‚úÖ –ù–û–í–û–ï: –ë—ã—Å—Ç—Ä—ã–µ –æ—à–∏–±–∫–∏ BMW
QUICK_ERRORS = {
    "1": "–ù–∞–º–±–µ—Ä –±–∏–∑–∏",
    "2": "–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
    "3": "–í—ã–∑–æ–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω",
    "4": "–ë–∞–ª–∞–Ω—Å",
    "5": "–°–ª–µ—Ç–µ–ª —Ä–µ–≥–∏—Å—Ç—Ä —Å–∏–º",
    "6": "–¢–µ–º–ø–æ—Ä–∞–ª–∏",
    "7": "–ó–∞–Ω—è—Ç–æ",
    "8": "–ù–µ—Ç–≤–æ—Ä–∫",
    "9": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤—è–∑–∏",
    "10": "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"
}

QUICK_ERROR_BUTTONS = {
    "1": "1Ô∏è‚É£ –ù–∞–º–±–µ—Ä –±–∏–∑–∏",
    "2": "2Ô∏è‚É£ –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
    "3": "3Ô∏è‚É£ –í—ã–∑–æ–≤ –Ω–µ —É—Å—Ç–∞–Ω",
    "4": "4Ô∏è‚É£ –ë–∞–ª–∞–Ω—Å",
    "5": "5Ô∏è‚É£ –°–ª–µ—Ç–µ–ª —Ä–µ–≥–∏—Å—Ç—Ä —Å–∏–º",
    "6": "6Ô∏è‚É£ –¢–µ–º–ø–æ—Ä–∞–ª–∏",
    "7": "7Ô∏è‚É£ –ó–∞–Ω—è—Ç–æ",
    "8": "8Ô∏è‚É£ –ù–µ—Ç–≤–æ—Ä–∫",
    "9": "9Ô∏è‚É£ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–≤—è–∑–∏",
    "10": "üîü –°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç"
}

# ===== –¢–ï–ö–°–¢–´ –°–û–û–ë–©–ï–ù–ò–ô =====
MESSAGES = {
    "access_denied": "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.",
    "session_expired": "‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∑–∞–Ω–æ–≤–æ –∫–æ–º–∞–Ω–¥–æ–π /start",
    "choose_telephony": "üìû –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é:",
    "support_prompt": "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏:\n\n(–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞)",
    "error_too_long": "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ.\n–ú–∞–∫—Å–∏–º—É–º: 1000 —Å–∏–º–≤–æ–ª–æ–≤\n–°–µ–π—á–∞—Å: {length} —Å–∏–º–≤–æ–ª–æ–≤",
    "error_empty": "‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç.",
    "error_sent_bmw": "‚úÖ –û—à–∏–±–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–∞–ø–ø–æ—Ä—Ç!\n\n–¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel}\n–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏‚ùóÔ∏è‚ùóÔ∏è",
    "error_sent_zvon": "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–∞–ø–æ—Ä—Ç–∞–º\n\n–¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel}\n–û—Ç–≤–µ—Ç–∞ –º–æ–∂–µ—Ç–µ –Ω–µ –æ–∂–∏–¥–∞—Ç—å‚ùóÔ∏è‚ùóÔ∏è –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É.",
    "support_sent": "‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É!\n–û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.",
    "unknown_command": "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.",
    
    # ‚úÖ –ù–û–í–û–ï: –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫
    "sip_prompt": "üìû –£–∫–∞–∂–∏—Ç–µ –≤–∞—à SIP –Ω–æ–º–µ—Ä:",
    "sip_saved": "‚úÖ SIP —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {sip}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—à–∏–±–∫–∏:",
    "sip_invalid": "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç SIP. –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: 101)",
    "choose_quick_error": "üìû –í–∞—à SIP: {sip}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—à–∏–±–∫–∏:",
    "custom_error_prompt": "‚úèÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏:",
    "quick_error_sent": "‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —Å–∞–ø–ø–æ—Ä—Ç!\n\nSIP: {sip}\n–û—à–∏–±–∫–∞: {error}"
}

# ===== –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô =====
SUPPORT_ACTIONS = {
    "fix": "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ",
    "wait": "‚è± –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω",
    "wrong": "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç",
    "sim": "‚úÖ –°–∏–º –≤–æ—Ä–∫"
}
=== ./config/settings.py ===
"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞: –∑–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
"""
import os
from dotenv import load_dotenv
from typing import Dict, List

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()


class Settings:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞"""
    
    def __init__(self):
        self._validate_env()
        self._load_env()
        self._parse_managers()
        self._parse_admins()
        self._parse_pult()
    
    def _validate_env(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        required = {
            "BOT_TOKEN": os.getenv("BOT_TOKEN"),
            "ADMIN_ID": os.getenv("ADMIN_ID"),
            "BMW_GROUP_ID": os.getenv("BMW_GROUP_ID"),
            "ZVONARI_GROUP_ID": os.getenv("ZVONARI_GROUP_ID")
        }
        
        missing = [key for key, value in required.items() if not value]
        if missing:
            raise ValueError(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env: {', '.join(missing)}")
    
    def _load_env(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        self.BOT_TOKEN = os.getenv("BOT_TOKEN")
        self.ADMIN_ID = int(os.getenv("ADMIN_ID"))
        self.BMW_GROUP_ID = int(os.getenv("BMW_GROUP_ID"))
        self.ZVONARI_GROUP_ID = int(os.getenv("ZVONARI_GROUP_ID"))
        self.GOOGLE_APPS_SCRIPT_URL = os.getenv("GOOGLE_APPS_SCRIPT_URL", "")
    
    def _parse_managers(self):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ .env"""
        managers_str = os.getenv("MANAGERS_IDS", "")
        self.MANAGERS = [
            int(id.strip()) 
            for id in managers_str.split(",") 
            if id.strip().isdigit()
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
        if self.ADMIN_ID not in self.MANAGERS:
            self.MANAGERS.append(self.ADMIN_ID)
    
    def _parse_admins(self):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–æ–≤ –∏–∑ .env"""
        admins_str = os.getenv("ADMIN_IDS", "")
        
        if admins_str:
            # –ï—Å–ª–∏ –µ—Å—Ç—å ADMIN_IDS - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            self.ADMINS = [
                int(id.strip()) 
                for id in admins_str.split(",") 
                if id.strip().isdigit()
            ]
        else:
            # –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π ADMIN_ID
            self.ADMINS = [self.ADMIN_ID]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
        for admin_id in self.ADMINS:
            if admin_id not in self.MANAGERS:
                self.MANAGERS.append(admin_id)
    
    def _parse_pult(self):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –ø—É–ª—å—Ç–∞ –∏–∑ .env"""
        pult_str = os.getenv("PULT_IDS", "")
        
        if pult_str:
            self.PULT = [
                int(id.strip()) 
                for id in pult_str.split(",") 
                if id.strip().isdigit()
            ]
        else:
            self.PULT = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Ç –≤ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
        for pult_id in self.PULT:
            if pult_id not in self.MANAGERS:
                self.MANAGERS.append(pult_id)
    
    def get_telephony_groups(self) -> Dict[str, int]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –Ω–∞ –≥—Ä—É–ø–ø—ã"""
        return {
            "BMW": self.BMW_GROUP_ID,
            "–ó–≤–æ–Ω–∞—Ä–∏": self.ZVONARI_GROUP_ID
        }


# –°–æ–∑–¥–∞—ë–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
settings = Settings()
=== ./handlers/__init__.py ===

=== ./handlers/errors.py ===
"""
–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
"""
from telegram import Update
from telegram.ext import ContextTypes
from utils.logger import logger


async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
    """
    logger.error(
        f"‚ùå Exception while handling an update: {context.error}",
        exc_info=context.error
    )
    
    try:
        if update and update.effective_message:
            await update.effective_message.reply_text(
                "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
            )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: {e}")

=== ./handlers/callbacks.py ===
"""
–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: handlers/callbacks.py
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –∑–∞–ø—Ä–æ—Å–æ–≤ (inline –∫–Ω–æ–ø–∫–∏)

–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω closing() –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ë–î
‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
"""
from datetime import datetime
from telegram import Update, error as telegram_error
from telegram.ext import ContextTypes
from contextlib import closing

from config.settings import settings
from config.constants import TEL_CODES_REVERSE, SUPPORT_ACTIONS, TEL_CHOICE_TIMEOUT
from services.user_service import user_service
from keyboards.reply import get_admin_menu, get_manager_menu, get_menu_by_role
from keyboards.inline import get_telephony_keyboard
from utils.state import set_user_role, get_user_role, set_tel_choice
from utils.logger import logger


async def role_choice_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
    if not user_service.is_admin(user_id):
        await query.message.edit_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return
    
    if query.data == "role_manager":
        set_user_role(context, "manager")
        logger.info(f"üë®‚Äçüíº –ê–¥–º–∏–Ω {user_id} –≤–æ—à—ë–ª –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä")
        
        await query.message.edit_text(
            "üë®‚Äçüíº –í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=None
        )
        
        await query.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂–µ:",
            reply_markup=get_manager_menu()
        )
        
    elif query.data == "role_admin":
        set_user_role(context, "admin")
        logger.info(f"üëë –ê–¥–º–∏–Ω {user_id} –≤–æ—à—ë–ª –∫–∞–∫ –∞–¥–º–∏–Ω")
        
        await query.message.edit_text(
            "üëë –í—ã –≤–æ—à–ª–∏ –≤ —Ä–µ–∂–∏–º–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=None
        )
        
        await query.message.reply_text(
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –Ω–∏–∂–µ:",
            reply_markup=get_admin_menu()
        )


async def tel_choice_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ —á–µ—Ä–µ–∑ inline –∫–Ω–æ–ø–∫–∏
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    query = update.callback_query
    await query.answer()
    
    try:
        callback_data = query.data
        logger.debug(f"Callback data: {callback_data}")
        
        if not callback_data.startswith("tel_"):
            logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {callback_data}")
            await query.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–±–æ—Ä–∞.")
            return
        
        tel_code = callback_data.split("_")[1]
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ë–î
        from database.models import db
        tel = db.get_telephony_by_code(tel_code)
        
        if tel:
            tel_name = tel['name']
        else:
            # –§–æ–ª–ª–±—ç–∫ –Ω–∞ —Å—Ç–∞—Ä—ã–µ
            tel_name = TEL_CODES_REVERSE.get(tel_code)
        
        if not tel_name:
            logger.error(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {tel_code}")
            await query.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è.")
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
        set_tel_choice(context, tel_name, tel_code)
        
        logger.info(f"‚úÖ User {update.effective_user.id} –≤—ã–±—Ä–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é: {tel_name} ({tel_code})")
        
        await query.message.edit_text(
            f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏: <b>{tel_name}</b>\n\n"
            f"üìù –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏\n"
            f"‚è± –í—ã–±–æ—Ä –∞–∫—Ç–∏–≤–µ–Ω {TEL_CHOICE_TIMEOUT} –º–∏–Ω—É—Ç.",
            parse_mode="HTML"
        )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ tel_choice: {e}", exc_info=True)
        await query.message.reply_text(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
            reply_markup=get_telephony_keyboard()
        )


async def support_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–µ–ª—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π)
    
    ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω closing() –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    query = update.callback_query
    await query.answer()
    
    try:
        data = query.data.split("_")
        if len(data) != 3:
            raise ValueError(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {query.data}")
        
        action_code, user_id_str, tel_code = data
        user_id = int(user_id_str)
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        from database.models import db
        tel = db.get_telephony_by_code(tel_code)
        tel_name = tel['name'] if tel else TEL_CODES_REVERSE.get(tel_code, "Unknown")
        
        action_text = SUPPORT_ACTIONS.get(action_code, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")
        support_user_id = query.from_user.id
        support_username = query.from_user.username or query.from_user.first_name or "–°–∞–ø–ø–æ—Ä—Ç"
        
        logger.info(f"üîß –°–∞–ø–ø–æ—Ä—Ç –¥–µ–π—Å—Ç–≤–∏–µ: {action_text} –¥–ª—è –æ—à–∏–±–∫–∏ –æ—Ç user_id={user_id} ({tel_name}) –æ—Ç {support_username}")
        
        # ===== –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–î –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò =====
        try:
            # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º closing() –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
            with closing(db._get_connection()) as conn:
                cursor = conn.cursor()
                
                # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –æ—à–∏–±–∫—É –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                cursor.execute(
                    """
                    SELECT id, created_at FROM error_reports 
                    WHERE user_id = ? AND telephony_code = ? AND status = 'new'
                    ORDER BY created_at DESC LIMIT 1
                    """,
                    (user_id, tel_code)
                )
                
                error_record = cursor.fetchone()
                
                if error_record:
                    error_id = error_record[0]
                    created_at_str = error_record[1]
                    
                    # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
                    try:
                        # SQLite –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç timestamp –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD HH:MM:SS
                        created_at = datetime.strptime(created_at_str, "%Y-%m-%d %H:%M:%S")
                        resolved_at = datetime.now()
                        response_time = int((resolved_at - created_at).total_seconds())
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏: {e}")
                        response_time = None
                        resolved_at = datetime.now()
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
                    cursor.execute(
                        """
                        UPDATE error_reports 
                        SET status = 'resolved', 
                            resolved_at = ?,
                            support_user_id = ?,
                            support_username = ?,
                            support_action = ?,
                            response_time_seconds = ?
                        WHERE id = ?
                        """,
                        (resolved_at.strftime("%Y-%m-%d %H:%M:%S"), support_user_id, support_username, 
                         action_code, response_time, error_id)
                    )
                    
                    conn.commit()
                    
                    minutes = response_time // 60 if response_time else 0
                    seconds = response_time % 60 if response_time else 0
                    logger.info(f"‚úÖ –û—à–∏–±–∫–∞ #{error_id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –ë–î (–≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {minutes}–º {seconds}—Å)")
                else:
                    logger.warning(f"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è user_id={user_id}, tel_code={tel_code}")
                
                # ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è closing()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î: {e}", exc_info=True)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        original_text = query.message.text_html or query.message.text
        
        # –û–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ
        if len(original_text) > 3500:
            original_text = original_text[:3500] + "..."
        
        new_message = (
            f"{original_text}\n"
            f"{action_text}\n"
            f"<b>–û–±—Ä–∞–±–æ—Ç–∞–ª:</b> {support_username}"
        )
        
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—É–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å)
        try:
            await query.message.edit_text(
                text=new_message,
                parse_mode="HTML",
                reply_markup=None  # –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏
            )
        except telegram_error.TelegramError as e:
            logger.error(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            notification = (
                f"üí¨ <b>–û—Ç–≤–µ—Ç –æ—Ç —Å–∞–ø–ø–æ—Ä—Ç–∞</b>\n\n"
                f"üìû –¢–µ–ª–µ—Ñ–æ–Ω–∏—è: {tel_name}\n"
                f"–°—Ç–∞—Ç—É—Å: {action_text}"
            )
            
            if action_code == "wrong":
                notification += "\n\n‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ."
            elif action_code == "wait":
                notification += "\n\n‚è± –í–∞—à–∞ –ø—Ä–æ–±–ª–µ–º–∞ –±—É–¥–µ—Ç —Ä–µ—à–µ–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 2-3 –º–∏–Ω—É—Ç."
            
            await context.bot.send_message(
                chat_id=user_id,
                text=notification,
                parse_mode="HTML"
            )
            logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ user_id={user_id}")
        except telegram_error.TelegramError as e:
            logger.error(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å user_id={user_id}: {e}")
            
    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ support_callback: {e}")
        await query.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.")
    except Exception as e:
        logger.error(f"‚ùå Unexpected error –≤ support_callback: {e}", exc_info=True)
        await query.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞.")


async def fallback_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö callback –∑–∞–ø—Ä–æ—Å–æ–≤
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    query = update.callback_query
    logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π callback: {query.data} –æ—Ç user_id={query.from_user.id}")
    await query.answer()
    
    role = get_user_role(context)
    current_menu = get_menu_by_role(role)
    
    await query.message.reply_text(
        "‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
        reply_markup=current_menu
    )
=== ./handlers/quick_errors.py ===
"""
–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: handlers/quick_errors.py
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ—à–∏–±–æ–∫ BMW —Å SIP

–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:
‚úÖ –£–±—Ä–∞–Ω—ã callback handlers –∏–∑ entry_points (–æ–Ω–∏ —Ç–µ–ø–µ—Ä—å –≤ states)
‚úÖ –ö–Ω–æ–ø–∫–∏ –æ—à–∏–±–æ–∫ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ BMW
‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
"""
from telegram import Update
from telegram.ext import ContextTypes, ConversationHandler, MessageHandler, filters, CallbackQueryHandler
from database.models import db
from keyboards.inline import get_quick_errors_keyboard
from keyboards.reply import get_menu_by_role
from config.constants import MESSAGES, QUICK_ERRORS, MAX_SIP_LENGTH, MAX_CUSTOM_ERROR_LENGTH
from config.settings import settings
from utils.state import get_user_role
from utils.logger import logger

# –°–æ—Å—Ç–æ—è–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
WAITING_SIP, WAITING_CUSTOM_ERROR, SHOWING_ERRORS = range(3)


async def handle_bmw_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ BMW –∏–∑ Reply –º–µ–Ω—é
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        SHOWING_ERRORS –µ—Å–ª–∏ SIP —É–∫–∞–∑–∞–Ω, WAITING_SIP –µ—Å–ª–∏ –Ω–µ—Ç
    """
    user_id = update.effective_user.id
    
    logger.info(f"üîµ BMW –≤—ã–±—Ä–∞–Ω user_id={user_id}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∫–∞–∑–∞–Ω –ª–∏ SIP —Å–µ–≥–æ–¥–Ω—è
    if db.is_sip_valid_today(user_id):
        # SIP —É–∫–∞–∑–∞–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ—à–∏–±–æ–∫
        sip_data = db.get_manager_sip(user_id)
        sip = sip_data['sip_number']
        
        logger.info(f"‚úÖ SIP —É–∂–µ —É–∫–∞–∑–∞–Ω —Å–µ–≥–æ–¥–Ω—è: {sip}")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º SIP –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        context.user_data["bmw_sip"] = sip
        
        await update.message.reply_text(
            MESSAGES["choose_quick_error"].format(sip=sip),
            reply_markup=get_quick_errors_keyboard()
        )
        return SHOWING_ERRORS  # ‚úÖ –ü–ï–†–ï–•–û–î –í –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–ö–ê–ó–ê –ö–ù–û–ü–û–ö
    else:
        # SIP –Ω–µ —É–∫–∞–∑–∞–Ω - –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏
        logger.info(f"‚ö†Ô∏è SIP –Ω–µ —É–∫–∞–∑–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É user_id={user_id}")
        
        await update.message.reply_text(MESSAGES["sip_prompt"])
        return WAITING_SIP


async def handle_sip_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ SIP –Ω–æ–º–µ—Ä–∞
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        WAITING_SIP –ø—Ä–∏ –æ—à–∏–±–∫–µ, SHOWING_ERRORS –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    """
    user_id = update.effective_user.id
    sip_text = update.message.text.strip()
    
    logger.info(f"üìû –í–≤–µ–¥—ë–Ω SIP –æ—Ç user_id={user_id}: {sip_text}")
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è SIP
    if not sip_text or len(sip_text) > MAX_SIP_LENGTH:
        await update.message.reply_text(MESSAGES["sip_invalid"])
        return WAITING_SIP
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º SIP –≤ –ë–î –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
    db.save_manager_sip(user_id, sip_text)
    context.user_data["bmw_sip"] = sip_text
    
    logger.info(f"‚úÖ SIP —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è user_id={user_id}: {sip_text}")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ—à–∏–±–æ–∫
    await update.message.reply_text(
        MESSAGES["sip_saved"].format(sip=sip_text),
        reply_markup=get_quick_errors_keyboard()
    )
    
    return SHOWING_ERRORS  # ‚úÖ –ü–ï–†–ï–•–û–î –ö –í–´–ë–û–†–£ –û–®–ò–ë–ö–ò


async def handle_quick_error_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –±—ã—Å—Ç—Ä–æ–π –æ—à–∏–±–∫–∏ (1-9 –∏–ª–∏ 10)
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        WAITING_CUSTOM_ERROR –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç", –∏–Ω–∞—á–µ ConversationHandler.END
    """
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    username = update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –æ—à–∏–±–∫–∏ (qerr_1 ‚Üí 1)
    error_code = query.data.split("_")[1]
    
    logger.info(f"üîò –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –æ—à–∏–±–∫–∏ {error_code} –æ—Ç user_id={user_id}")
    
    # –ü–æ–ª—É—á–∞–µ–º SIP –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    sip = context.user_data.get("bmw_sip")
    
    if not sip:
        logger.error(f"‚ùå SIP –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è user_id={user_id}")
        await query.message.edit_text(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞: SIP –Ω–µ –Ω–∞–π–¥–µ–Ω.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –º–µ–Ω—é '–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏' ‚Üí 'BMW'"
        )
        return ConversationHandler.END
    
    # –ï—Å–ª–∏ "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç" - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É —Ç–µ–∫—Å—Ç–∞
    if error_code == "10":
        logger.info(f"‚úèÔ∏è –í—ã–±—Ä–∞–Ω —Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç, –æ–∂–∏–¥–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç user_id={user_id}")
        
        await query.message.edit_text(MESSAGES["custom_error_prompt"])
        return WAITING_CUSTOM_ERROR  # ‚úÖ –ü–ï–†–ï–•–û–î –í –°–û–°–¢–û–Ø–ù–ò–ï –û–ñ–ò–î–ê–ù–ò–Ø –¢–ï–ö–°–¢–ê
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
    error_text = QUICK_ERRORS.get(error_code, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
    
    logger.info(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –±—ã—Å—Ç—Ä–æ–π –æ—à–∏–±–∫–∏: {error_text}")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≥—Ä—É–ø–ø—É BMW
    success = await send_quick_error_to_group(
        context.bot, user_id, username, sip, error_text
    )
    
    if not success:
        await query.message.edit_text("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await query.message.edit_text(
        MESSAGES["quick_error_sent"].format(sip=sip, error=error_text)
    )
    
    # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context.user_data.pop("bmw_sip", None)
    
    return ConversationHandler.END


async def handle_custom_error_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Å–≤–æ–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—à–∏–±–∫–∏
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        WAITING_CUSTOM_ERROR –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, ConversationHandler.END –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
    """
    user_id = update.effective_user.id
    username = update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    error_text = update.message.text.strip()
    sip = context.user_data.get("bmw_sip")
    
    logger.info(f"‚úèÔ∏è Custom –æ—à–∏–±–∫–∞ –æ—Ç user_id={user_id}: {error_text[:50]}...")
    
    if not sip:
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: SIP –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        context.user_data.pop("bmw_sip", None)
        return ConversationHandler.END
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    if not error_text or len(error_text) > MAX_CUSTOM_ERROR_LENGTH:
        await update.message.reply_text(
            f"‚ö†Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ {MAX_CUSTOM_ERROR_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤.\n"
            f"–°–µ–π—á–∞—Å: {len(error_text)} —Å–∏–º–≤–æ–ª–æ–≤"
        )
        return WAITING_CUSTOM_ERROR  # –û—Å—Ç–∞—ë–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –≥—Ä—É–ø–ø—É
    success = await send_quick_error_to_group(
        context.bot, user_id, username, sip, error_text
    )
    
    if not success:
        await update.message.reply_text("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        context.user_data.pop("bmw_sip", None)
        return ConversationHandler.END
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    role = get_user_role(context)
    current_menu = get_menu_by_role(role)
    
    await update.message.reply_text(
        MESSAGES["quick_error_sent"].format(sip=sip, error=error_text),
        reply_markup=current_menu
    )
    
    # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context.user_data.pop("bmw_sip", None)
    
    return ConversationHandler.END


async def handle_change_sip_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ò–∑–º–µ–Ω–∏—Ç—å SIP"
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        WAITING_SIP –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–≤–æ–¥–∞ SIP
    """
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    logger.info(f"‚öôÔ∏è –ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ SIP –æ—Ç user_id={user_id}")
    
    await query.message.edit_text(MESSAGES["sip_prompt"])
    
    return WAITING_SIP


async def send_quick_error_to_group(bot, user_id: int, username: str, sip: str, error_text: str) -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±—ã—Å—Ç—Ä—É—é –æ—à–∏–±–∫—É –≤ –≥—Ä—É–ø–ø—É BMW
    
    Args:
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
        user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        sip: SIP –Ω–æ–º–µ—Ä
        error_text: –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        
    Returns:
        True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
    """
    group_id = settings.BMW_GROUP_ID
    tel_code = "bmw"
    
    # –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
    msg = f"–û—Ç {username}\nSIP: {sip}  {error_text}"
    
    # –ö–Ω–æ–ø–∫–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞
    from keyboards.inline import get_support_keyboard
    keyboard = get_support_keyboard(user_id, tel_code)
    
    try:
        await bot.send_message(
            chat_id=group_id,
            text=msg,
            reply_markup=keyboard
        )
        
        # –õ–æ–≥–∏—Ä—É–µ–º –≤ –ë–î
        db.log_error_report(user_id, username, tel_code, f"SIP: {sip} - {error_text}")
        
        logger.info(f"‚úÖ –ë—ã—Å—Ç—Ä–∞—è –æ—à–∏–±–∫–∞ BMW –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞: user_id={user_id}, SIP={sip}, error={error_text}")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—ã—Å—Ç—Ä–æ–π –æ—à–∏–±–∫–∏: {e}", exc_info=True)
        return False


# ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô ConversationHandler (–ë–ï–ó per_message)
quick_bmw_conv = ConversationHandler(
    entry_points=[
        # –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "BMW" –∑–∞–ø—É—Å–∫–∞–µ—Ç conversation
        MessageHandler(filters.Regex("^BMW$") & filters.ChatType.PRIVATE, handle_bmw_choice)
    ],
    states={
        WAITING_SIP: [
            # –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ SIP
            MessageHandler(filters.TEXT & ~filters.COMMAND & filters.ChatType.PRIVATE, handle_sip_input),
        ],
        SHOWING_ERRORS: [
            # ‚úÖ CALLBACK –ö–ù–û–ü–û–ö –†–ê–ë–û–¢–ê–Æ–¢ –¢–û–õ–¨–ö–û –í –≠–¢–û–ú –°–û–°–¢–û–Ø–ù–ò–ò
            CallbackQueryHandler(handle_quick_error_callback, pattern="^qerr_"),
            CallbackQueryHandler(handle_change_sip_callback, pattern="^change_sip$"),
        ],
        WAITING_CUSTOM_ERROR: [
            # –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ custom –æ—à–∏–±–∫–∏
            MessageHandler(filters.TEXT & ~filters.COMMAND & filters.ChatType.PRIVATE, handle_custom_error_input)
        ]
    },
    fallbacks=[
        # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å /cancel –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    ],
    allow_reentry=True,
    # ‚úÖ –£–ë–†–ê–ù–û per_message - –Ω–µ –Ω—É–∂–Ω–æ –¥–ª—è MessageHandler
    per_chat=True,
    per_user=True
)
=== ./handlers/commands.py ===
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞
"""
from telegram import Update
from telegram.ext import ContextTypes
from config.constants import MESSAGES
from services.user_service import user_service
from database.models import db
from keyboards.reply import get_manager_menu, get_admin_menu, get_pult_menu
from utils.state import clear_all_states
from utils.logger import logger


async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    user_id = update.effective_user.id
    username = update.effective_user.username
    first_name = update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    if not user_service.has_access(user_id):
        user_service.log_access_denied(user_id)
        await update.message.reply_text(MESSAGES["access_denied"])
        return
    
    # –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    clear_all_states(context)
    
    # ===== –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–§–û–†–ú–ê–¶–ò–ò –í –ë–î =====
    # –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ –µ—Å—Ç—å –≤ –ë–î, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ username/first_name
    if db.is_manager(user_id):
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            cursor.execute(
                "UPDATE managers SET username = ?, first_name = ? WHERE user_id = ?",
                (username, first_name, user_id)
            )
            conn.commit()
            conn.close()
            logger.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ {user_id}: {username}, {first_name}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∞–¥–º–∏–Ω > –ø—É–ª—å—Ç > –º–µ–Ω–µ–¥–∂–µ—Ä)
    if user_service.is_admin(user_id):
        # –ê–¥–º–∏–Ω - –∞–¥–º–∏–Ω –º–µ–Ω—é
        context.user_data["role"] = "admin"
        user_service.log_user_start(user_id, first_name, "–∞–¥–º–∏–Ω")
        
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç, {first_name}!\n\n"
            f"üëë –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=get_admin_menu()
        )
    elif user_service.is_pult(user_id):
        # –ü—É–ª—å—Ç - –º–µ–Ω—é –ø—É–ª—å—Ç–∞
        context.user_data["role"] = "pult"
        user_service.log_user_start(user_id, first_name, "–ø—É–ª—å—Ç")
        
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç, {first_name}!\n\n"
            f"üìä –†–µ–∂–∏–º –ø—É–ª—å—Ç–∞\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=get_pult_menu()
        )
    else:
        # –ú–µ–Ω–µ–¥–∂–µ—Ä - –º–µ–Ω—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        context.user_data["role"] = "manager"
        user_service.log_user_start(user_id, first_name, "–º–µ–Ω–µ–¥–∂–µ—Ä")
        
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç, {first_name}!\n\n"
            f"–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
            reply_markup=get_manager_menu()
        )
=== ./handlers/messages.py ===
"""
–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è handlers/messages.py - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ —á–µ—Ä–µ–∑ Reply –∫–Ω–æ–ø–∫–∏
"""
from telegram import Update, error as telegram_error
from telegram.ext import ContextTypes

from config.settings import settings
from config.constants import MESSAGES
from services.user_service import user_service
from services.telephony_service import telephony_service
from keyboards.reply import get_menu_by_role
from utils.state import (
    get_user_role, is_support_mode, set_support_mode,
    get_tel_choice, clear_tel_choice, is_tel_choice_expired,
    set_tel_choice  # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
)
from utils.logger import logger
from handlers.menu import handle_menu_button


async def handle_support_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"""
    if not is_support_mode(context):
        return False
    
    support_msg = (
        f"üí¨ <b>–í–æ–ø—Ä–æ—Å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</b>\n\n"
        f"üë§ –û—Ç: {update.effective_user.first_name}\n"
        f"üÜî ID: {update.effective_user.id}\n"
        f"{'‚îÄ' * 30}\n"
        f"üìù –í–æ–ø—Ä–æ—Å:\n{update.message.text}"
    )
    
    try:
        for admin_id in settings.ADMINS:
            try:
                await context.bot.send_message(
                    chat_id=admin_id,
                    text=support_msg,
                    parse_mode="HTML"
                )
            except telegram_error.TelegramError as e:
                logger.error(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É {admin_id}: {e}")
        
        role = get_user_role(context)
        current_menu = get_menu_by_role(role)
        
        await update.message.reply_text(
            MESSAGES["support_sent"],
            reply_markup=current_menu
        )
        logger.info(f"‚úÖ –í–æ–ø—Ä–æ—Å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç user_id={update.effective_user.id}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: {e}", exc_info=True)
        await update.message.reply_text(
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
    
    set_support_mode(context, False)
    return True


# ‚úÖ –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏–∑ Reply –º–µ–Ω—é
async def handle_telephony_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏–∑ Reply –∫–Ω–æ–ø–æ–∫ (BMW, –ó–≤–æ–Ω–∞—Ä–∏)
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        True –µ—Å–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–∞–∫ –≤—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    """
    text = update.message.text
    
    # –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π
    from database.models import db
    telephonies = db.get_all_telephonies()
    
    # –°–æ–∑–¥–∞—ë–º —Å–ª–æ–≤–∞—Ä—å –Ω–∞–∑–≤–∞–Ω–∏–µ ‚Üí –∫–æ–¥
    tel_map = {}
    if telephonies:
        for tel in telephonies:
            tel_map[tel['name']] = tel['code']
    else:
        # –§–æ–ª–±—ç–∫ –Ω–∞ —Å—Ç–∞—Ä—ã–µ
        tel_map = {"BMW": "bmw", "–ó–≤–æ–Ω–∞—Ä–∏": "zvon"}
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    if text in tel_map:
        tel_name = text
        tel_code = tel_map[text]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
        set_tel_choice(context, tel_name, tel_code)
        
        logger.info(f"‚úÖ User {update.effective_user.id} –≤—ã–±—Ä–∞–ª —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é: {tel_name} ({tel_code})")
        
        await update.message.reply_text(
            f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏: <b>{tel_name}</b>\n\n"
            f"üìù –¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏",
            parse_mode="HTML"
        )
        return True
    
    return False


async def handle_error_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    user_id = update.effective_user.id
    username = update.effective_user.first_name or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    role = get_user_role(context)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    tel, tel_code = get_tel_choice(context)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ timeout
    if tel and is_tel_choice_expired(context):
        clear_tel_choice(context)
        tel = None
        tel_code = None
        logger.info(f"‚è± –ò—Å—Ç—ë–∫ timeout –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –¥–ª—è user_id={user_id}")
    
    # –ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
    if not tel or not tel_code:
        current_menu = get_menu_by_role(role)
        await update.message.reply_text(
            "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É '–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏'",
            reply_markup=current_menu
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º ID –≥—Ä—É–ø–ø—ã
    group_id = telephony_service.get_group_id(tel)
    if not group_id:
        logger.error(f"‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {tel}")
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –≥—Ä—É–ø–ø–∞ –¥–ª—è —ç—Ç–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏.")
        return
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
    error_text = update.message.text or update.message.caption or ""
    has_media = bool(update.message.photo or update.message.document)
    
    is_valid, error_msg = telephony_service.validate_error_text(error_text, has_media)
    if not is_valid:
        await update.message.reply_text(error_msg)
        return
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≥—Ä—É–ø–ø—É
    success = await telephony_service.send_error_to_group(
        context.bot,
        update,
        context,
        group_id,
        tel_code,
        username,
        error_text
    )
    
    if not success:
        await update.message.reply_text(
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –≤ —Å–∞–ø–ø–æ—Ä—Ç.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )
        return
    
    # –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –º–µ–Ω—é
    clear_tel_choice(context)
    current_menu = get_menu_by_role(role)
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    success_msg = telephony_service.get_success_message(tel_code, tel)
    
    await update.message.reply_text(
        success_msg,
        parse_mode="HTML",
        reply_markup=current_menu
    )


async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    if not user_service.has_access(user_id):
        return
    
    text = update.message.text
    if not text:
        return
    
    logger.debug(f"üì® –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç user_id={user_id}: '{text[:50]}...'")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    if await handle_support_message(update, context):
        return
    
    # ‚úÖ –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (BMW, –ó–≤–æ–Ω–∞—Ä–∏)
    if await handle_telephony_choice(update, context):
        return
    
    # –°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
    menu_texts = {
        "–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏", "–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏",
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤", 
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫",
        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º",
        "‚óÄÔ∏è –ú–µ–Ω—é"  # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
    }
    
    # –ï—Å–ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é
    if text in menu_texts:
        await handle_menu_button(update, context)
    else:
        # –ò–Ω–∞—á–µ - —ç—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
        await handle_error_message(update, context)
=== ./handlers/management.py ===
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
"""
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler

from services.management_service import management_service
from services.user_service import user_service
from keyboards.inline import get_management_menu, get_telephony_type_keyboard
from utils.logger import logger


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
(WAITING_MANAGER_ID, WAITING_MANAGER_ID_REMOVE,
 WAITING_TEL_NAME, WAITING_TEL_CODE, WAITING_TEL_TYPE, WAITING_TEL_GROUP,
 WAITING_TEL_CODE_REMOVE, WAITING_BROADCAST_MESSAGE) = range(8)


# ===== –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ –£–ü–†–ê–í–õ–ï–ù–ò–Ø =====

async def show_management_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"""
    query = update.callback_query
    if query:
        await query.answer()
    
    keyboard = get_management_menu()
    text = (
        "‚öôÔ∏è <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )
    
    if query:
        await query.message.edit_text(text, parse_mode="HTML", reply_markup=keyboard)
    else:
        await update.message.reply_text(text, parse_mode="HTML", reply_markup=keyboard)


# ===== –ú–ï–ù–ï–î–ñ–ï–†–´ =====

async def managers_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏"""
    query = update.callback_query
    await query.answer()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞", callback_data="mgmt_add_manager")],
        [InlineKeyboardButton("‚ûñ –£–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞", callback_data="mgmt_remove_manager")],
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤", callback_data="mgmt_list_managers")],
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="mgmt_menu")]
    ])
    
    await query.message.edit_text(
        "üë• <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def list_managers(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
    query = update.callback_query
    await query.answer()
    
    text = management_service.get_managers_list()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="mgmt_managers")]
    ])
    
    await query.message.edit_text(text, parse_mode="HTML", reply_markup=keyboard)


async def add_manager_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    query = update.callback_query
    await query.answer()
    
    await query.message.edit_text(
        "‚ûï <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–∏—Å–ª–æ) –∏–ª–∏ –ø–µ—Ä–µ—à–ª–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–µ–≥–æ.\n\n"
        "–û—Ç–º–µ–Ω–∞: /cancel",
        parse_mode="HTML"
    )
    
    return WAITING_MANAGER_ID


async def add_manager_process(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    # –ï—Å–ª–∏ –ø–µ—Ä–µ—Å–ª–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if update.message.forward_from:
        user_id = update.message.forward_from.id
        username = update.message.forward_from.username
        first_name = update.message.forward_from.first_name
    else:
        # –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–ª–∏ ID
        try:
            user_id = int(update.message.text.strip())
            username = None
            first_name = None
        except ValueError:
            await update.message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –∏–ª–∏ –ø–µ—Ä–µ—à–ª–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–µ–≥–æ."
            )
            return WAITING_MANAGER_ID
    
    # –î–æ–±–∞–≤–ª—è–µ–º
    success, message = management_service.add_manager(
        user_id, username, first_name, update.effective_user.id
    )
    
    await update.message.reply_text(message, parse_mode="HTML")
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ–Ω—é
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("¬´ –ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏", callback_data="mgmt_managers")]
    ])
    await update.message.reply_text("–ì–æ—Ç–æ–≤–æ!", reply_markup=keyboard)
    
    return ConversationHandler.END


async def remove_manager_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    query = update.callback_query
    await query.answer()
    
    await query.message.edit_text(
        "‚ûñ <b>–£–¥–∞–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.\n\n"
        "–û—Ç–º–µ–Ω–∞: /cancel",
        parse_mode="HTML"
    )
    
    return WAITING_MANAGER_ID_REMOVE


async def remove_manager_process(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
    try:
        user_id = int(update.message.text.strip())
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).")
        return WAITING_MANAGER_ID_REMOVE
    
    success, message = management_service.remove_manager(user_id)
    
    await update.message.reply_text(message, parse_mode="HTML")
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("¬´ –ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏", callback_data="mgmt_managers")]
    ])
    await update.message.reply_text("–ì–æ—Ç–æ–≤–æ!", reply_markup=keyboard)
    
    return ConversationHandler.END


# ===== –¢–ï–õ–ï–§–û–ù–ò–ò =====

async def telephonies_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º–∏"""
    query = update.callback_query
    await query.answer()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é", callback_data="mgmt_add_tel")],
        [InlineKeyboardButton("‚ûñ –£–¥–∞–ª–∏—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é", callback_data="mgmt_remove_tel")],
        [InlineKeyboardButton("üìã –°–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π", callback_data="mgmt_list_tel")],
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="mgmt_menu")]
    ])
    
    await query.message.edit_text(
        "üìû <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def list_telephonies(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π"""
    query = update.callback_query
    await query.answer()
    
    text = management_service.get_telephonies_list()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="mgmt_telephonies")]
    ])
    
    await query.message.edit_text(text, parse_mode="HTML", reply_markup=keyboard)


async def add_telephony_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ - –∑–∞–ø—Ä–æ—Å –Ω–∞–∑–≤–∞–Ω–∏—è"""
    query = update.callback_query
    await query.answer()
    
    await query.message.edit_text(
        "‚ûï <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏</b>\n\n"
        "–®–∞–≥ 1/4: –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏\n"
        "(–ù–∞–ø—Ä–∏–º–µ—Ä: BMW, –ú–µ–≥–∞—Ñ–æ–Ω, –ë–∏–ª–∞–π–Ω)\n\n"
        "–û—Ç–º–µ–Ω–∞: /cancel",
        parse_mode="HTML"
    )
    
    return WAITING_TEL_NAME


async def add_telephony_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è, –∑–∞–ø—Ä–æ—Å –∫–æ–¥–∞"""
    name = update.message.text.strip()
    context.user_data['tel_name'] = name
    
    await update.message.reply_text(
        f"‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{name}</b>\n\n"
        f"–®–∞–≥ 2/4: –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (–ª–∞—Ç–∏–Ω–∏—Ü–∞, lowercase)\n"
        f"(–ù–∞–ø—Ä–∏–º–µ—Ä: bmw, megafon, beeline)\n"
        f"–ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ callback –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º.",
        parse_mode="HTML"
    )
    
    return WAITING_TEL_CODE


async def add_telephony_code(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞, –∑–∞–ø—Ä–æ—Å —Ç–∏–ø–∞"""
    code = update.message.text.strip().lower()
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
    if not code.isalnum():
        await update.message.reply_text(
            "‚ùå –ö–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã!\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:"
        )
        return WAITING_TEL_CODE
    
    context.user_data['tel_code'] = code
    
    keyboard = get_telephony_type_keyboard()
    
    await update.message.reply_text(
        f"‚úÖ –ö–æ–¥: <code>{code}</code>\n\n"
        f"–®–∞–≥ 3/4: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏:",
        parse_mode="HTML",
        reply_markup=keyboard
    )
    
    return WAITING_TEL_TYPE


async def add_telephony_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∏–ø–∞, –∑–∞–ø—Ä–æ—Å ID –≥—Ä—É–ø–ø—ã"""
    query = update.callback_query
    await query.answer()
    
    tel_type = query.data.split("_")[2]  # tel_type_white –∏–ª–∏ tel_type_black
    context.user_data['tel_type'] = tel_type
    
    type_name = "‚ö™Ô∏è –ë–µ–ª–∞—è (—Å –∫–Ω–æ–ø–∫–∞–º–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞)" if tel_type == "white" else "‚ö´Ô∏è –ß—ë—Ä–Ω–∞—è (–±–µ–∑ –∫–Ω–æ–ø–æ–∫)"
    
    await query.message.edit_text(
        f"‚úÖ –¢–∏–ø: {type_name}\n\n"
        f"–®–∞–≥ 4/4: –í–≤–µ–¥–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—à–∏–±–æ–∫\n"
        f"(–î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å '-', –Ω–∞–ø—Ä–∏–º–µ—Ä: -1001234567890)\n\n"
        f"<b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å ID –≥—Ä—É–ø–ø—ã:</b>\n"
        f"1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ @userinfobot –≤ –≥—Ä—É–ø–ø—É\n"
        f"2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Chat ID\n"
        f"3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—é–¥–∞",
        parse_mode="HTML"
    )
    
    return WAITING_TEL_GROUP


async def add_telephony_group(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥ - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    try:
        group_id = int(update.message.text.strip())
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: -1001234567890)")
        return WAITING_TEL_GROUP
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    name = context.user_data.get('tel_name')
    code = context.user_data.get('tel_code')
    tel_type = context.user_data.get('tel_type')
    
    # –î–æ–±–∞–≤–ª—è–µ–º
    success, message = management_service.add_telephony(
        name, code, tel_type, group_id, update.effective_user.id
    )
    
    await update.message.reply_text(message, parse_mode="HTML")
    
    # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    context.user_data.pop('tel_name', None)
    context.user_data.pop('tel_code', None)
    context.user_data.pop('tel_type', None)
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("¬´ –ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º–∏", callback_data="mgmt_telephonies")]
    ])
    await update.message.reply_text("–ì–æ—Ç–æ–≤–æ!", reply_markup=keyboard)
    
    return ConversationHandler.END


async def remove_telephony_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    query = update.callback_query
    await query.answer()
    
    await query.message.edit_text(
        "‚ûñ <b>–£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.\n"
        "(–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥—ã: /cancel ‚Üí –°–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π)\n\n"
        "–û—Ç–º–µ–Ω–∞: /cancel",
        parse_mode="HTML"
    )
    
    return WAITING_TEL_CODE_REMOVE


async def remove_telephony_process(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
    code = update.message.text.strip().lower()
    
    success, message = management_service.remove_telephony(code)
    
    await update.message.reply_text(message, parse_mode="HTML")
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("¬´ –ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º–∏", callback_data="mgmt_telephonies")]
    ])
    await update.message.reply_text("–ì–æ—Ç–æ–≤–æ!", reply_markup=keyboard)
    
    return ConversationHandler.END


# ===== –†–ê–°–°–´–õ–ö–ê =====

async def broadcast_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    await query.message.edit_text(
        "üì¢ <b>–†–∞—Å—Å—ã–ª–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –¥–æ–∫—É–º–µ–Ω—Ç –∏ —Ç.–¥.)\n"
        "–û–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –í–°–ï–ú –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º.\n\n"
        "–û—Ç–º–µ–Ω–∞: /cancel",
        parse_mode="HTML"
    )
    
    return WAITING_BROADCAST_MESSAGE


async def broadcast_process(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –î–∞, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å", callback_data="broadcast_confirm"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="mgmt_menu")
        ]
    ])
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∫–æ–ø–∏–∏
    context.user_data['broadcast_message_id'] = update.message.message_id
    context.user_data['broadcast_chat_id'] = update.message.chat_id
    
    await update.message.reply_text(
        "üì® –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º:",
        reply_markup=keyboard
    )
    
    return ConversationHandler.END


async def broadcast_confirm(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
    query = update.callback_query
    await query.answer("–û—Ç–ø—Ä–∞–≤–ª—è—é —Ä–∞—Å—Å—ã–ª–∫—É...")
    
    message_id = context.user_data.get('broadcast_message_id')
    chat_id = context.user_data.get('broadcast_chat_id')
    
    if not message_id or not chat_id:
        await query.message.edit_text("‚ùå –û—à–∏–±–∫–∞: —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return
    
    await query.message.edit_text("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏...\n–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è.")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é
    try:
        from database.models import db
        managers = db.get_all_managers()
        
        stats = {
            "total": len(managers),
            "success": 0,
            "failed": 0,
            "failed_ids": []
        }
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É
        for manager in managers:
            user_id = manager['user_id']
            
            try:
                # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é
                await context.bot.copy_message(
                    chat_id=user_id,
                    from_chat_id=chat_id,
                    message_id=message_id
                )
                stats["success"] += 1
                logger.info(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ user_id={user_id}")
                
            except Exception as e:
                stats["failed"] += 1
                stats["failed_ids"].append(user_id)
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É user_id={user_id}: {e}")
        
        logger.info(f"üìä –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {stats['success']}/{stats['total']} —É—Å–ø–µ—à–Ω–æ")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏: {e}", exc_info=True)
        await query.message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ä–∞—Å—Å—ã–ª–∫–∏")
        return
    
    result_text = (
        f"‚úÖ <b>–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
        f"‚Ä¢ –í—Å–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {stats['total']}\n"
        f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ: {stats['success']}\n"
        f"‚Ä¢ –û—à–∏–±–æ–∫: {stats['failed']}"
    )
    
    if stats['failed'] > 0:
        result_text += f"\n\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: {len(stats['failed_ids'])} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="mgmt_menu")]
    ])
    
    await query.message.edit_text(result_text, parse_mode="HTML", reply_markup=keyboard)
    
    # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    context.user_data.pop('broadcast_message_id', None)
    context.user_data.pop('broadcast_chat_id', None)


# ===== –û–¢–ú–ï–ù–ê =====

async def cancel_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏"""
    await update.message.reply_text(
        "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("¬´ –ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é", callback_data="mgmt_menu")]
        ])
    )
    
    # –û—á–∏—â–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context.user_data.pop('tel_name', None)
    context.user_data.pop('tel_code', None)
    context.user_data.pop('tel_type', None)
    context.user_data.pop('broadcast_message_id', None)
    context.user_data.pop('broadcast_chat_id', None)
    
    return ConversationHandler.END
=== ./handlers/menu.py ===
"""
–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è handlers/menu.py - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø
–ò–∑–º–µ–Ω—ë–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏" - —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Reply –º–µ–Ω—é
"""
from telegram import Update
from telegram.ext import ContextTypes

from config.constants import USEFUL_LINKS, MESSAGES
from keyboards.reply import get_menu_by_role, get_telephony_menu  # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
from keyboards.inline import get_management_menu
from utils.state import get_user_role, set_support_mode, clear_tel_choice
from utils.logger import logger


async def handle_support_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–¥–µ—Ä–∂–∫–∞"""
    set_support_mode(context, True)
    await update.message.reply_text(MESSAGES["support_prompt"])


# ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Reply –º–µ–Ω—é –≤–º–µ—Å—Ç–æ Inline
async def handle_telephony_errors_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤—ã–±–æ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    clear_tel_choice(context)  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
    
    await update.message.reply_text(
        MESSAGES["choose_telephony"],
        reply_markup=get_telephony_menu()  # ‚úÖ Reply –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    )


async def handle_useful_links_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏"""
    links_text = "üîó <b>–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:</b>\n\n"
    for i, (name, url) in enumerate(USEFUL_LINKS.items(), 1):
        links_text += f"{i}. <a href='{url}'>{name}</a>\n"
    
    await update.message.reply_text(links_text, parse_mode="HTML")


async def handle_stats_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫" (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ –≤ –ª–∏—á–∫–µ)"""
    try:
        from services.stats_service import stats_service
        
        stats_text = await stats_service.get_perezvoni_stats()
        await update.message.reply_text(stats_text, parse_mode="HTML")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}", exc_info=True)
        await update.message.reply_text(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.\n"
            "Google Sheets API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.\n"
            "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
        )


async def handle_managers_stats_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
    try:
        from services.managers_stats_service import managers_stats_service
        
        stats_text = await managers_stats_service.get_managers_stats()
        await update.message.reply_text(stats_text, parse_mode="HTML")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}", exc_info=True)
        await update.message.reply_text(
            "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )


async def handle_bot_management_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º"""
    keyboard = get_management_menu()
    
    await update.message.reply_text(
        "‚öôÔ∏è <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def handle_errors_stats_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫' - —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–∞—à–±–æ—Ä–¥"""
    from services.analytics_service import analytics_service
    from handlers.analytics import get_dashboard_navigation
    
    stats_text = analytics_service.get_dashboard_overview("today")
    keyboard = get_dashboard_navigation(page=1, period="today")
    
    await update.message.reply_text(
        stats_text,
        parse_mode="HTML",
        reply_markup=keyboard
    )


# ‚úÖ –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "‚óÄÔ∏è –ú–µ–Ω—é" - –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
async def handle_back_to_menu_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "‚óÄÔ∏è –ú–µ–Ω—é" - –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    role = get_user_role(context)
    current_menu = get_menu_by_role(role)
    
    await update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é:",
        reply_markup=current_menu
    )


async def handle_menu_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ì–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
    
    Args:
        update: Update –æ–±—ä–µ–∫—Ç
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    text = update.message.text
    role = get_user_role(context)
    user_id = update.effective_user.id
    
    logger.debug(f"–ö–Ω–æ–ø–∫–∞ '{text}' –æ—Ç user_id={user_id}, —Ä–æ–ª—å={role}")
    
    # –ï—Å–ª–∏ —Ä–æ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    if not role:
        await update.message.reply_text(MESSAGES["session_expired"])
        return
    
    # –ú–∞–ø–ø–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏
    menu_actions = {
        "–û—à–∏–±–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏": handle_telephony_errors_button,
        "–ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏": handle_useful_links_button,
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫": handle_stats_button,
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤": handle_managers_stats_button,
        "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º": handle_bot_management_button,
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫": handle_errors_stats_button,
        "‚óÄÔ∏è –ú–µ–Ω—é": handle_back_to_menu_button,  # ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û
    }
    
    action = menu_actions.get(text)
    if action:
        await action(update, context)
    else:
        logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∫–Ω–æ–ø–∫–∏: '{text}' –æ—Ç user_id={user_id}")
        current_menu = get_menu_by_role(role)
        await update.message.reply_text(
            MESSAGES["unknown_command"],
            reply_markup=current_menu
        )
=== ./handlers/analytics.py ===
"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫
"""
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

from services.analytics_service import analytics_service
from utils.logger import logger


def get_dashboard_navigation(page: int, period: str = "today") -> InlineKeyboardMarkup:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –¥–∞—à–±–æ—Ä–¥—É
    
    Args:
        page: –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (1-4)
        period: –ü–µ—Ä–∏–æ–¥ ('today', 'week', 'month')
        
    Returns:
        InlineKeyboardMarkup —Å –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    """
    buttons = []
    
    # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
    nav_buttons = []
    if page > 1:
        nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data=f"dash_page_{page-1}_{period}"))
    if page < 4:
        nav_buttons.append(InlineKeyboardButton("–î–∞–ª–µ–µ ‚ñ∂Ô∏è", callback_data=f"dash_page_{page+1}_{period}"))
    
    if nav_buttons:
        buttons.append(nav_buttons)
    
    # –ü—Ä—è–º—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
    page_buttons = [
        InlineKeyboardButton("üìä" if page == 1 else "1", callback_data=f"dash_page_1_{period}"),
        InlineKeyboardButton("üë•" if page == 2 else "2", callback_data=f"dash_page_2_{period}"),
        InlineKeyboardButton("üõ†" if page == 3 else "3", callback_data=f"dash_page_3_{period}"),
        InlineKeyboardButton("‚è±" if page == 4 else "4", callback_data=f"dash_page_4_{period}")
    ]
    buttons.append(page_buttons)
    
    # –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞
    period_buttons = [
        InlineKeyboardButton("üìÖ" if period == "today" else "–°–µ–≥–æ–¥–Ω—è", callback_data=f"dash_page_{page}_today"),
        InlineKeyboardButton("üìÜ" if period == "week" else "–ù–µ–¥–µ–ª—è", callback_data=f"dash_page_{page}_week"),
        InlineKeyboardButton("üìä" if period == "month" else "–ú–µ—Å—è—Ü", callback_data=f"dash_page_{page}_month")
    ]
    buttons.append(period_buttons)
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    buttons.append([
        InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f"dash_page_{page}_{period}"),
        InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–∞—è", callback_data="stats_menu")
    ])
    
    return InlineKeyboardMarkup(buttons)


async def show_errors_stats_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º –ø–µ—Ä–∏–æ–¥–∞"""
    query = update.callback_query
    await query.answer()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="dash_start_today")],
        [InlineKeyboardButton("üìÜ –ù–µ–¥–µ–ª—è", callback_data="dash_start_week")],
        [InlineKeyboardButton("üìä –ú–µ—Å—è—Ü", callback_data="dash_start_month")],
    ])
    
    await query.message.edit_text(
        "üìä <b>–î–ê–®–ë–û–†–î –°–¢–ê–¢–ò–°–¢–ò–ö–ò –û–®–ò–ë–û–ö</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def show_dashboard_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –¥–∞—à–±–æ—Ä–¥ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º"""
    query = update.callback_query
    await query.answer("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞...")
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–∏–æ–¥ –∏–∑ callback_data
    period = query.data.split("_")[-1]  # today, week, month
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    stats_text = analytics_service.get_dashboard_overview(period)
    keyboard = get_dashboard_navigation(page=1, period=period)
    
    await query.message.edit_text(
        stats_text,
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def show_dashboard_page(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–∞—à–±–æ—Ä–¥–∞"""
    query = update.callback_query
    await query.answer("–ó–∞–≥—Ä—É–∑–∫–∞...")
    
    # –ü–∞—Ä—Å–∏–º callback_data: dash_page_2_today
    parts = query.data.split("_")
    page = int(parts[2])
    period = parts[3]
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if page == 1:
        stats_text = analytics_service.get_dashboard_overview(period)
    elif page == 2:
        stats_text = analytics_service.get_dashboard_managers(period)
    elif page == 3:
        stats_text = analytics_service.get_dashboard_support(period)
    elif page == 4:
        stats_text = analytics_service.get_dashboard_timing(period)
    else:
        stats_text = "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã"
    
    keyboard = get_dashboard_navigation(page=page, period=period)
    
    await query.message.edit_text(
        stats_text,
        parse_mode="HTML",
        reply_markup=keyboard
    )


# ===== –°–¢–ê–†–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) =====

async def show_general_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –¥–∞—à–±–æ—Ä–¥"""
    query = update.callback_query
    await query.answer()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="dash_start_today")],
        [InlineKeyboardButton("üìÜ –ù–µ–¥–µ–ª—è", callback_data="dash_start_week")],
        [InlineKeyboardButton("üìä –ú–µ—Å—è—Ü", callback_data="dash_start_month")],
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="stats_menu")]
    ])
    
    await query.message.edit_text(
        "üìä <b>–û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π –¥–∞—à–±–æ—Ä–¥?</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def show_general_stats_period(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–≥–ª—É—à–∫–∞ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –¥–∞—à–±–æ—Ä–¥"""
    await show_dashboard_start(update, context)


async def show_managers_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 2 –¥–∞—à–±–æ—Ä–¥–∞"""
    query = update.callback_query
    await query.answer()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="dash_page_2_today")],
        [InlineKeyboardButton("üìÜ –ù–µ–¥–µ–ª—è", callback_data="dash_page_2_week")],
        [InlineKeyboardButton("üìä –ú–µ—Å—è—Ü", callback_data="dash_page_2_month")],
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="stats_menu")]
    ])
    
    await query.message.edit_text(
        "üë• <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def show_managers_stats_period(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–≥–ª—É—à–∫–∞"""
    await show_dashboard_page(update, context)


async def show_support_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 3 –¥–∞—à–±–æ—Ä–¥–∞"""
    query = update.callback_query
    await query.answer()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="dash_page_3_today")],
        [InlineKeyboardButton("üìÜ –ù–µ–¥–µ–ª—è", callback_data="dash_page_3_week")],
        [InlineKeyboardButton("üìä –ú–µ—Å—è—Ü", callback_data="dash_page_3_month")],
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="stats_menu")]
    ])
    
    await query.message.edit_text(
        "üõ† <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∞–ø–ø–æ—Ä—Ç–∞</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def show_support_stats_period(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–≥–ª—É—à–∫–∞"""
    await show_dashboard_page(update, context)


async def show_response_time_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 4 –¥–∞—à–±–æ—Ä–¥–∞"""
    query = update.callback_query
    await query.answer()
    
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="dash_page_4_today")],
        [InlineKeyboardButton("üìÜ –ù–µ–¥–µ–ª—è", callback_data="dash_page_4_week")],
        [InlineKeyboardButton("üìä –ú–µ—Å—è—Ü", callback_data="dash_page_4_month")],
        [InlineKeyboardButton("¬´ –ù–∞–∑–∞–¥", callback_data="stats_menu")]
    ])
    
    await query.message.edit_text(
        "‚è± <b>–í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:",
        parse_mode="HTML",
        reply_markup=keyboard
    )


async def show_response_time_stats_period(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–≥–ª—É—à–∫–∞"""
    await show_dashboard_page(update, context)
=== ./database/__init__.py ===

=== ./database/models.py ===
"""
–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø: database/models.py
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

–ò–ó–ú–ï–ù–ï–ù–ò–Ø:
‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω race condition –≤ reset_all_sips
‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã context managers –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
"""
import sqlite3
from datetime import datetime, date, timedelta
from typing import List, Dict, Optional
from pathlib import Path
from contextlib import closing
from utils.logger import logger


class Database:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQLite –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö"""
    
    def __init__(self, db_path: str = "bot_data.db"):
        self.db_path = db_path
        self._create_tables()
    
    def _get_connection(self):
        """–°–æ–∑–¥–∞—ë—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î"""
        return sqlite3.connect(self.db_path)
    
    def _create_tables(self):
        """–°–æ–∑–¥–∞—ë—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã"""
        conn = self._get_connection()
        cursor = conn.cursor()
        
        # –¢–∞–±–ª–∏—Ü–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS managers (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                added_by INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS telephonies (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT UNIQUE NOT NULL,
                code TEXT UNIQUE NOT NULL,
                type TEXT NOT NULL CHECK(type IN ('white', 'black')),
                group_id INTEGER NOT NULL,
                enabled INTEGER DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_by INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ—à–∏–±–æ–∫
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS error_reports (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                username TEXT,
                telephony_code TEXT NOT NULL,
                description TEXT NOT NULL,
                status TEXT DEFAULT 'new',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                resolved_at TIMESTAMP,
                support_user_id INTEGER,
                support_username TEXT,
                support_action TEXT,
                response_time_seconds INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Å—ã–ª–æ–∫
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS broadcasts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                message_text TEXT,
                sent_by INTEGER,
                sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                recipients_count INTEGER,
                success_count INTEGER,
                failed_count INTEGER
            )
        """)
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ –¥–Ω—è–º
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS manager_daily_stats (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                username TEXT,
                first_name TEXT,
                date DATE NOT NULL,
                tubes_total INTEGER DEFAULT 0,
                tubes_green INTEGER DEFAULT 0,
                tubes_yellow INTEGER DEFAULT 0,
                tubes_purple INTEGER DEFAULT 0,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(user_id, date)
            )
        """)
        
        # ‚úÖ –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS manager_sips (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL UNIQUE,
                sip_number TEXT NOT NULL,
                last_updated DATE NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES managers(user_id)
            )
        """)
        
        conn.commit()
        conn.close()
        logger.info("‚úÖ –¢–∞–±–ª–∏—Ü—ã –ë–î —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
    
    # ===== –ú–ï–ù–ï–î–ñ–ï–†–´ =====
    
    def add_manager(self, user_id: int, username: str = None, 
                    first_name: str = None, added_by: int = None) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –ë–î"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO managers (user_id, username, first_name, added_by) VALUES (?, ?, ?, ?)",
                    (user_id, username, first_name, added_by)
                )
                conn.commit()
            logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ë–î")
            return True
        except sqlite3.IntegrityError:
            logger.warning(f"‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    def remove_manager(self, user_id: int) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("DELETE FROM managers WHERE user_id = ?", (user_id,))
                deleted = cursor.rowcount > 0
                conn.commit()
            if deleted:
                logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} —É–¥–∞–ª—ë–Ω")
            return deleted
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    def get_all_managers(self) -> List[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "SELECT user_id, username, first_name, added_at FROM managers ORDER BY added_at DESC"
                )
                rows = cursor.fetchall()
            
            return [
                {
                    "user_id": row[0],
                    "username": row[1],
                    "first_name": row[2],
                    "added_at": row[3]
                }
                for row in rows
            ]
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}")
            return []
    
    def is_manager(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("SELECT 1 FROM managers WHERE user_id = ?", (user_id,))
                exists = cursor.fetchone() is not None
            return exists
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    def update_manager_info(self, user_id: int, username: str = None, first_name: str = None) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ–Ω–µ–¥–∂–µ—Ä–µ"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "UPDATE managers SET username = ?, first_name = ? WHERE user_id = ?",
                    (username, first_name, user_id)
                )
                updated = cursor.rowcount > 0
                conn.commit()
            if updated:
                logger.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ {user_id}: {username}, {first_name}")
            return updated
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞: {e}")
            return False
    
    # ===== –¢–ï–õ–ï–§–û–ù–ò–ò =====
    
    def add_telephony(self, name: str, code: str, tel_type: str, 
                      group_id: int, created_by: int = None) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO telephonies (name, code, type, group_id, created_by) VALUES (?, ?, ?, ?, ?)",
                    (name, code.lower(), tel_type, group_id, created_by)
                )
                conn.commit()
            logger.info(f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è {name} ({tel_type}) –¥–æ–±–∞–≤–ª–µ–Ω–∞")
            return True
        except sqlite3.IntegrityError:
            logger.warning(f"‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω–∏—è {name} –∏–ª–∏ –∫–æ–¥ {code} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {e}")
            return False
    
    def remove_telephony(self, code: str) -> bool:
        """–£–¥–∞–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é –ø–æ –∫–æ–¥—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("DELETE FROM telephonies WHERE code = ?", (code,))
                deleted = cursor.rowcount > 0
                conn.commit()
            if deleted:
                logger.info(f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è {code} —É–¥–∞–ª–µ–Ω–∞")
            return deleted
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {e}")
            return False
    
    def get_all_telephonies(self) -> List[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "SELECT name, code, type, group_id, enabled FROM telephonies WHERE enabled = 1 ORDER BY name"
                )
                rows = cursor.fetchall()
            
            return [
                {
                    "name": row[0],
                    "code": row[1],
                    "type": row[2],
                    "group_id": row[3],
                    "enabled": row[4]
                }
                for row in rows
            ]
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π: {e}")
            return []
    
    def get_telephony_by_code(self, code: str) -> Optional[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é –ø–æ –∫–æ–¥—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "SELECT name, code, type, group_id, enabled FROM telephonies WHERE code = ?",
                    (code,)
                )
                row = cursor.fetchone()
            
            if row:
                return {
                    "name": row[0],
                    "code": row[1],
                    "type": row[2],
                    "group_id": row[3],
                    "enabled": row[4]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏: {e}")
            return None
    
    def update_telephony_group(self, code: str, new_group_id: int) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç ID –≥—Ä—É–ø–ø—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "UPDATE telephonies SET group_id = ? WHERE code = ?",
                    (new_group_id, code)
                )
                updated = cursor.rowcount > 0
                conn.commit()
            if updated:
                logger.info(f"‚úÖ –ì—Ä—É–ø–ø–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ {code} –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
            return updated
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã: {e}")
            return False
    
    # ===== –ò–°–¢–û–†–ò–Ø –û–®–ò–ë–û–ö =====
    
    def log_error_report(self, user_id: int, username: str, 
                        telephony_code: str, description: str) -> Optional[int]:
        """–õ–æ–≥–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –æ—à–∏–±–∫—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute(
                    "INSERT INTO error_reports (user_id, username, telephony_code, description) VALUES (?, ?, ?, ?)",
                    (user_id, username, telephony_code, description)
                )
                report_id = cursor.lastrowid
                conn.commit()
            return report_id
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–∫–∏: {e}")
            return None
    
    def update_error_report(self, report_id: int, support_user_id: int,
                           support_username: str, support_action: str,
                           response_time_seconds: int) -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ–± –æ—à–∏–±–∫–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∞–ø–ø–æ—Ä—Ç–æ–º"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    UPDATE error_reports 
                    SET resolved_at = CURRENT_TIMESTAMP,
                        support_user_id = ?,
                        support_username = ?,
                        support_action = ?,
                        response_time_seconds = ?,
                        status = 'resolved'
                    WHERE id = ?
                """, (support_user_id, support_username, support_action, response_time_seconds, report_id))
                updated = cursor.rowcount > 0
                conn.commit()
            if updated:
                logger.info(f"‚úÖ –û—à–∏–±–∫–∞ #{report_id} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –ë–î (–≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: {response_time_seconds//60}–º {response_time_seconds%60}—Å)")
            return updated
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—à–∏–±–∫–∏: {e}")
            return False
    
    # ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ú–ï–ù–ï–î–ñ–ï–†–û–í =====
    
    def upsert_manager_stats(self, user_id: int, username: str, first_name: str,
                            date_str: str, tubes_total: int, tubes_green: int = 0,
                            tubes_yellow: int = 0, tubes_purple: int = 0) -> bool:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∑–∞ –¥–µ–Ω—å"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT INTO manager_daily_stats 
                    (user_id, username, first_name, date, tubes_total, tubes_green, tubes_yellow, tubes_purple, updated_at)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                    ON CONFLICT(user_id, date) DO UPDATE SET
                        username = excluded.username,
                        first_name = excluded.first_name,
                        tubes_total = excluded.tubes_total,
                        tubes_green = excluded.tubes_green,
                        tubes_yellow = excluded.tubes_yellow,
                        tubes_purple = excluded.tubes_purple,
                        updated_at = CURRENT_TIMESTAMP
                """, (user_id, username, first_name, date_str, tubes_total, tubes_green, tubes_yellow, tubes_purple))
                conn.commit()
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ {user_id} ({first_name}) –∑–∞ {date_str} –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {tubes_total} —Ç—Ä—É–±–æ–∫")
            return True
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            import traceback
            logger.error(traceback.format_exc())
            return False
    
    def get_managers_stats_for_date(self, date_str: str) -> List[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT user_id, username, first_name, tubes_total, tubes_green, tubes_yellow, tubes_purple
                    FROM manager_daily_stats
                    WHERE date = ?
                    ORDER BY tubes_total DESC
                """, (date_str,))
                rows = cursor.fetchall()
            
            return [
                {
                    "user_id": row[0],
                    "username": row[1],
                    "name": row[2],
                    "tubes": row[3],
                    "green": row[4],
                    "yellow": row[5],
                    "purple": row[6]
                }
                for row in rows
            ]
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            return []
    
    def get_managers_stats_for_week(self, start_date: str, end_date: str) -> Dict[int, Dict[str, Dict]]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é (–ü–ù-–°–ë)"""
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT user_id, username, first_name, date, tubes_total, tubes_green, tubes_yellow, tubes_purple
                    FROM manager_daily_stats
                    WHERE date BETWEEN ? AND ?
                    ORDER BY user_id, date
                """, (start_date, end_date))
                rows = cursor.fetchall()
            
            result = {}
            for row in rows:
                user_id = row[0]
                if user_id not in result:
                    result[user_id] = {
                        "username": row[1],
                        "name": row[2],
                        "dates": {}
                    }
                
                date_key = row[3]
                result[user_id]["dates"][date_key] = {
                    "tubes": row[4],
                    "green": row[5],
                    "yellow": row[6],
                    "purple": row[7]
                }
            
            return result
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            return {}
    
    # ===== SIP –ú–ï–ù–ï–î–ñ–ï–†–û–í =====
    
    def save_manager_sip(self, user_id: int, sip_number: str) -> bool:
        """
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        
        Args:
            user_id: ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            sip_number: –ù–æ–º–µ—Ä SIP
            
        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            today = date.today().isoformat()
            
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT INTO manager_sips (user_id, sip_number, last_updated)
                    VALUES (?, ?, ?)
                    ON CONFLICT(user_id) DO UPDATE SET
                        sip_number = excluded.sip_number,
                        last_updated = excluded.last_updated
                """, (user_id, sip_number, today))
                conn.commit()
            
            logger.info(f"‚úÖ SIP —Å–æ—Ö—Ä–∞–Ω—ë–Ω –¥–ª—è user_id={user_id}: {sip_number}")
            return True
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è SIP: {e}")
            return False
    
    def get_manager_sip(self, user_id: int) -> Optional[Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        
        Args:
            user_id: ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            
        Returns:
            {'sip_number': str, 'last_updated': str} –∏–ª–∏ None
        """
        try:
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    SELECT sip_number, last_updated 
                    FROM manager_sips 
                    WHERE user_id = ?
                """, (user_id,))
                row = cursor.fetchone()
            
            if row:
                return {
                    'sip_number': row[0],
                    'last_updated': row[1]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è SIP: {e}")
            return None
    
    def is_sip_valid_today(self, user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —É–∫–∞–∑–∞–Ω –ª–∏ SIP —Å–µ–≥–æ–¥–Ω—è
        
        Args:
            user_id: ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            
        Returns:
            True –µ—Å–ª–∏ SIP —É–∫–∞–∑–∞–Ω —Å–µ–≥–æ–¥–Ω—è
        """
        sip_data = self.get_manager_sip(user_id)
        
        if not sip_data:
            return False
        
        today = date.today().isoformat()
        return sip_data['last_updated'] == today
    
    def reset_all_sips(self) -> int:
        """
        –°–±—Ä–æ—Å–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –≤—Å–µ—Ö SIP (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —É—Ç—Ä–æ–º –≤ 8:00)
        
        ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –Ω–µ –ø–µ—Ä–µ–∑–∞—Ç–∏—Ä–∞–µ—Ç SIP, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è
        
        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–±—Ä–æ—à–µ–Ω–Ω—ã—Ö SIP
        """
        try:
            yesterday = (date.today() - timedelta(days=1)).isoformat()
            today = date.today().isoformat()
            
            with closing(self._get_connection()) as conn:
                cursor = conn.cursor()
                
                # ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ SIP, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å–µ–≥–æ–¥–Ω—è
                # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç race condition –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
                cursor.execute("""
                    UPDATE manager_sips 
                    SET last_updated = ?
                    WHERE last_updated >= ?
                """, (yesterday, today))
                
                affected = cursor.rowcount
                conn.commit()
            
            if affected > 0:
                logger.info(f"‚úÖ –°–±—Ä–æ—à–µ–Ω–æ {affected} SIP (–Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Å–µ–≥–æ–¥–Ω—è)")
            else:
                logger.info("‚ÑπÔ∏è –í—Å–µ SIP —É–∂–µ –±—ã–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã —Ä–∞–Ω–µ–µ")
            
            return affected
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ SIP: {e}")
            return 0


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ë–î
db = Database()
=== ./services/google_sheets_service.py ===
"""–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
import os
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import pytz
from dotenv import load_dotenv
from oauth2client.service_account import ServiceAccountCredentials
import gspread
from gspread.exceptions import WorksheetNotFound, APIError

from utils.logger import logger
from config.settings import settings
from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type,
    before_sleep_log
)
import logging
from gspread.exceptions import APIError
import aiohttp

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retry –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
API_RETRY_CONFIG = {
    'stop': stop_after_attempt(3),                    # –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
    'wait': wait_exponential(min=2, max=10),          # 2—Å, 4—Å, 8—Å
    'retry': retry_if_exception_type((
        APIError,                                      # Google Sheets API –æ—à–∏–±–∫–∏
        aiohttp.ClientError,                          # –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
        TimeoutError                                   # –¢–∞–π–º–∞—É—Ç—ã
    )),
    'before_sleep': before_sleep_log(logger, logging.WARNING)  # –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
}

# –ó–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞
load_dotenv()


class GoogleSheetsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Google Sheets —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞"""
        self.client = None
        self.spreadsheet = None
        self.sheet_id = os.getenv("GOOGLE_SHEETS_ID")
        self.credentials_file = os.getenv("GOOGLE_CREDENTIALS_FILE", "google_credentials.json")
        self.timezone = pytz.timezone('Europe/Kiev')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è ID —Ç–∞–±–ª–∏—Ü—ã
        if not self.sheet_id:
            logger.error("‚ùå GOOGLE_SHEETS_ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")
            return
        
        # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        if not self._authorize():
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Google Sheets")
            return
        
        logger.info("‚úÖ Google Sheets —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def _authorize(self) -> bool:
        """
        –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Google Sheets
        
        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ credentials
            if not os.path.exists(self.credentials_file):
                logger.error(f"‚ùå –§–∞–π–ª {self.credentials_file} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
                return False
            
            scope = [
                'https://spreadsheets.google.com/feeds',
                'https://www.googleapis.com/auth/drive'
            ]
            
            creds = ServiceAccountCredentials.from_json_keyfile_name(
                self.credentials_file, scope
            )
            
            self.client = gspread.authorize(creds)
            
            # –û—Ç–∫—Ä—ã—Ç–∏–µ —Ç–∞–±–ª–∏—Ü—ã
            self.spreadsheet = self.client.open_by_key(self.sheet_id)
            
            logger.info(f"‚úÖ Google Sheets –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: {self.spreadsheet.title}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google Sheets: {e}")
            return False
    
    def _get_week_range(self, date: datetime) -> tuple:
        """
        –ü–æ–ª—É—á–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-—Å—É–±–±–æ—Ç–∞)
        
        Args:
            date: –î–∞—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏
            
        Returns:
            (–Ω–∞—á–∞–ª–æ_–Ω–µ–¥–µ–ª–∏, –∫–æ–Ω–µ—Ü_–Ω–µ–¥–µ–ª–∏)
        """
        # –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
        start = date - timedelta(days=date.weekday())
        # –°—É–±–±–æ—Ç–∞ (5 –¥–Ω–µ–π –æ—Ç –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞)
        end = start + timedelta(days=5)
        
        return start, end
    
    def _get_week_title(self, start: datetime, end: datetime) -> str:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –¥–ª—è –Ω–µ–¥–µ–ª–∏
        
        Args:
            start: –ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏
            end: –ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏
            
        Returns:
            –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–∞ "–ù–µ–¥–µ–ª—è 18-23 –ù–æ—è–±—Ä—è 2024"
        """
        months = {
            1: "–Ø–Ω–≤–∞—Ä—è", 2: "–§–µ–≤—Ä–∞–ª—è", 3: "–ú–∞—Ä—Ç–∞", 4: "–ê–ø—Ä–µ–ª—è",
            5: "–ú–∞—è", 6: "–ò—é–Ω—è", 7: "–ò—é–ª—è", 8: "–ê–≤–≥—É—Å—Ç–∞",
            9: "–°–µ–Ω—Ç—è–±—Ä—è", 10: "–û–∫—Ç—è–±—Ä—è", 11: "–ù–æ—è–±—Ä—è", 12: "–î–µ–∫–∞–±—Ä—è"
        }
        
        month_name = months[start.month]
        return f"–ù–µ–¥–µ–ª—è {start.day}-{end.day} {month_name} {start.year}"
    
    async def _create_weekly_sheet(self) -> Optional[object]:
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –Ω–µ–¥–µ–ª–∏ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        
        Returns:
            Worksheet –æ–±—ä–µ–∫—Ç –∏–ª–∏ None
        """
        if not self.client or not self.spreadsheet:
            return None
        
        try:
            now = datetime.now(self.timezone)
            start, end = self._get_week_range(now)
            title = self._get_week_title(start, end)
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ª–∏—Å—Ç–∞
            try:
                worksheet = self.spreadsheet.worksheet(title)
                logger.info(f"üìã –õ–∏—Å—Ç '{title}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                return worksheet
            except WorksheetNotFound:
                pass
            
            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ª–∏—Å—Ç–∞
            worksheet = self.spreadsheet.add_worksheet(
                title=title,
                rows=100,
                cols=17
            )
            
            logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ª–∏—Å—Ç: {title}")
            
            # ===== –ó–ê–ì–û–õ–û–í–ö–ò (—Ç–æ–ª—å–∫–æ —Ç—Ä—É–±–∫–∏) =====
            headers = [
                ["‚Ññ", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ü–ù\n—Ç—Ä—É–±", "–í–¢\n—Ç—Ä—É–±", "–°–†\n—Ç—Ä—É–±", "–ß–¢\n—Ç—Ä—É–±", "–ü–¢\n—Ç—Ä—É–±", "–°–ë\n—Ç—Ä—É–±", "–ò—Ç–æ–≥–æ\n—Ç—Ä—É–±–æ–∫"]
            ]
            
            worksheet.update('A1:I1', headers)
            
            # ===== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï =====
            
            # –ó–∞–≥–æ–ª–æ–≤–∫–∏: —Å–∏–Ω–∏–π —Ñ–æ–Ω, –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç, –∂–∏—Ä–Ω—ã–π, —Ü–µ–Ω—Ç—Ä
            worksheet.format('A1:I1', {
                "backgroundColor": {"red": 0.2, "green": 0.4, "blue": 0.8},
                "textFormat": {"foregroundColor": {"red": 1, "green": 1, "blue": 1}, "bold": True},
                "horizontalAlignment": "CENTER",
                "verticalAlignment": "MIDDLE"
            })
            
            # –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ –∏ –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            body = {
                "requests": [
                    # –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "COLUMNS", "startIndex": 0, "endIndex": 1}, "properties": {"pixelSize": 40}, "fields": "pixelSize"}},  # ‚Ññ
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "COLUMNS", "startIndex": 1, "endIndex": 2}, "properties": {"pixelSize": 120}, "fields": "pixelSize"}},  # –ú–µ–Ω–µ–¥–∂–µ—Ä
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "COLUMNS", "startIndex": 2, "endIndex": 9}, "properties": {"pixelSize": 70}, "fields": "pixelSize"}},  # –ü–ù-–°–ë + –ò—Ç–æ–≥–æ
                    
                    # –í—ã—Å–æ—Ç–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫)
                    {"updateDimensionProperties": {"range": {"sheetId": worksheet.id, "dimension": "ROWS", "startIndex": 0, "endIndex": 1}, "properties": {"pixelSize": 50}, "fields": "pixelSize"}},
                ]
            }
            self.spreadsheet.batch_update(body)
            
            # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —è—á–µ–µ–∫
            worksheet.format('A:I', {
                "horizontalAlignment": "CENTER",
                "verticalAlignment": "MIDDLE"
            })
            
            # –†–∞–º–∫–∏ –¥–ª—è –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã
            worksheet.format('A1:I100', {
                "borders": {
                    "top": {"style": "SOLID"},
                    "bottom": {"style": "SOLID"},
                    "left": {"style": "SOLID"},
                    "right": {"style": "SOLID"}
                }
            })
            
            logger.info(f"‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –ª–∏—Å—Ç—É '{title}'")
            return worksheet
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∞: {e}")
            return None
    
    @retry(**API_RETRY_CONFIG)
    async def _get_managers_stats(self, target_date: str) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –° –ê–í–¢–û–ü–û–í–¢–û–†–û–ú
        
        Args:
            target_date: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
            
        Returns:
            –°–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ (–≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
        """
        try:
            # ‚úÖ –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô –°–ü–ò–°–û–ö - –¢–û–õ–¨–ö–û –ü–ê–í–õ–û–ì–†–ê–î
            FIXED_MANAGERS = [
                "–ê–ª–ª–∞–¥–∏–Ω", "–ê–Ω—è", "–í–∞–Ω—è", "–í–æ–≤–∞", "–ì–∞–Ω–∂–∞", "–î–∏–∞–Ω–∞", 
                "–î–∏–¥–∏", "–î–∏–º–∞", "–î–æ–±—Ä—è–∫", "–î—Ä–æ–Ω", "–ï–≥–æ—Ä", "–ñ–µ–Ω—è",
                "–õ–µ—Ä–∞", "–õ–µ—Å—è", "–õ—ã—Å—ã–π", "–ú–∞—Ä–∏–∫", "–ú–∏—à–∞", "C–µ—Ä–≥–µ–π",
                "–¢—ë–º–∞", "–≠–ª—è", "–Ø—Ä–∏–∫"
            ]
            
            # ‚úÖ –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ú–Å–ù
            NAME_MAP = {
                '–ª–µ—Ä–∞': '–õ–µ—Ä–∞',
                '—ç–ª—è': '–≠–ª—è',
                '–¥–∏–∞–Ω–∞': '–î–∏–∞–Ω–∞',
                'c–µ—Ä–≥–µ–π': 'C–µ—Ä–≥–µ–π',
                '—Å–µ—Ä–≥–µ–π': 'C–µ—Ä–≥–µ–π',
                '–ª–µ—Å—è': '–õ–µ—Å—è',
                '–¥–∏–¥–∏': '–î–∏–¥–∏',
                '–¥–æ–±—Ä—è–∫': '–î–æ–±—Ä—è–∫',
                '–¥–∏–º–∞': '–î–∏–º–∞',
                '–µ–≥–æ—Ä': '–ï–≥–æ—Ä',
                '–∞–ª–ª–∞–¥–∏–Ω': '–ê–ª–ª–∞–¥–∏–Ω',
                '–≤–∞–Ω—è': '–í–∞–Ω—è',
                '–∞–Ω—è': '–ê–Ω—è',
                '–≥–∞–Ω–∂–∞': '–ì–∞–Ω–∂–∞',
                '–º–∞—Ä–∏–∫': '–ú–∞—Ä–∏–∫',
                '–¥—Ä–æ–Ω': '–î—Ä–æ–Ω',
                '–ª—ã—Å—ã–π': '–õ—ã—Å—ã–π',
                '–∂–µ–Ω—è': '–ñ–µ–Ω—è',
                '—è—Ä–∏–∫': '–Ø—Ä–∏–∫',
                '–º–∏—à–∞': '–ú–∏—à–∞',
                '—Ç—ë–º–∞': '–¢—ë–º–∞',
                '—Ç–µ–º–∞': '–¢—ë–º–∞',
                '–≤–æ–≤–∞': '–í–æ–≤–∞',
                '—Å–µ—Ä–µ–≥–∞': 'C–µ—Ä–≥–µ–π',
                '–∞–ª–∞–¥–¥–∏–Ω': '–ê–ª–ª–∞–¥–∏–Ω',
                '–º–∞—Ä–∫': '–ú–∞—Ä–∏–∫',
            }
            
            from services.managers_stats_service import managers_stats_service
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–±–æ—á–µ–π —Ç–∞–±–ª–∏—Ü—ã
            raw_data = await managers_stats_service._fetch_managers_data()
            
            logger.info(f"üì• –ü–æ–ª—É—á–µ–Ω–æ {len(raw_data)} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ä–∞–±–æ—á–µ–π —Ç–∞–±–ª–∏—Ü—ã")
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
            stats_by_manager = {}
            unmatched_names = set()
            
            for row in raw_data:
                manager = row.get("–º–µ–Ω–µ–¥–∂–µ—Ä", "").strip()
                color = row.get("—Ü–≤–µ—Ç", "").strip()
                
                if not manager or not color:
                    continue
                
                # ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                manager_lower = manager.lower()
                normalized_name = NAME_MAP.get(manager_lower)
                
                if not normalized_name:
                    normalized_name = manager
                    unmatched_names.add(manager)
                
                if normalized_name not in stats_by_manager:
                    stats_by_manager[normalized_name] = {
                        "–ñ–ï–õ–¢–´–ô": 0,
                        "–ó–ï–õ–ï–ù–´–ô": 0,
                        "–§–ò–û–õ–ï–¢–û–í–´–ô": 0
                    }
                
                if color in stats_by_manager[normalized_name]:
                    stats_by_manager[normalized_name][color] += 1
            
            if unmatched_names:
                logger.warning(f"‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {unmatched_names}")
            
            # ‚úÖ –í–ê–ñ–ù–û: –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –í –§–ò–ö–°–ò–†–û–í–ê–ù–ù–û–ú –ü–û–†–Ø–î–ö–ï (–∞–ª—Ñ–∞–≤–∏—Ç)
            managers_data = []
            
            for manager_name in FIXED_MANAGERS:
                if manager_name in stats_by_manager:
                    colors = stats_by_manager[manager_name]
                    tubes = sum(colors.values())
                    green = colors["–ó–ï–õ–ï–ù–´–ô"]
                    purple = colors["–§–ò–û–õ–ï–¢–û–í–´–ô"]
                    yellow = colors["–ñ–ï–õ–¢–´–ô"]
                    
                    logger.info(f"üìä {manager_name}: {tubes} —Ç—Ä—É–±–æ–∫ (üü©{green} üü™{purple} üü®{yellow})")
                else:
                    tubes = 0
                    green = 0
                    purple = 0
                    yellow = 0
                
                managers_data.append({
                    "name": manager_name,
                    "tubes": tubes,
                    "green": green,
                    "yellow": yellow,
                    "purple": purple
                })
            
            logger.info(f"‚úÖ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–ø–∏—Å–æ–∫: {len(managers_data)} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (–∞–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)")
            return managers_data
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}")
            raise  # ‚úÖ –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è retry
            import traceback
            logger.error(traceback.format_exc())
            
            FIXED_MANAGERS = [
                "–ê–ª–ª–∞–¥–∏–Ω", "–ê–Ω—è", "–í–∞–Ω—è", "–í–æ–≤–∞", "–ì–∞–Ω–∂–∞", "–î–∏–∞–Ω–∞", 
                "–î–∏–¥–∏", "–î–∏–º–∞", "–î–æ–±—Ä—è–∫", "–î—Ä–æ–Ω", "–ï–≥–æ—Ä", "–ñ–µ–Ω—è",
                "–õ–µ—Ä–∞", "–õ–µ—Å—è", "–õ—ã—Å—ã–π", "–ú–∞—Ä–∏–∫", "–ú–∏—à–∞", "C–µ—Ä–≥–µ–π",
                "–¢—ë–º–∞", "–≠–ª—è", "–Ø—Ä–∏–∫"
            ]
            
            return [
                {"name": name, "tubes": 0, "green": 0, "yellow": 0, "purple": 0}
                for name in FIXED_MANAGERS
            ]
    
    @retry(**API_RETRY_CONFIG)
    async def update_stats(self):
        """
        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ Google Sheets –° –ê–í–¢–û–ü–û–í–¢–û–†–û–ú
        –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å (8:00-19:00, –ü–ù-–°–ë)
        
        ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: Retry –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏/API
        """
        if not self.client or not self.spreadsheet:
            raise Exception("Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
        
        try:
            now = datetime.now(self.timezone)
            start, end = self._get_week_range(now)
            title = self._get_week_title(start, end)
            
            logger.info(f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞: {title}")
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞
            try:
                worksheet = self.spreadsheet.worksheet(title)
            except WorksheetNotFound:
                worksheet = await self._create_weekly_sheet()
                if not worksheet:
                    raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ª–∏—Å—Ç")
            
            # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
            current_date = now.strftime("%Y-%m-%d")
            managers_data = await self._get_managers_stats(current_date)
            
            if not managers_data:
                logger.warning("‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")
                return
        
            logger.info(f"üìã –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–∞–ª—Ñ–∞–≤–∏—Ç)")
            
            # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
            weekday = now.weekday()
            days_names = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ']
            
            logger.info(f"üìÖ –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {now.strftime('%d.%m.%Y %H:%M')}")
            logger.info(f"üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: {days_names[weekday]} (weekday={weekday})")
            
            if weekday > 5:
                logger.info("üìÖ –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
                return
            
            # –ö–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Ç—Ä—É–±–æ–∫
            tubes_col = 3 + weekday
            tubes_col_letter = chr(64 + tubes_col)
            
            col_names = ['–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë']
            logger.info(f"üìä –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: {tubes_col_letter} ({col_names[weekday]})")
            
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            rows_data = []
            
            for idx, manager in enumerate(managers_data, start=2):
                name = manager.get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
                tubes = manager.get('tubes', 0)
                
                rows_data.append({
                    'row': idx,
                    'name': name,
                    'tubes': tubes
                })
            
            # ===== –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ (BATCH UPDATE) =====
            
            updates = []
            
            # 1. –ù–æ–º–µ—Ä–∞ –∏ –∏–º–µ–Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
            names_range_values = []
            for idx, data in enumerate(rows_data, start=1):
                names_range_values.append([idx, data['name']])
            
            updates.append({
                'range': f'A2:B{len(rows_data)+1}',
                'values': names_range_values
            })
            
            # 2. –¢—Ä—É–±–∫–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
            tubes_values = [[data['tubes']] for data in rows_data]
            updates.append({
                'range': f'{tubes_col_letter}2:{tubes_col_letter}{len(rows_data)+1}',
                'values': tubes_values
            })
            
            logger.info(f"üìù –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–ª–æ–Ω–∫—É {tubes_col_letter}2:{tubes_col_letter}{len(rows_data)+1}")
            
            # 3. –§–æ—Ä–º—É–ª—ã –¥–ª—è "–ò—Ç–æ–≥–æ —Ç—Ä—É–±–æ–∫"
            formulas_total = [
                [f"=SUM(C{data['row']}:H{data['row']})"] 
                for data in rows_data
            ]
            updates.append({
                'range': f'I2:I{len(rows_data)+1}',
                'values': formulas_total
            })
            
            # 4. –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
            total_row = len(rows_data) + 2
            
            updates.append({
                'range': f'A{total_row}:B{total_row}',
                'values': [["", "–ò–¢–û–ì–û:"]]
            })
            
            for col in range(3, 9):
                col_letter = chr(64 + col)
                updates.append({
                    'range': f'{col_letter}{total_row}',
                    'values': [[f"=SUM({col_letter}2:{col_letter}{total_row-1})"]]
                })
            
            updates.append({
                'range': f'I{total_row}',
                'values': [[f"=SUM(I2:I{total_row-1})"]]
            })
            
            # 5. –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            time_row = total_row + 2
            current_time = now.strftime("%d.%m.%Y %H:%M")
            updates.append({
                'range': f'A{time_row}:I{time_row}',
                'values': [[f"üìä –û–±–Ω–æ–≤–ª–µ–Ω–æ: {current_time}", "", "", "", "", "", "", "", ""]]
            })
            
            # ===== –û–¢–ü–†–ê–í–ö–ê –í–°–ï–• –û–ë–ù–û–í–õ–ï–ù–ò–ô =====
            logger.info(f"üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ {len(updates)} –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ–¥–Ω–∏–º –±–∞—Ç—á–µ–º...")
            
            worksheet.batch_update(updates, value_input_option='USER_ENTERED')
            
            # ===== –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï =====
            
            worksheet.format(f'A{total_row}:I{total_row}', {
                "backgroundColor": {"red": 0.9, "green": 0.9, "blue": 0.9},
                "textFormat": {"bold": True},
                "horizontalAlignment": "CENTER"
            })
            
            worksheet.format(f'A{time_row}:I{time_row}', {
                "backgroundColor": {"red": 0.95, "green": 0.95, "blue": 0.95},
                "textFormat": {"italic": True, "fontSize": 9},
                "horizontalAlignment": "CENTER",
                "verticalAlignment": "MIDDLE"
            })
            
            merge_request = {
                "requests": [{
                    "mergeCells": {
                        "range": {
                            "sheetId": worksheet.id,
                            "startRowIndex": time_row - 1,
                            "endRowIndex": time_row,
                            "startColumnIndex": 0,
                            "endColumnIndex": 9
                        },
                        "mergeType": "MERGE_ALL"
                    }
                }]
            }
            self.spreadsheet.batch_update(merge_request)
            
            logger.info(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: {len(rows_data)} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            import traceback
            logger.error(traceback.format_exc())
            raise  # ‚úÖ –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è retry
    
    async def create_weekly_sheet_if_needed(self):
        """
        –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–∏—Å—Ç –¥–ª—è –Ω–µ–¥–µ–ª–∏ –µ—Å–ª–∏ –Ω–∞—Å—Ç—É–ø–∏–ª –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 00:01 –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        """
        if not self.client or not self.spreadsheet:
            logger.error("‚ùå Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        try:
            now = datetime.now(self.timezone)
            
            if now.weekday() != 0:
                logger.info("üìÖ –ù–µ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
                return
            
            await self._create_weekly_sheet()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –ª–∏—Å—Ç–∞: {e}")


# ‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
google_sheets_service = GoogleSheetsService()
=== ./services/__init__.py ===

=== ./services/analytics_service.py ===
"""
–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ—à–∏–±–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
"""
from datetime import datetime, timedelta
from typing import Dict, List, Tuple
from database.models import db
from utils.logger import logger


class AnalyticsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –æ—à–∏–±–∫–∞–º"""
    
    @staticmethod
    def _get_period_filter(period: str) -> Tuple[str, str, str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞"""
        if period == "today":
            date_filter = datetime.now().strftime("%Y-%m-%d")
            title = "–∑–∞ —Å–µ–≥–æ–¥–Ω—è"
            where_clause = "DATE(created_at) = ?"
        elif period == "week":
            date_filter = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
            title = "–∑–∞ –Ω–µ–¥–µ–ª—é"
            where_clause = "DATE(created_at) >= ?"
        else:  # month
            date_filter = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
            title = "–∑–∞ –º–µ—Å—è—Ü"
            where_clause = "DATE(created_at) >= ?"
        
        return where_clause, date_filter, title
    
    @staticmethod
    def get_dashboard_overview(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: –û–±—â–∏–π –æ–±–∑–æ—Ä (–ò–°–ü–†–ê–í–õ–ï–ù–û - —É–±—Ä–∞–ª–∏ "–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ")
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            where_clause, date_filter, title = AnalyticsService._get_period_filter(period)
            
            # –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            cursor.execute(
                f"SELECT COUNT(*) FROM error_reports WHERE {where_clause}",
                (date_filter,)
            )
            total = cursor.fetchone()[0]
            
            if total == 0:
                conn.close()
                return f"üìä <b>–î–ê–®–ë–û–†–î {title.upper()}</b>\n\nüì≠ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
            
            # –¢–æ–ª—å–∫–æ —Ä–µ—à—ë–Ω–Ω—ã–µ (–≤—Å–µ —Å support_action)
            cursor.execute(
                f"""
                SELECT COUNT(*)
                FROM error_reports 
                WHERE {where_clause} AND support_action IS NOT NULL
                """,
                (date_filter,)
            )
            resolved = cursor.fetchone()[0]
            
            # –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º
            cursor.execute(
                f"""
                SELECT telephony_code, COUNT(*) as cnt 
                FROM error_reports 
                WHERE {where_clause}
                GROUP BY telephony_code
                ORDER BY cnt DESC
                """,
                (date_filter,)
            )
            by_telephony = cursor.fetchall()
            
            # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–æ 30 –º–∏–Ω—É—Ç)
            cursor.execute(
                f"""
                SELECT AVG(response_time_seconds)
                FROM error_reports 
                WHERE {where_clause} 
                AND response_time_seconds IS NOT NULL 
                AND response_time_seconds <= 1800
                """,
                (date_filter,)
            )
            avg_time = cursor.fetchone()[0]
            
            conn.close()
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            result = f"üìä <b>–î–ê–®–ë–û–†–î {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            # –û–±—â–µ–µ
            resolved_pct = int((resolved / total) * 100) if total > 0 else 0
            
            result += f"üìà <b>–û–ë–©–ï–ï:</b>\n"
            result += f"‚Ä¢ –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: <b>{total}</b>\n"
            result += f"‚Ä¢ ‚úÖ –†–µ—à–µ–Ω–æ: {resolved} ({resolved_pct}%)\n\n"
            
            # –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞–º–∏
            if by_telephony:
                result += f"üìû <b>–ü–û –¢–ï–õ–ï–§–û–ù–ò–Ø–ú:</b>\n"
                for tel_code, count in by_telephony:
                    tel = db.get_telephony_by_code(tel_code)
                    tel_name = tel['name'] if tel else tel_code.upper()
                    percentage = int((count / total) * 100)
                    
                    # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                    filled = int(percentage / 10)
                    bar = "‚ñà" * filled + "‚ñë" * (10 - filled)
                    
                    result += f"‚Ä¢ {tel_name}: {bar} {count} ({percentage}%)\n"
                result += "\n"
            
            # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è
            if avg_time:
                minutes = int(avg_time // 60)
                seconds = int(avg_time % 60)
                result += f"‚è± <b>–°–†–ï–î–ù–ï–ï –í–†–ï–ú–Ø –û–¢–í–ï–¢–ê:</b>\n"
                result += f"‚Ä¢ {minutes}–º {seconds}—Å\n\n"
            
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"
    
    @staticmethod
    def get_dashboard_managers(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã (–ò–°–ü–†–ê–í–õ–ï–ù–û - –±–µ–∑ –º–µ–¥–∞–ª–µ–π, –≤—ã—Ä–æ–≤–Ω–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞)
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            where_clause, date_filter, title = AnalyticsService._get_period_filter(period)
            
            # –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
            cursor.execute(
                f"""
                SELECT username, user_id, COUNT(*) as cnt 
                FROM error_reports 
                WHERE {where_clause}
                GROUP BY user_id 
                ORDER BY cnt DESC
                """,
                (date_filter,)
            )
            managers = cursor.fetchall()
            
            # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
            cursor.execute(
                f"SELECT COUNT(*) FROM error_reports WHERE {where_clause}",
                (date_filter,)
            )
            total = cursor.fetchone()[0]
            
            conn.close()
            
            if not managers:
                return f"üë• <b>–í–°–ï –ú–ï–ù–ï–î–ñ–ï–†–´ {title.upper()}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
            
            result = f"üë• <b>–í–°–ï –ú–ï–ù–ï–î–ñ–ï–†–´ {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            # –¢–∞–±–ª–∏—Ü–∞ —Å –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
            result += "<pre>"
            result += "‚îå‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n"
            result += "‚îÇ # ‚îÇ     –ò–º—è      ‚îÇ–û—à–∏–±–æ–∫‚îÇ %  ‚îÇ\n"
            result += "‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n"
            
            for i, (username, user_id, count) in enumerate(managers, 1):
                name = username or f"ID{user_id}"
                # –û–±—Ä–µ–∑–∞–µ–º –∏–º—è –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ–µ
                if len(name) > 12:
                    name = name[:9] + "..."
                
                percentage = int((count / total) * 100) if total > 0 else 0
                
                # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
                result += f"‚îÇ{i:2} ‚îÇ {name:12} ‚îÇ {count:4} ‚îÇ{percentage:3}%‚îÇ\n"
            
            result += "‚îî‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
            result += "</pre>\n\n"
            
            result += f"–í—Å–µ–≥–æ: {len(managers)} –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ | {total} –æ—à–∏–±–æ–∫\n\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"
    
    @staticmethod
    def get_dashboard_support(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3: –í—Å–µ —Å–∞–ø–ø–æ—Ä—Ç—ã (–ò–°–ü–†–ê–í–õ–ï–ù–û - –±–µ–∑ –º–µ–¥–∞–ª–µ–π, –≤—Ä–µ–º—è –≤ –∫–æ–Ω—Ü–µ)
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            if period == "today":
                date_filter = datetime.now().strftime("%Y-%m-%d")
                title = "–∑–∞ —Å–µ–≥–æ–¥–Ω—è"
                where_clause = "DATE(resolved_at) = ?"
            elif period == "week":
                date_filter = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
                title = "–∑–∞ –Ω–µ–¥–µ–ª—é"
                where_clause = "DATE(resolved_at) >= ?"
            else:
                date_filter = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
                title = "–∑–∞ –º–µ—Å—è—Ü"
                where_clause = "DATE(resolved_at) >= ?"
            
            # –í—Å–µ —Å–∞–ø–ø–æ—Ä—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–æ 30 –º–∏–Ω—É—Ç)
            cursor.execute(
                f"""
                SELECT support_username, support_user_id, 
                       COUNT(*) as total,
                       AVG(CASE WHEN response_time_seconds <= 1800 THEN response_time_seconds END) as avg_time,
                       SUM(CASE WHEN support_action = 'fix' THEN 1 ELSE 0 END) as fixed,
                       SUM(CASE WHEN support_action = 'wait' THEN 1 ELSE 0 END) as wait,
                       SUM(CASE WHEN support_action = 'wrong' THEN 1 ELSE 0 END) as wrong,
                       SUM(CASE WHEN support_action = 'sim' THEN 1 ELSE 0 END) as sim
                FROM error_reports 
                WHERE {where_clause} AND support_username IS NOT NULL
                GROUP BY support_user_id 
                ORDER BY total DESC
                """,
                (date_filter,)
            )
            supports = cursor.fetchall()
            
            conn.close()
            
            if not supports:
                return f"üõ† <b>–í–°–ï –°–ê–ü–ü–û–†–¢–´ {title.upper()}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
            
            result = f"üõ† <b>–í–°–ï –°–ê–ü–ü–û–†–¢–´ {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            for i, (username, user_id, total, avg_time, fixed, wait, wrong, sim) in enumerate(supports, 1):
                name = username or f"ID{user_id}"
                
                result += f"{i}. <b>{name}</b> - {total}\n"
                
                # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º
                actions = []
                if fixed > 0:
                    actions.append(f"‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: {fixed}")
                if wait > 0:
                    actions.append(f"‚è± 2-3 –º–∏–Ω: {wait}")
                if wrong > 0:
                    actions.append(f"‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: {wrong}")
                if sim > 0:
                    actions.append(f"‚úÖ –°–∏–º –≤–æ—Ä–∫: {sim}")
                
                for action in actions:
                    result += f"   {action}\n"
                
                # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤ –∫–æ–Ω—Ü–µ
                if avg_time:
                    minutes = int(avg_time // 60)
                    seconds = int(avg_time % 60)
                    result += f"   ‚è± –°—Ä–µ–¥–Ω–µ–µ: {minutes}–º {seconds}—Å\n"
                
                result += "\n"
            
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 3 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∞–ø–ø–æ—Ä—Ç–∞: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"
    
    @staticmethod
    def get_dashboard_timing(period: str = "today") -> str:
        """
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4: –í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–û - —Ç–æ–ª—å–∫–æ –¥–æ 30 –º–∏–Ω—É—Ç)
        """
        try:
            conn = db._get_connection()
            cursor = conn.cursor()
            
            if period == "today":
                date_filter = datetime.now().strftime("%Y-%m-%d")
                title = "–∑–∞ —Å–µ–≥–æ–¥–Ω—è"
                where_clause = "DATE(resolved_at) = ?"
            elif period == "week":
                date_filter = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
                title = "–∑–∞ –Ω–µ–¥–µ–ª—é"
                where_clause = "DATE(resolved_at) >= ?"
            else:
                date_filter = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
                title = "–∑–∞ –º–µ—Å—è—Ü"
                where_clause = "DATE(resolved_at) >= ?"
            
            # –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–æ 30 –º–∏–Ω—É—Ç
            cursor.execute(
                f"""
                SELECT AVG(response_time_seconds), 
                       MIN(response_time_seconds),
                       MAX(response_time_seconds),
                       COUNT(*)
                FROM error_reports 
                WHERE {where_clause} 
                AND response_time_seconds IS NOT NULL
                AND response_time_seconds <= 1800
                """,
                (date_filter,)
            )
            stats = cursor.fetchone()
            
            # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            cursor.execute(
                f"""
                SELECT 
                    SUM(CASE WHEN response_time_seconds < 120 THEN 1 ELSE 0 END) as under_2min,
                    SUM(CASE WHEN response_time_seconds BETWEEN 120 AND 300 THEN 1 ELSE 0 END) as from_2_5,
                    SUM(CASE WHEN response_time_seconds BETWEEN 300 AND 600 THEN 1 ELSE 0 END) as from_5_10,
                    SUM(CASE WHEN response_time_seconds BETWEEN 600 AND 1800 THEN 1 ELSE 0 END) as from_10_30
                FROM error_reports 
                WHERE {where_clause} 
                AND response_time_seconds IS NOT NULL
                AND response_time_seconds <= 1800
                """,
                (date_filter,)
            )
            distribution = cursor.fetchone()
            
            conn.close()
            
            if not stats or stats[3] == 0:
                return f"‚è± <b>–í–†–ï–ú–Ø –†–ï–ê–ö–¶–ò–ò {title.upper()}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
            
            avg_time, min_time, max_time, count = stats
            under_2, from_2_5, from_5_10, from_10_30 = distribution
            
            def format_time(seconds):
                if not seconds:
                    return "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
                m = int(seconds // 60)
                s = int(seconds % 60)
                return f"{m}–º {s}—Å"
            
            result = f"‚è± <b>–í–†–ï–ú–Ø –†–ï–ê–ö–¶–ò–ò {title.upper()}</b>\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
            
            result += f"üìä <b>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ—à–∏–±–æ–∫:</b> {count}\n\n"
            
            result += f"üîπ –°—Ä–µ–¥–Ω–µ–µ: <b>{format_time(avg_time)}</b>\n"
            result += f"üü¢ –ë—ã—Å—Ç—Ä–µ–π—à–∏–π: {format_time(min_time)}\n"
            result += f"üî¥ –°–∞–º—ã–π –¥–æ–ª–≥–∏–π: {format_time(max_time)}\n\n"
            
            # –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            result += "üìà <b>–†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï:</b>\n\n"
            
            pct_under_2 = int((under_2 / count) * 100) if count > 0 else 0
            pct_2_5 = int((from_2_5 / count) * 100) if count > 0 else 0
            pct_5_10 = int((from_5_10 / count) * 100) if count > 0 else 0
            pct_10_30 = int((from_10_30 / count) * 100) if count > 0 else 0
            
            # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã
            def bar(percentage):
                filled = int(percentage / 10)
                return "‚ñà" * filled + "‚ñë" * (10 - filled)
            
            result += f"üü¢ –î–æ 2 –º–∏–Ω:\n"
            result += f"   {bar(pct_under_2)} {under_2} ({pct_under_2}%)\n\n"
            
            result += f"üü° 2-5 –º–∏–Ω:\n"
            result += f"   {bar(pct_2_5)} {from_2_5} ({pct_2_5}%)\n\n"
            
            result += f"üü† 5-10 –º–∏–Ω:\n"
            result += f"   {bar(pct_5_10)} {from_5_10} ({pct_5_10}%)\n\n"
            
            result += f"üî¥ 10-30 –º–∏–Ω:\n"
            result += f"   {bar(pct_10_30)} {from_10_30} ({pct_10_30}%)\n\n"
            
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
            result += "üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ 4 –∏–∑ 4"
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
analytics_service = AnalyticsService()
=== ./services/scheduler_service.py ===
"""
–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: services/scheduler_service.py
–° —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –∞–¥–º–∏–Ω—É –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
"""
import asyncio
from datetime import datetime
import pytz
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger
from telegram import Bot

from utils.logger import logger
from utils.notifications import notification_service
from config.settings import settings


class SchedulerService:
    """–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á"""
    
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
        self.scheduler = BackgroundScheduler(timezone=pytz.timezone('Europe/Kiev'))
        self.timezone = pytz.timezone('Europe/Kiev')
        self._jobs_added = False
        self._last_update_success = None
        self._update_count = 0
        self._error_count = 0
        self._consecutive_errors = 0  # ‚úÖ –ù–û–í–û–ï: –°—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥
        self._bot = None  # ‚úÖ –ù–û–í–û–ï: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    
    def set_bot(self, bot: Bot):
        """
        –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram –±–æ—Ç–∞
        """
        self._bot = bot
        logger.info("‚úÖ –ë–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
    
    def _run_async_task(self, coro):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ"""
        loop = None
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(coro)
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏: {e}")
            raise
        finally:
            if loop is not None:
                try:
                    loop.close()
                except Exception as e:
                    logger.error(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è event loop: {e}")
    
    def _update_stats_job(self):
        """–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –° –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø–ú–ò"""
        try:
            from services.google_sheets_service import google_sheets_service
            
            now = datetime.now(self.timezone)
            logger.info(f"‚è∞ –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é ({now.strftime('%H:%M')})")
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            if not google_sheets_service.client or not google_sheets_service.spreadsheet:
                logger.error("‚ùå Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
                self._error_count += 1
                self._consecutive_errors += 1
                
                # ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ 3 –æ—à–∏–±–∫–∏ –ø–æ–¥—Ä—è–¥
                if self._consecutive_errors >= 3 and self._bot:
                    self._send_critical_notification(
                        "Google Sheets –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω",
                        f"{self._consecutive_errors} –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏"
                    )
                return
            
            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å retry –≤–Ω—É—Ç—Ä–∏)
            self._run_async_task(google_sheets_service.update_stats())
            
            # ‚úÖ –£–°–ü–ï–• - –û–±–Ω—É–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
            if self._consecutive_errors >= 3:
                # –ë—ã–ª–æ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫, –Ω–æ —Ç–µ–ø–µ—Ä—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å - —É–≤–µ–¥–æ–º–ª—è–µ–º
                if self._bot:
                    self._send_recovery_notification("Google Sheets –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ")
            
            self._consecutive_errors = 0  # –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞
            self._last_update_success = now
            self._update_count += 1
            
            logger.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ (–≤—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {self._update_count})")
            
        except Exception as e:
            self._error_count += 1
            self._consecutive_errors += 1
            
            error_msg = str(e)
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {error_msg}")
            logger.error(f"‚ö†Ô∏è –û—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥: {self._consecutive_errors}, –≤—Å–µ–≥–æ: {self._error_count}")
            
            # ‚úÖ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ø–æ—Å–ª–µ 3 –æ—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥
            if self._consecutive_errors >= 3 and self._bot:
                additional_info = (
                    f"‚Ä¢ –í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {self._update_count}\n"
                    f"‚Ä¢ –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: {self._error_count}\n"
                    f"‚Ä¢ –û—à–∏–±–æ–∫ –ø–æ–¥—Ä—è–¥: {self._consecutive_errors}"
                )
                
                self._send_critical_notification(
                    "Google Sheets –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
                    error_msg,
                    additional_info
                )
            
            # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
            if self._consecutive_errors >= 5:
                logger.warning(f"‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: {self._consecutive_errors} –æ—à–∏–±–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥!")
    
    def _create_weekly_sheet_job(self):
        """–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ª–∏—Å—Ç–∞"""
        try:
            from services.google_sheets_service import google_sheets_service
            
            now = datetime.now(self.timezone)
            logger.info(f"‚è∞ –ó–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∞ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–∏ ({now.strftime('%Y-%m-%d %H:%M')})")
            
            if not google_sheets_service.client or not google_sheets_service.spreadsheet:
                logger.error("‚ùå Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")
                
                if self._bot:
                    self._send_critical_notification(
                        "–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–µ–¥–µ–ª–∏",
                        "Google Sheets —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
                    )
                return
            
            self._run_async_task(google_sheets_service.create_weekly_sheet_if_needed())
            
            logger.info("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞/—Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∞: {e}")
            
            if self._bot:
                self._send_critical_notification(
                    "–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–µ–¥–µ–ª–∏",
                    str(e)
                )
    
    def _reset_sips_job(self):
        """–ó–∞–¥–∞—á–∞ —Å–±—Ä–æ—Å–∞ SIP (–∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ 8:00)"""
        try:
            from database.models import db
            
            now = datetime.now(self.timezone)
            logger.info(f"‚è∞ –ó–∞–ø—É—Å–∫ —Å–±—Ä–æ—Å–∞ SIP ({now.strftime('%Y-%m-%d %H:%M')})")
            
            affected = db.reset_all_sips()
            
            if affected > 0:
                logger.info(f"‚úÖ –°–±—Ä–æ—à–µ–Ω–æ {affected} SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
            else:
                logger.info("‚ÑπÔ∏è SIP —É–∂–µ –±—ã–ª–∏ —Å–±—Ä–æ—à–µ–Ω—ã —Ä–∞–Ω–µ–µ")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–¥–∞—á–∏ —Å–±—Ä–æ—Å–∞ SIP: {e}")
            
            if self._bot:
                self._send_critical_notification(
                    "–°–±—Ä–æ—Å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤",
                    str(e)
                )
    
    def _send_critical_notification(
        self,
        error_type: str,
        error_msg: str,
        additional_info: str = None
    ):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É"""
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(
                notification_service.notify_critical_error(
                    bot=self._bot,
                    error_type=error_type,
                    details=error_msg,
                    additional_info=additional_info
                )
            )
            loop.close()
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: {e}")
    
    def _send_recovery_notification(self, service_name: str):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏"""
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(
                notification_service.notify_recovery(
                    bot=self._bot,
                    service_name=service_name
                )
            )
            loop.close()
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")
    
    def add_jobs(self):
        """–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
        if self._jobs_added:
            logger.warning("‚ö†Ô∏è –ó–∞–¥–∞—á–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫")
            return
        
        try:
            # ===== –ó–ê–î–ê–ß–ê 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ =====
            self.scheduler.add_job(
                func=self._update_stats_job,
                trigger=CronTrigger(
                    day_of_week='mon-sat',
                    hour='8-19',
                    minute=0,
                    timezone=self.timezone
                ),
                id='update_stats',
                name='–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ Google Sheets',
                replace_existing=True,
                max_instances=1
            )
            
            # ===== –ó–ê–î–ê–ß–ê 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ª–∏—Å—Ç–∞ =====
            self.scheduler.add_job(
                func=self._create_weekly_sheet_job,
                trigger=CronTrigger(
                    day_of_week='mon',
                    hour=0,
                    minute=1,
                    timezone=self.timezone
                ),
                id='create_weekly_sheet',
                name='–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–∏',
                replace_existing=True,
                max_instances=1
            )
            
            # ===== –ó–ê–î–ê–ß–ê 3: –°–±—Ä–æ—Å SIP =====
            self.scheduler.add_job(
                func=self._reset_sips_job,
                trigger=CronTrigger(
                    day_of_week='mon-sat',
                    hour=8,
                    minute=0,
                    timezone=self.timezone
                ),
                id='reset_sips',
                name='–°–±—Ä–æ—Å SIP –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤',
                replace_existing=True,
                max_instances=1
            )
            
            self._jobs_added = True
            logger.info("‚úÖ –ó–∞–¥–∞—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫")
            logger.info("‚úÖ –ó–∞–¥–∞—á–∞ —Å–±—Ä–æ—Å–∞ SIP –¥–æ–±–∞–≤–ª–µ–Ω–∞ (8:00, –ü–ù-–°–ë)")
        
            self._print_jobs_info()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á: {e}")
    
    def _print_jobs_info(self):
        """–í—ã–≤–µ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö"""
        jobs = self.scheduler.get_jobs()
        logger.info(f"üìã –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–¥–∞—á: {len(jobs)}")
        
        for job in jobs:
            try:
                if hasattr(job, 'next_run_time') and job.next_run_time:
                    next_run = job.next_run_time.strftime("%Y-%m-%d %H:%M:%S")
                    logger.info(f"  ‚è∞ {job.name}: {next_run}")
                else:
                    logger.info(f"  ‚è∞ {job.name}: (–≤—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ)")
            except Exception:
                logger.info(f"  ‚è∞ {job.name}: (–æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏)")
    
    def start(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
        try:
            if not self._jobs_added:
                self.add_jobs()
            
            if not self.scheduler.running:
                self.scheduler.start()
                logger.info("üöÄ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –∑–∞–ø—É—â–µ–Ω")
                logger.info("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å (8:00-19:00, –ü–ù-–°–ë)")
                logger.info("üìã –ù–æ–≤—ã–π –ª–∏—Å—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 00:01")
                logger.info("üîÑ SIP –±—É–¥—É—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ –≤ 8:00 (–ü–ù-–°–ë)")
                logger.info("üì® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∞–¥–º–∏–Ω–∞–º")
            else:
                logger.warning("‚ö†Ô∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: {e}")
    
    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
        try:
            if self.scheduler.running:
                self.scheduler.shutdown()
                logger.info("‚èπÔ∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            
                if self._update_count > 0:
                    logger.info(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:")
                    logger.info(f"  ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {self._update_count}")
                    logger.info(f"  ‚ùå –í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: {self._error_count}")
                    if self._last_update_success:
                        logger.info(f"  ‚è∞ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {self._last_update_success.strftime('%Y-%m-%d %H:%M')}")
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞: {e}")
    
    def run_update_now(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
        logger.info("üîÑ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
        self._update_stats_job()
    
    def get_stats(self) -> dict:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
        return {
            'running': self.scheduler.running,
            'update_count': self._update_count,
            'error_count': self._error_count,
            'consecutive_errors': self._consecutive_errors,
            'last_update': self._last_update_success.strftime('%Y-%m-%d %H:%M') if self._last_update_success else None,
            'jobs_count': len(self.scheduler.get_jobs()) if self.scheduler else 0
        }
    
    def get_next_run_time(self, job_id: str) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á–∏"""
        try:
            job = self.scheduler.get_job(job_id)
            if job and hasattr(job, 'next_run_time') and job.next_run_time:
                return job.next_run_time.strftime('%Y-%m-%d %H:%M:%S')
        except Exception:
            pass
        return None


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
scheduler_service = SchedulerService()
=== ./services/managers_stats_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ Google Sheets - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
"""
from datetime import datetime, timezone, timedelta
from typing import Dict, List
import aiohttp
from config.settings import settings
from utils.logger import logger


class ManagersStatsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ü–∞–≤–ª–æ–≥—Ä–∞–¥–∞"""
    
    async def get_managers_stats(self) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
        
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –≤ —Å—Ç–∏–ª–µ –¥–∞—à–±–æ—Ä–¥–∞
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            data = await self._fetch_managers_data()
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
            stats_by_manager = self._group_by_manager(data)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω–æ–≤–æ–º —Å—Ç–∏–ª–µ
            result = self._format_stats_dashboard(stats_by_manager)
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"
    
    async def _fetch_managers_data(self) -> List[Dict]:
        """–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ Google Sheets"""
        url = settings.GOOGLE_APPS_SCRIPT_URL
        
        if not url:
            raise ValueError("GOOGLE_APPS_SCRIPT_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä action=managers
        if '?' in url:
            url += '&action=managers'
        else:
            url += '?action=managers'
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as response:
                    if response.status != 200:
                        logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status}")
                        raise Exception(f"HTTP {response.status}")
                    
                    data = await response.json()
                    
                    if isinstance(data, dict) and 'error' in data:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–∫—Ä–∏–ø—Ç–∞: {data['error']}")
                        raise Exception(data['error'])
                    
                    logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(data)} –∑–∞–ø–∏—Å–µ–π –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤")
                    return data
                    
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {e}", exc_info=True)
            raise
    
    def _group_by_manager(self, data: List[Dict]) -> Dict[str, Dict[str, int]]:
        """–ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –∏ —Ü–≤–µ—Ç–∞–º"""
        stats = {}
        
        for row in data:
            manager = row.get("–º–µ–Ω–µ–¥–∂–µ—Ä", "").strip()
            color = row.get("—Ü–≤–µ—Ç", "").strip()
            
            if not manager or not color:
                continue
            
            if manager not in stats:
                stats[manager] = {
                    "–ñ–ï–õ–¢–´–ô": 0,
                    "–ó–ï–õ–ï–ù–´–ô": 0,
                    "–§–ò–û–õ–ï–¢–û–í–´–ô": 0
                }
            
            if color in stats[manager]:
                stats[manager][color] += 1
        
        return stats
    
    def _format_stats_dashboard(self, stats: Dict[str, Dict[str, int]]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Å—Ç–∏–ª–µ –¥–∞—à–±–æ—Ä–¥–∞ –æ—à–∏–±–æ–∫
        
        Args:
            stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
            
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        """
        kiev_tz = timezone(timedelta(hours=2))
        current_time = datetime.now(kiev_tz).strftime("%H:%M")
        
        COLOR_EMOJI = {
            "–ñ–ï–õ–¢–´–ô": "üü®",
            "–ó–ï–õ–ï–ù–´–ô": "üü©",
            "–§–ò–û–õ–ï–¢–û–í–´–ô": "üü™"
        }
        
        if not stats:
            return f"üë• <b>–ú–ï–ù–ï–î–ñ–ï–†–´ (–ü–ê–í–õ–û–ì–†–ê–î) –Ω–∞ {current_time}</b>\n\nüì≠ –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)
        sorted_managers = sorted(
            stats.items(),
            key=lambda x: sum(x[1].values()),
            reverse=True
        )
        
        # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ
        total_calls = sum(sum(colors.values()) for colors in stats.values())
        
        result = f"üë• <b>–ú–ï–ù–ï–î–ñ–ï–†–´ (–ü–ê–í–õ–û–ì–†–ê–î) –Ω–∞ {current_time}</b>\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        result += f"üìä <b>–û–ë–©–ï–ï:</b>\n"
        result += f"‚Ä¢ –í—Å–µ–≥–æ —Ç—Ä—É–±–æ–∫: <b>{total_calls}</b>\n"
        result += f"‚Ä¢ –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {len(stats)}\n\n"
        
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        for i, (manager, colors) in enumerate(sorted_managers, 1):
            total = sum(colors.values())
            
            if total == 0:
                continue
            
            green = colors["–ó–ï–õ–ï–ù–´–ô"]
            yellow = colors["–ñ–ï–õ–¢–´–ô"]
            purple = colors["–§–ò–û–õ–ï–¢–û–í–´–ô"]
            
            # –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            percentage = int((total / total_calls) * 100) if total_calls > 0 else 0
            
            # –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            filled = int(percentage / 10) if percentage <= 100 else 10
            bar = "‚ñà" * filled + "‚ñë" * (10 - filled)
            
            result += f"<b>{i}. {manager}</b> - {total} —Ç—Ä—É–±–æ–∫\n"
            result += f"{bar} {percentage}%\n"
            
            # –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ü–≤–µ—Ç–∞–º (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å)
            colors_line = []
            if green > 0:
                green_pct = int((green / total) * 100)
                colors_line.append(f"{COLOR_EMOJI['–ó–ï–õ–ï–ù–´–ô']} {green} ({green_pct}%)")
            if yellow > 0:
                yellow_pct = int((yellow / total) * 100)
                colors_line.append(f"{COLOR_EMOJI['–ñ–ï–õ–¢–´–ô']} {yellow} ({yellow_pct}%)")
            if purple > 0:
                purple_pct = int((purple / total) * 100)
                colors_line.append(f"{COLOR_EMOJI['–§–ò–û–õ–ï–¢–û–í–´–ô']} {purple} ({purple_pct}%)")
            
            if colors_line:
                result += "‚Ä¢ " + " | ".join(colors_line) + "\n"
            
            result += "\n"
        
        # –ò—Ç–æ–≥–∏ –ø–æ —Ü–≤–µ—Ç–∞–º
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n"
        
        total_green = sum(m["–ó–ï–õ–ï–ù–´–ô"] for m in stats.values())
        total_yellow = sum(m["–ñ–ï–õ–¢–´–ô"] for m in stats.values())
        total_purple = sum(m["–§–ò–û–õ–ï–¢–û–í–´–ô"] for m in stats.values())
        
        result += f"üé® <b>–ò–¢–û–ì–û –ü–û –¶–í–ï–¢–ê–ú:</b>\n"
        
        if total_green > 0:
            green_pct = int((total_green / total_calls) * 100)
            result += f"{COLOR_EMOJI['–ó–ï–õ–ï–ù–´–ô']} –ó–µ–ª—ë–Ω—ã–µ: {total_green} ({green_pct}%)\n"
        
        if total_yellow > 0:
            yellow_pct = int((total_yellow / total_calls) * 100)
            result += f"{COLOR_EMOJI['–ñ–ï–õ–¢–´–ô']} –ñ—ë–ª—Ç—ã–µ: {total_yellow} ({yellow_pct}%)\n"
        
        if total_purple > 0:
            purple_pct = int((total_purple / total_calls) * 100)
            result += f"{COLOR_EMOJI['–§–ò–û–õ–ï–¢–û–í–´–ô']} –§–∏–æ–ª–µ—Ç–æ–≤—ã–µ: {total_purple} ({purple_pct}%)\n"
        
        return result


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
managers_stats_service = ManagersStatsService()
=== ./services/management_service.py ===
"""
–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º (–º–µ–Ω–µ–¥–∂–µ—Ä—ã, —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏, —Ä–∞—Å—Å—ã–ª–∫–∞)
"""
from typing import List, Dict, Optional, Tuple
from telegram import Bot, error as telegram_error
from database.models import db
from config.settings import settings
from utils.logger import logger


class ManagementService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏, —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è–º–∏ –∏ —Ä–∞—Å—Å—ã–ª–æ–∫"""
    
    # ===== –ú–ï–ù–ï–î–ñ–ï–†–´ =====
    
    @staticmethod
    def add_manager(user_id: int, username: str = None, 
                   first_name: str = None, added_by: int = None) -> Tuple[bool, str]:
        """–î–æ–±–∞–≤–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ –∞–¥–º–∏–Ω/–ø—É–ª—å—Ç
        if user_id in settings.ADMINS:
            return False, "‚ùå –≠—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä! –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Å–¥–µ–ª–∞—Ç—å –Ω–µ–ª—å–∑—è."
        
        if user_id in settings.PULT:
            return False, "‚ùå –≠—Ç–æ –ø—É–ª—å—Ç! –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Å–¥–µ–ª–∞—Ç—å –Ω–µ–ª—å–∑—è."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω —É–∂–µ
        if db.is_manager(user_id):
            return False, "‚ö†Ô∏è –≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º."
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
        success = db.add_manager(user_id, username, first_name, added_by)
        
        if success:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –ø–∞–º—è—Ç–∏ (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
            if user_id not in settings.MANAGERS:
                settings.MANAGERS.append(user_id)
            return True, f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!\n\nID: {user_id}"
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞."
    
    @staticmethod
    def remove_manager(user_id: int) -> Tuple[bool, str]:
        """–£–¥–∞–ª—è–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞"""
        if not db.is_manager(user_id):
            return False, "‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º."
        
        success = db.remove_manager(user_id)
        
        if success:
            # –£–¥–∞–ª—è–µ–º –∏–∑ –ø–∞–º—è—Ç–∏
            if user_id in settings.MANAGERS:
                settings.MANAGERS.remove(user_id)
            return True, f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä —É–¥–∞–ª—ë–Ω!\n\nID: {user_id}"
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞."
    
    @staticmethod
    def get_managers_list() -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
        managers = db.get_all_managers()
        
        if not managers:
            return "üìã –°–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø—É—Å—Ç."
        
        text = f"üë• <b>–ú–µ–Ω–µ–¥–∂–µ—Ä—ã ({len(managers)}):</b>\n\n"
        
        for i, m in enumerate(managers, 1):
            username = f"@{m['username']}" if m['username'] else "–±–µ–∑ username"
            name = m['first_name'] or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
            text += f"{i}. <b>{name}</b> ({username})\n"
            text += f"   ID: <code>{m['user_id']}</code>\n\n"
        
        return text
    
    # ===== –¢–ï–õ–ï–§–û–ù–ò–ò =====
    
    @staticmethod
    def add_telephony(name: str, code: str, tel_type: str, 
                     group_id: int, created_by: int = None) -> Tuple[bool, str]:
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é"""
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        if not name or not code:
            return False, "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ–¥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!"
        
        if tel_type not in ['white', 'black']:
            return False, "‚ùå –¢–∏–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 'white' –∏–ª–∏ 'black'!"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ group_id –≤–∞–ª–∏–¥–Ω—ã–π
        if not str(group_id).startswith('-'):
            return False, "‚ùå ID –≥—Ä—É–ø–ø—ã –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å '-' (–Ω–∞–ø—Ä–∏–º–µ—Ä: -1001234567890)"
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
        success = db.add_telephony(name, code, tel_type, group_id, created_by)
        
        if success:
            type_emoji = "‚ö™Ô∏è" if tel_type == "white" else "‚ö´Ô∏è"
            type_name = "–ë–µ–ª–∞—è (—Å –∫–Ω–æ–ø–∫–∞–º–∏)" if tel_type == "white" else "–ß—ë—Ä–Ω–∞—è (–±–µ–∑ –∫–Ω–æ–ø–æ–∫)"
            
            return True, (
                f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!\n\n"
                f"üìû –ù–∞–∑–≤–∞–Ω–∏–µ: <b>{name}</b>\n"
                f"üîë –ö–æ–¥: <code>{code}</code>\n"
                f"{type_emoji} –¢–∏–ø: {type_name}\n"
                f"üí¨ –ì—Ä—É–ø–ø–∞: <code>{group_id}</code>"
            )
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞: —Ç–∞–∫–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è –∏–ª–∏ –∫–æ–¥ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    
    @staticmethod
    def remove_telephony(code: str) -> Tuple[bool, str]:
        """–£–¥–∞–ª—è–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é"""
        tel = db.get_telephony_by_code(code)
        
        if not tel:
            return False, f"‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω–∏—è —Å –∫–æ–¥–æ–º '{code}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
        
        success = db.remove_telephony(code)
        
        if success:
            return True, f"‚úÖ –¢–µ–ª–µ—Ñ–æ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞!\n\nüìû {tel['name']} ({code})"
        else:
            return False, "‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏."
    
    @staticmethod
    def get_telephonies_list() -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π"""
        telephonies = db.get_all_telephonies()
        
        if not telephonies:
            return "üìã –°–ø–∏—Å–æ–∫ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π –ø—É—Å—Ç."
        
        text = f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω–∏–∏ ({len(telephonies)}):</b>\n\n"
        
        for i, tel in enumerate(telephonies, 1):
            type_emoji = "‚ö™Ô∏è" if tel['type'] == "white" else "‚ö´Ô∏è"
            type_name = "–ë–µ–ª–∞—è" if tel['type'] == "white" else "–ß—ë—Ä–Ω–∞—è"
            
            text += f"{i}. {type_emoji} <b>{tel['name']}</b>\n"
            text += f"   –ö–æ–¥: <code>{tel['code']}</code>\n"
            text += f"   –¢–∏–ø: {type_name}\n"
            text += f"   –ì—Ä—É–ø–ø–∞: <code>{tel['group_id']}</code>\n\n"
        
        return text
    
    # ===== –†–ê–°–°–´–õ–ö–ê =====
    
    @staticmethod
    async def broadcast_message(bot: Bot, message, sent_by: int) -> Dict:
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É –≤—Å–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º"""
        managers = db.get_all_managers()
        
        stats = {
            "total": len(managers),
            "success": 0,
            "failed": 0,
            "failed_ids": []
        }
        
        for manager in managers:
            user_id = manager['user_id']
            
            try:
                # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É
                await message.copy(chat_id=user_id)
                stats["success"] += 1
                logger.info(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ user_id={user_id}")
                
            except telegram_error.TelegramError as e:
                stats["failed"] += 1
                stats["failed_ids"].append(user_id)
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É user_id={user_id}: {e}")
        
        logger.info(
            f"üìä –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {stats['success']}/{stats['total']} —É—Å–ø–µ—à–Ω–æ"
        )
        
        return stats


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
management_service = ManagementService()
=== ./services/telephony_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∏–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—à–∏–±–æ–∫
"""
from telegram import Update, error as telegram_error
from telegram.ext import ContextTypes

from config.settings import settings
from config.constants import TEL_CODES_REVERSE, MESSAGES
from keyboards.inline import get_support_keyboard
from database.models import db
from utils.logger import logger
from utils.state import is_tel_choice_expired, clear_tel_choice, get_tel_choice


class TelephonyService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∏–µ–π"""
    
    @staticmethod
    def get_group_id(tel_name: str) -> int:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –≥—Ä—É–ø–ø—ã –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
        Args:
            tel_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            
        Returns:
            ID –≥—Ä—É–ø–ø—ã –∏–ª–∏ None
        """
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î
        telephonies = db.get_all_telephonies()
        for tel in telephonies:
            if tel['name'] == tel_name:
                return tel['group_id']
        
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏–∑ settings
        telephony_groups = settings.get_telephony_groups()
        return telephony_groups.get(tel_name)
    
    @staticmethod
    def get_tel_name_from_code(tel_code: str) -> str:
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∫–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ
        
        Args:
            tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (bmw, zvon)
            
        Returns:
            –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏–ª–∏ "Unknown"
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î
        tel = db.get_telephony_by_code(tel_code)
        if tel:
            return tel['name']
        
        # –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ë–î, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–µ
        return TEL_CODES_REVERSE.get(tel_code, "Unknown")
    
    @staticmethod
    async def send_error_to_group(
        bot,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE,
        group_id: int,
        tel_code: str,
        username: str,
        error_text: str
    ) -> bool:
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É –≤ –≥—Ä—É–ø–ø—É —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            update: Update –æ–±—ä–µ–∫—Ç
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç
            group_id: ID –≥—Ä—É–ø–ø—ã
            tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            error_text: –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
            
        Returns:
            True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞
        """
        user_id = update.effective_user.id
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        msg = f"–û—Ç: {username}\n{error_text}"
        
        # –ö–Ω–æ–ø–∫–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏)
        keyboard = get_support_keyboard(user_id, tel_code)
        
        try:
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            sent_msg = await bot.send_message(
                chat_id=group_id,
                text=msg,
                reply_markup=keyboard
            )
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if update.message.photo:
                await bot.send_photo(
                    chat_id=group_id,
                    photo=update.message.photo[-1].file_id,
                    reply_to_message_id=sent_msg.message_id
                )
                logger.info(f"üì∏ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ç–æ –∫ –æ—à–∏–±–∫–µ")
            elif update.message.document:
                await bot.send_document(
                    chat_id=group_id,
                    document=update.message.document.file_id,
                    reply_to_message_id=sent_msg.message_id
                )
                logger.info(f"üìé –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç –∫ –æ—à–∏–±–∫–µ")
            
            # –õ–æ–≥–∏—Ä—É–µ–º –≤ –ë–î
            db.log_error_report(user_id, username, tel_code, error_text)
            
            logger.info(f"‚úÖ –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –≥—Ä—É–ø–ø—É {group_id} –æ—Ç user_id={user_id}")
            return True
            
        except telegram_error.TelegramError as e:
            logger.error(f"‚ùå Telegram error –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –≥—Ä—É–ø–ø—É {group_id}: {e}", exc_info=True)
            return False
        except Exception as e:
            logger.error(f"‚ùå Unexpected error –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—à–∏–±–∫–∏: {e}", exc_info=True)
            return False
    
    @staticmethod
    def validate_error_text(error_text: str, has_media: bool) -> tuple:
        """
        –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
        
        Args:
            error_text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            has_media: –ï—Å—Ç—å –ª–∏ –º–µ–¥–∏–∞ —Ñ–∞–π–ª—ã
            
        Returns:
            (is_valid: bool, error_message: str)
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
        if len(error_text) > 1000:
            return False, MESSAGES["error_too_long"].format(length=len(error_text))
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
        if len(error_text.strip()) == 0 and not has_media:
            return False, MESSAGES["error_empty"]
        
        return True, None
    
    @staticmethod
    def get_success_message(tel_code: str, tel_name: str) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        
        Args:
            tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            tel_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
            
        Returns:
            –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
        tel = db.get_telephony_by_code(tel_code)
        
        if tel:
            # –ò–∑ –ë–î
            if tel['type'] == 'black':
                return MESSAGES["error_sent_zvon"].format(tel=tel_name)
            else:
                return MESSAGES["error_sent_bmw"].format(tel=tel_name)
        else:
            # –°—Ç–∞—Ä—ã–µ
            if tel_code == "zvon":
                return MESSAGES["error_sent_zvon"].format(tel=tel_name)
            else:
                return MESSAGES["error_sent_bmw"].format(tel=tel_name)


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
telephony_service = TelephonyService()
=== ./services/user_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
"""
from config.settings import settings
from database.models import db
from utils.logger import logger


class UserService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∏—Ö –ø—Ä–∞–≤–∞–º–∏"""
    
    @staticmethod
    def has_access(user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            True –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ .env (–∞–¥–º–∏–Ω—ã, –ø—É–ª—å—Ç, —Å—Ç–∞—Ä—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã)
        if user_id in settings.MANAGERS:
            return True
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –ë–î (–Ω–æ–≤—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã)
        return db.is_manager(user_id)
    
    @staticmethod
    def is_admin(user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
        """
        return user_id in settings.ADMINS
    
    @staticmethod
    def is_pult(user_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–ª—å—Ç–æ–º
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—É–ª—å—Ç
        """
        return user_id in settings.PULT
    
    @staticmethod
    def log_access_denied(user_id: int):
        """
        –õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫—É –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –ø—Ä–∞–≤
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        logger.warning(f"‚ùå –û—Ç–∫–∞–∑ –≤ –¥–æ—Å—Ç—É–ø–µ –¥–ª—è user_id={user_id}")
    
    @staticmethod
    def log_user_start(user_id: int, username: str, role: str):
        """
        –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            username: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            role: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        logger.info(f"‚úÖ {role.capitalize()} {user_id} ({username}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
user_service = UserService()
=== ./services/stats_service.py ===
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏–∑ Google Sheets —á–µ—Ä–µ–∑ Apps Script
"""
from datetime import datetime, timezone, timedelta
from typing import Dict, List
import aiohttp
from config.settings import settings
from utils.logger import logger


class StatsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤ –∏–∑ Google Sheets"""
    
    async def get_perezvoni_stats(self) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–µ—Ä–µ–∑–≤–æ–Ω–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∏–∑ Google Sheets
        
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            data = await self._fetch_sheet_data()
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –≥–æ—Ä–æ–¥–∞–º
            stats_by_city = self._group_by_city(data)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result = self._format_stats(stats_by_city)
            
            return result
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}", exc_info=True)
            return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ Google Sheets"
    
    async def _fetch_sheet_data(self) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets —á–µ—Ä–µ–∑ Apps Script
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫
        """
        url = settings.GOOGLE_APPS_SCRIPT_URL
        
        if not url:
            logger.error("‚ùå GOOGLE_APPS_SCRIPT_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")
            raise ValueError("GOOGLE_APPS_SCRIPT_URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as response:
                    if response.status != 200:
                        logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status}")
                        raise Exception(f"HTTP {response.status}")
                    
                    data = await response.json()
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫—É –æ—Ç —Å–∫—Ä–∏–ø—Ç–∞
                    if isinstance(data, dict) and 'error' in data:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–∫—Ä–∏–ø—Ç–∞: {data['error']}")
                        raise Exception(data['error'])
                    
                    logger.info(f"‚úÖ –ü–æ–ª—É—á–µ–Ω–æ {len(data)} –∑–∞–ø–∏—Å–µ–π –∏–∑ Google Sheets")
                    return data
                    
        except aiohttp.ClientError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞: {e}", exc_info=True)
            raise
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}", exc_info=True)
            raise
    
    def _group_by_city(self, data: List[Dict]) -> Dict[str, Dict[str, int]]:
        """
        –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –≥–æ—Ä–æ–¥–∞–º –∏ —Ü–≤–µ—Ç–∞–º
        
        Args:
            data: –î–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å {–≥–æ—Ä–æ–¥: {—Ü–≤–µ—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}}
        """
        stats = {}
        
        for row in data:
            city = row.get("–≥–æ—Ä–æ–¥", "").strip()
            color = row.get("—Ü–≤–µ—Ç", "").strip()
            
            if not city or not color:
                continue
            
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
            if city not in stats:
                stats[city] = {
                    "–ñ–ï–õ–¢–´–ô": 0,
                    "–ó–ï–õ–ï–ù–´–ô": 0,
                    "–§–ò–û–õ–ï–¢–û–í–´–ô": 0
                }
            
            if color in stats[city]:
                stats[city][color] += 1
        
        return stats
    
    def _format_stats(self, stats: Dict[str, Dict[str, int]]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç
        
        Args:
            stats: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º
            
        Returns:
            –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
        """
        # –ö–∏–µ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è (UTC+2 –∑–∏–º–æ–π)
        kiev_tz = timezone(timedelta(hours=2))
        current_time = datetime.now(kiev_tz).strftime("%H:%M")
        
        # –≠–º–æ–¥–∑–∏ –¥–ª—è —Ü–≤–µ—Ç–æ–≤
        COLOR_EMOJI = {
            "–ñ–ï–õ–¢–´–ô": "üü®",
            "–ó–ï–õ–ï–ù–´–ô": "üü©",
            "–§–ò–û–õ–ï–¢–û–í–´–ô": "üü™"
        }
        
        # –ü–æ—Ä—è–¥–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
        city_order = ["–ü–∞–≤–ª–æ–≥—Ä–∞–¥", "–•–∞—Ä—å–∫–æ–≤", "–î–Ω–µ–ø—Ä"]
        
        result = f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä—É–±–æ–∫ –Ω–∞ {current_time}</b>\n"
        result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        
        for city in city_order:
            if city not in stats:
                continue
            
            city_stats = stats[city]
            total = sum(city_stats.values())
            
            if total == 0:
                continue
            
            green = city_stats["–ó–ï–õ–ï–ù–´–ô"]
            yellow = city_stats["–ñ–ï–õ–¢–´–ô"]
            purple = city_stats["–§–ò–û–õ–ï–¢–û–í–´–ô"]
            
            green_pct = int((green / total) * 100) if total > 0 else 0
            yellow_pct = int((yellow / total) * 100) if total > 0 else 0
            purple_pct = int((purple / total) * 100) if total > 0 else 0

            
            result += f"<b>{city}:</b> {total}\n"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç–∞ –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å (–±–æ–ª—å—à–µ 0)
            colors_to_show = []
            if green > 0:
                colors_to_show.append(f"{green}{COLOR_EMOJI['–ó–ï–õ–ï–ù–´–ô']}({green_pct}%)")
            if yellow > 0:
                colors_to_show.append(f"{yellow}{COLOR_EMOJI['–ñ–ï–õ–¢–´–ô']}({yellow_pct}%)")
            if purple > 0:
                colors_to_show.append(f"{purple}{COLOR_EMOJI['–§–ò–û–õ–ï–¢–û–í–´–ô']}({purple_pct}%)")
            
            result += " ".join(colors_to_show) + "\n"
            result += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        
        return result


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
stats_service = StatsService()
=== ./utils/notifications.py ===
"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
"""
from datetime import datetime
from typing import Optional
from telegram import Bot
from telegram.error import TelegramError

from config.settings import settings
from utils.logger import logger


class NotificationService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞–º"""
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ N –º–∏–Ω—É—Ç
    _last_notifications = {}
    _cooldown_minutes = 30
    
    @staticmethod
    async def notify_critical_error(
        bot: Bot,
        error_type: str,
        details: str,
        additional_info: Optional[str] = None
    ):
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            error_type: –¢–∏–ø –æ—à–∏–±–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "Google Sheets", "–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫")
            details: –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
            additional_info: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        """
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º
        notification_key = f"{error_type}:{details[:50]}"
        
        if NotificationService._is_recently_sent(notification_key):
            logger.debug(f"‚è≠ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (cooldown): {error_type}")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = NotificationService._format_critical_message(
            error_type, details, additional_info
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º
        success_count = 0
        for admin_id in settings.ADMINS:
            try:
                await bot.send_message(
                    chat_id=admin_id,
                    text=message,
                    parse_mode="HTML"
                )
                success_count += 1
                logger.info(f"‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {admin_id}")
            except TelegramError as e:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")
        
        if success_count > 0:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            NotificationService._last_notifications[notification_key] = datetime.now()
            logger.info(f"üì® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {success_count} –∞–¥–º–∏–Ω–∞–º")
    
    @staticmethod
    async def notify_warning(
        bot: Bot,
        warning_type: str,
        details: str
    ):
        """
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            warning_type: –¢–∏–ø –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
            details: –î–µ—Ç–∞–ª–∏
        """
        message = (
            f"‚ö†Ô∏è <b>–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï</b>\n\n"
            f"üìù {warning_type}\n"
            f"‚ÑπÔ∏è {details}\n\n"
            f"‚è∞ {datetime.now().strftime('%d.%m.%Y %H:%M')}"
        )
        
        for admin_id in settings.ADMINS:
            try:
                await bot.send_message(
                    chat_id=admin_id,
                    text=message,
                    parse_mode="HTML"
                )
            except TelegramError as e:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")
    
    @staticmethod
    async def notify_recovery(
        bot: Bot,
        service_name: str
    ):
        """
        –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
            service_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –∫–æ—Ç–æ—Ä—ã–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
        """
        message = (
            f"‚úÖ <b>–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï</b>\n\n"
            f"üìä {service_name}\n"
            f"‚úÖ –†–∞–±–æ—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫\n\n"
            f"‚è∞ {datetime.now().strftime('%d.%m.%Y %H:%M')}"
        )
        
        for admin_id in settings.ADMINS:
            try:
                await bot.send_message(
                    chat_id=admin_id,
                    text=message,
                    parse_mode="HTML"
                )
            except TelegramError:
                pass  # –ù–µ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è recovery —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    
    @staticmethod
    def _format_critical_message(
        error_type: str,
        details: str,
        additional_info: Optional[str]
    ) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É details
        if len(details) > 500:
            details = details[:497] + "..."
        
        message = (
            f"üö® <b>–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</b>\n\n"
            f"üìä <b>–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:</b> {error_type}\n"
            f"‚ùå <b>–û—à–∏–±–∫–∞:</b>\n<code>{details}</code>\n"
        )
        
        if additional_info:
            message += f"\n‚ÑπÔ∏è <b>–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>\n{additional_info}\n"
        
        message += f"\n‚è∞ <b>–í—Ä–µ–º—è:</b> {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}"
        
        return message
    
    @staticmethod
    def _is_recently_sent(notification_key: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±—ã–ª –ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ç–∞–∫–æ–π –∂–µ notification –Ω–µ–¥–∞–≤–Ω–æ"""
        if notification_key not in NotificationService._last_notifications:
            return False
        
        last_time = NotificationService._last_notifications[notification_key]
        minutes_passed = (datetime.now() - last_time).total_seconds() / 60
        
        return minutes_passed < NotificationService._cooldown_minutes
    
    @staticmethod
    def clear_cooldowns():
        """–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ cooldowns (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)"""
        NotificationService._last_notifications.clear()


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
notification_service = NotificationService()

=== ./utils/__init__.py ===

=== ./utils/logger.py ===
"""
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±–æ—Ç–∞
"""
import logging
import sys


def setup_logger(name: str = __name__, level: int = logging.INFO) -> logging.Logger:
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç logger —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    
    Args:
        name: –ò–º—è logger'–∞
        level: –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        
    Returns:
        –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π logger
    """
    logger = logging.getLogger(name)
    logger.setLevel(level)
    
    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å handlers, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    if logger.handlers:
        return logger
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    formatter = logging.Formatter(
        "%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        datefmt="%Y-%m-%d %H:%M:%S"
    )
    
    # Handler –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setLevel(level)
    console_handler.setFormatter(formatter)
    
    logger.addHandler(console_handler)
    
    return logger


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π logger –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
logger = setup_logger("bot", logging.INFO)

=== ./utils/state.py ===
"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
"""
from datetime import datetime, timedelta
from telegram.ext import ContextTypes
from config.constants import TEL_CHOICE_TIMEOUT


def is_tel_choice_expired(context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å—Ç—ë–∫ –ª–∏ timeout –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        True –µ—Å–ª–∏ –≤—ã–±–æ—Ä –∏—Å—Ç—ë–∫, False –µ—Å–ª–∏ –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω
    """
    chosen_at = context.user_data.get("tel_chosen_at")
    if not chosen_at:
        return True
    return datetime.now() - chosen_at > timedelta(minutes=TEL_CHOICE_TIMEOUT)


def clear_tel_choice(context: ContextTypes.DEFAULT_TYPE):
    """
    –û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤—ã–±–æ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    context.user_data.pop("chosen_tel", None)
    context.user_data.pop("chosen_tel_code", None)
    context.user_data.pop("tel_chosen_at", None)


def clear_all_states(context: ContextTypes.DEFAULT_TYPE):
    """
    –û—á–∏—â–∞–µ—Ç –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    clear_tel_choice(context)
    context.user_data.pop("support_mode", None)
    context.user_data.pop("role", None)


def get_user_role(context: ContextTypes.DEFAULT_TYPE) -> str:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ("manager" –∏–ª–∏ "admin")
    """
    return context.user_data.get("role", "manager")


def set_user_role(context: ContextTypes.DEFAULT_TYPE, role: str):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        role: –†–æ–ª—å ("manager" –∏–ª–∏ "admin")
    """
    context.user_data["role"] = role


def set_support_mode(context: ContextTypes.DEFAULT_TYPE, enabled: bool):
    """
    –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        enabled: True –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è, False –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è
    """
    if enabled:
        context.user_data["support_mode"] = True
    else:
        context.user_data.pop("support_mode", None)


def is_support_mode(context: ContextTypes.DEFAULT_TYPE) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        True –µ—Å–ª–∏ —Ä–µ–∂–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞–∫—Ç–∏–≤–µ–Ω
    """
    return context.user_data.get("support_mode", False)


def set_tel_choice(context: ContextTypes.DEFAULT_TYPE, tel_name: str, tel_code: str):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        tel_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (BMW, –ó–≤–æ–Ω–∞—Ä–∏)
        tel_code: –ö–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ (bmw, zvon)
    """
    context.user_data["chosen_tel"] = tel_name
    context.user_data["chosen_tel_code"] = tel_code
    context.user_data["tel_chosen_at"] = datetime.now()


def get_tel_choice(context: ContextTypes.DEFAULT_TYPE) -> tuple:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        –ö–æ—Ä—Ç–µ–∂ (tel_name, tel_code) –∏–ª–∏ (None, None)
    """
    tel = context.user_data.get("chosen_tel")
    tel_code = context.user_data.get("chosen_tel_code")
    return tel, tel_code

=== ./scripts/update_managers_info.py ===
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞—Ö —á–µ—Ä–µ–∑ Telegram API
–ü–æ–ª—É—á–∞–µ—Ç username –∏ first_name –¥–ª—è –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ –ë–î
"""
import asyncio
from telegram import Bot
from database.models import db
from config.settings import settings
from utils.logger import logger


async def update_managers_info():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞—Ö —á–µ—Ä–µ–∑ Telegram API"""
    
    logger.info("üîÑ –ù–∞—á–∞–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞—Ö...")
    
    bot = Bot(token=settings.BOT_TOKEN)
    
    managers = db.get_all_managers()
    logger.info(f"üìä –ù–∞–π–¥–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: {len(managers)}")
    
    updated = 0
    failed = 0
    
    for manager in managers:
        user_id = manager['user_id']
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —á–µ—Ä–µ–∑ API
            chat = await bot.get_chat(user_id)
            
            username = chat.username
            first_name = chat.first_name
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ë–î
            conn = db._get_connection()
            cursor = conn.cursor()
            cursor.execute(
                "UPDATE managers SET username = ?, first_name = ? WHERE user_id = ?",
                (username, first_name, user_id)
            )
            conn.commit()
            conn.close()
            
            updated += 1
            logger.info(f"‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω {user_id}: @{username} ({first_name})")
            
        except Exception as e:
            failed += 1
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å {user_id}: {e}")
    
    logger.info(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    logger.info(f"üìä –û–±–Ω–æ–≤–ª–µ–Ω–æ: {updated}, –û—à–∏–±–æ–∫: {failed}")


if __name__ == "__main__":
    asyncio.run(update_managers_info())

=== ./scripts/test_sheets.py ===
#!/usr/bin/env python3
import os
from dotenv import load_dotenv  # –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω–æ!
from oauth2client.service_account import ServiceAccountCredentials
import gspread

# –ó–∞–≥—Ä—É–∑–∫–∞ .env —Ñ–∞–π–ª–∞
load_dotenv()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
sheet_id = os.getenv("GOOGLE_SHEETS_ID")
creds_file = os.getenv("GOOGLE_CREDENTIALS_FILE", "google_credentials.json")

print("=" * 50)
print("GOOGLE_SHEETS_ID:", sheet_id)
print("–§–∞–π–ª credentials —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:", os.path.exists(creds_file))
print("=" * 50)

if not sheet_id:
    print("‚ùå GOOGLE_SHEETS_ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env!")
    exit(1)

try:
    scope = [
        'https://spreadsheets.google.com/feeds',
        'https://www.googleapis.com/auth/drive'
    ]
    
    creds = ServiceAccountCredentials.from_json_keyfile_name(
        creds_file, scope
    )
    
    client = gspread.authorize(creds)
    print("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞")
    
    # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Ç–∞–±–ª–∏—Ü—É
    spreadsheet = client.open_by_key(sheet_id)
    print(f"‚úÖ –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–π–¥–µ–Ω–∞: {spreadsheet.title}")
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å/–ø–æ–ª—É—á–∏—Ç—å –ª–∏—Å—Ç
    try:
        worksheet = spreadsheet.worksheet("–¢–µ—Å—Ç")
        print(f"‚úÖ –õ–∏—Å—Ç '–¢–µ—Å—Ç' –Ω–∞–π–¥–µ–Ω")
    except:
        worksheet = spreadsheet.add_worksheet(title="–¢–µ—Å—Ç", rows=10, cols=5)
        print(f"‚úÖ –õ–∏—Å—Ç '–¢–µ—Å—Ç' —Å–æ–∑–¥–∞–Ω")
    
    print("=" * 50)
    print("‚úÖ –í–°–Å –†–ê–ë–û–¢–ê–ï–¢!")
    
except Exception as e:
    print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    import traceback
    traceback.print_exc()
=== ./scripts/migrate_add_analytics_fields.py ===
#!/usr/bin/env python3
"""
–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
"""
import sqlite3
from utils.logger import logger


def migrate_analytics_fields():
    """–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É error_reports"""
    
    logger.info("üîÑ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...")
    
    conn = sqlite3.connect("bot_data.db")
    cursor = conn.cursor()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ –ø–æ–ª—è —É–∂–µ –µ—Å—Ç—å
    cursor.execute("PRAGMA table_info(error_reports)")
    existing_columns = [row[1] for row in cursor.fetchall()]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
    fields_to_add = {
        "support_username": "TEXT",
        "response_time_seconds": "INTEGER"
    }
    
    for field, field_type in fields_to_add.items():
        if field not in existing_columns:
            try:
                cursor.execute(f"ALTER TABLE error_reports ADD COLUMN {field} {field_type}")
                logger.info(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ: {field}")
            except sqlite3.OperationalError as e:
                if "duplicate column name" in str(e):
                    logger.info(f"‚è≠ –ü–æ–ª–µ {field} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
                else:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è {field}: {e}")
        else:
            logger.info(f"‚è≠ –ü–æ–ª–µ {field} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    
    conn.commit()
    conn.close()
    
    logger.info("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")


if __name__ == "__main__":
    migrate_analytics_fields()

=== ./scripts/migrate_telephonies.py ===
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π –≤ –ë–î
–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
"""
from database.models import db
from config.settings import settings
from utils.logger import logger


def migrate_telephonies():
    """–ú–∏–≥—Ä–∏—Ä—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏ –∏–∑ settings –≤ –ë–î"""
    
    logger.info("üîÑ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏–π...")
    
    # BMW - –±–µ–ª–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è (—Å –∫–Ω–æ–ø–∫–∞–º–∏)
    success = db.add_telephony(
        name="BMW",
        code="bmw",
        tel_type="white",
        group_id=settings.BMW_GROUP_ID,
        created_by=settings.ADMIN_ID
    )
    
    if success:
        logger.info("‚úÖ BMW –¥–æ–±–∞–≤–ª–µ–Ω–∞")
    else:
        logger.info("‚ö†Ô∏è BMW —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    
    # –ó–≤–æ–Ω–∞—Ä–∏ - —á—ë—Ä–Ω–∞—è —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è (–±–µ–∑ –∫–Ω–æ–ø–æ–∫)
    success = db.add_telephony(
        name="–ó–≤–æ–Ω–∞—Ä–∏",
        code="zvon",
        tel_type="black",
        group_id=settings.ZVONARI_GROUP_ID,
        created_by=settings.ADMIN_ID
    )
    
    if success:
        logger.info("‚úÖ –ó–≤–æ–Ω–∞—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã")
    else:
        logger.info("‚ö†Ô∏è –ó–≤–æ–Ω–∞—Ä–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç")
    
    logger.info("‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
    telephonies = db.get_all_telephonies()
    logger.info(f"ÔøΩÔøΩ –¢–µ–ª–µ—Ñ–æ–Ω–∏–π –≤ –ë–î: {len(telephonies)}")
    for tel in telephonies:
        logger.info(f"  - {tel['name']} ({tel['code']}) - {tel['type']}")


if __name__ == "__main__":
    migrate_telephonies()

=== ./scripts/migrate_managers.py ===
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ .env –≤ –ë–î
–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
"""
from database.models import db
from config.settings import settings
from utils.logger import logger


def migrate_managers():
    """–ú–∏–≥—Ä–∏—Ä—É–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ .env –≤ –ë–î"""
    
    logger.info("üîÑ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤...")
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ .env (–∏—Å–∫–ª—é—á–∞—è –∞–¥–º–∏–Ω–æ–≤ –∏ –ø—É–ª—å—Ç)
    managers_to_migrate = []
    
    for user_id in settings.MANAGERS:
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–æ–≤ –∏ –ø—É–ª—å—Ç
        if user_id in settings.ADMINS or user_id in settings.PULT:
            logger.info(f"‚è≠ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω–∞/–ø—É–ª—å—Ç: {user_id}")
            continue
        
        managers_to_migrate.append(user_id)
    
    logger.info(f"üìä –ù–∞–π–¥–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏: {len(managers_to_migrate)}")
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤ –ë–î
    migrated = 0
    skipped = 0
    
    for user_id in managers_to_migrate:
        success = db.add_manager(
            user_id=user_id,
            username=None,  # Username –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω –∏–∑ .env
            first_name=None,  # –ò–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ –∏–∑ .env
            added_by=settings.ADMIN_ID
        )
        
        if success:
            migrated += 1
            logger.info(f"‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ë–î")
        else:
            skipped += 1
            logger.info(f"‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä {user_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    
    logger.info(f"‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
    logger.info(f"üìä –î–æ–±–∞–≤–ª–µ–Ω–æ: {migrated}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped}")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫
    all_managers = db.get_all_managers()
    logger.info(f"üìã –í—Å–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ –ë–î: {len(all_managers)}")
    for m in all_managers:
        logger.info(f"  - ID: {m['user_id']}")


if __name__ == "__main__":
    migrate_managers()

=== ./update_sheets_now.py ===
#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Google Sheets
"""
import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ PYTHONPATH
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from services.google_sheets_service import GoogleSheetsService
from utils.logger import logger

async def main():
    try:
        logger.info("üîÑ –ó–∞–ø—É—Å–∫ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
        
        # –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞
        service = GoogleSheetsService()
        
        if not service.client or not service.spreadsheet:
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Google Sheets —Å–µ—Ä–≤–∏—Å")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞—ë–º –ª–∏—Å—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        logger.info("üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ª–∏—Å—Ç–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏...")
        await service._create_weekly_sheet()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        logger.info("üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...")
        await service.update_stats()
        
        logger.info("‚úÖ –ì–æ—Ç–æ–≤–æ!")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        logger.error(traceback.format_exc())

if __name__ == "__main__":
    asyncio.run(main())
